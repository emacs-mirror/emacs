                   MPS C INTERFACE SYMBOL "MPS_FIX2"
                         symbol.mps.c.MPS_FIX2
                              draft symbol
                            pekka 1998-01-19

NAME

MPS_FIX2


SUMMARY

The macro "MPS_FIX2", together with "MPS_FIX1", is the part of the scanning 
protocol used to indicate references to the MPS.  It may only be used from 
within MPS_SCAN_BEGIN and MPS_SCAN_END.


ASSOCIATED PROTOCOLS

Format.


SYNTAX

MPS_FIX2(mps_ss, ref_io);


ARGUMENTS

mps_ss    the scan state argument that was passed to the scanning function
ref_io    a pointer to a reference within the object being scanned, type 
mps_addr_t *


RETURNED VALUES

Returns a result code, see ERROR HANDLING.

If the reference rank of the object being scanned is not "MPS_RANK_AMBIG" then 
the reference pointed to by "ref_io" may be modified by "mps_fix".


RESOURCES

mps.h.


DESCRIPTION

MPS_FIX1 and MPS_FIX2 are a trick to speed up scanning by splitting MPS_FIX 
into two macros.  MPS_FIX1 is a fast test to see if the reference is likely to 
be interesting to the MPS; if it returns false, the scanner can proceed to the 
next reference.  If it returns true, the scan method [can apply further, slower 
tests to it, before deciding to] must invoke MPS_FIX2, which does the actual 
fixing.

This macro may only be used in code textually between MPS_SCAN_BEGIN and 
MPS_SCAN_END.

This macro does not perform any particular operation.  The MPS may call 
scanning functions for a number of reasons, and "MPS_FIX2" may take different 
actions depending on those reasons.


EXAMPLE

mps_res_t scan_array(mps_ss_t ss, Array object, size_t length)
{
  size_t i;
  mps_res_t res;
  mps_addr_t *array = (mps_addr_t *)object;

  MPS_SCAN_BEGIN(ss)
    for(i = 0; i < length; ++i) {
      mps_addr_t ref = array[i];

      if(MPS_FIX1(ss, ref)) {
        /* if(((Object*)ref)->type == ScannableType) { */
        /* You can do something here, but in the end, you must call MPS_FIX2. */
          res = MPS_FIX2(ss, &array[i]);
          if(res != MPS_RES_OK) return res;
        /* } */
      }
    }
  MPS_SCAN_END(ss);

  return res;
}


ERROR HANDLING

The macro returns "MPS_RES_OK" if it was successful, in which case the scanning 
function should continue to scan the rest of the object, fixing the remaining 
references.  If "MPS_FIX2" returns a value other than "MPS_RES_OK", the 
scanning function must return that value, and may return without scanning 
further references.  Generally, it is better if it returns as soon as possible.


SEE ALSO

MPS_FIX, MPS_FIX1, mps_fix, mps_ss_t, mps_root_scan_t, mps_fmt_scan_t, 
mps_reg_scan_t, MPS_SCAN_BEGIN, MPS_SCAN_END, MPS_FIX_CALL


INTERNAL NOTES

We're working on making this useful again.  Pekka 1998-02-03

See also mps_fix.


