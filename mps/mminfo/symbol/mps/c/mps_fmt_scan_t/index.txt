                MPS C INTERFACE SYMBOL "MPS_FMT_SCAN_T"
                      symbol.mps.c.mps_fmt_scan_t
                              draft symbol
                            pekka 1998-01-26

NAME

mps_fmt_scan_t


SUMMARY

Type of scanning functions for the scan method of a format.  The method scans a 
block of objects.


ASSOCIATED PROTOCOLS

Format, Root.


SYNTAX

typedef mps_res_t (*mps_fmt_scan_t)(mps_ss_t scan_state,
                                    mps_addr_t base, mps_addr_t limit)


ARGUMENTS

scan_state  a scan state
base        the address of the start of the block of objects
limit       the address just beyond the end of the block


RETURNED VALUES

A result code.


RESOURCES

mps.h


DESCRIPTION

This is the type of scanning functions provided in some format variants (see 
"mps_fmt_create_A") and "mps_root_create_fmt".  When the MPS needs to scan 
objects in an area of memory that this scanning function has been registered 
for, it will be called with a scan state and the limits of the block of objects 
to scan.  It must then indicate references within the objects by using mps_fix 
or one of the alternatives.


EXAMPLE

/* Scanner for a simple Scheme-like language with just two interesting types */
mps_res_t scan_objs(mps_ss_t ss, mps_addr_t base, mps_addr_t limit)
{
  mps_res_t res;
  mps_addr_t obj;

  MPS_SCAN_BEGIN(ss)
    for(obj = base; obj < limit;) { /* obj maps over the objects to scan */
      switch(((Object*)obj)->type) {
        ArrayType: {
          size_t i;
          Array *array = (Array *)obj;

          for(i = 0; i < array->length; ++i) { /* fix each element */
            res = MPS_FIX(ss, &array->contents[i]);
            if(res != MPS_RES_OK) return res;
          }
          obj = AddrAdd(obj, ArraySize(array)); /* move to next object */
          break;
        }
        StackFrameType: {
          StackFrame *frame = (StackFrame *)obj;

          for(i = frame->size; i > 0; --i) { /* fix each local var */
            res = MPS_FIX(ss, &frame->locals[i]);
            if(res != MPS_RES_OK) return res;
          }
          res = MPS_FIX(ss, &frame->next);
          if(res != MPS_RES_OK) return res;
          obj = AddrAdd(obj, StackFrameSize(frame));
          break;
        }
        default: /* other types don't contain references */
          obj = AddrAdd(obj, DefaultSize(obj));
          break;
      }
    }
  MPS_SCAN_END(ss);

  return res;
}


ERROR HANDLING

The scanning function returns "MPS_RES_OK" if it was successful, otherwise the 
return code of the fix operation that failed.


SEE ALSO

mps_fmt_create_A, mps_root_create_fmt, mps_fix, MPS_FIX, MPS_SCAN_BEGIN, 
MPS_SCAN_END


NOTES



INTERNAL NOTES

See mps_fix.


