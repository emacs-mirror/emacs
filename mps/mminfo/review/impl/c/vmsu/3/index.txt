                    REVIEW RECORD FOR IMPL.C.VMSU(3)
                          review.impl.c.vmsu.3
                              draft review
                             drj 1995-10-06

Candidate: impl.c.vmsu(3)
Rules: rule.universal, guide.impl.c.*
Author: richard
Leader: richard
Lines: 206
Status: draft
Entry: ?
Exit: ?
Checkers: richard, dsm (tired and emotional), drj (perfectly sane, thanks)
Kickoff time: 1995-10-06 12:45

Rate: 10 lines/min

Logging start: 16:59  finish: 17:21  majors: 9  minors: 14  questions: 2  
suggestions: 1  new: 2

1. drj, 1, M, conflation of Addr and size_t in various places.
2. drj, 87, s, Could read-protect the VMStruct once it's created.
3. drj, 87, M, What if we get the last page in memory and limit == 0?
4. dsm, 24, m, We should list the exact system dependencies somewhere like 
os.su, including assumptions.
5. dsm, 75, m, Could check that fd is non-negative, rather than just not -1.
6. dsm, 179, m, Do we want PROT_EXEC?
7. dsm, 144, q, Does munmap really work on things which aren't mapped?  (Yes.)
8. dsm, 1, M, I had to think hard to work out all the mapping reasoning.  
Document it.  Why does Unmap call mmap?
9. richard, 1, M, Source documents not listed.
10. richard, 12, m, Should mention that no backing store is reserved by mmap of 
/dev/zero.
11. richard, 50, m, Make an issue about sharing the zero_fd in some way between 
VMs in case we have more than one.
12. richard, 59, m, Check conformance of Addr with this type before casting.  
Is it an int?
13. richard, 60, Nm, Depending on page size is power of two.
14. richard, 90+, m, Automatic variable intialization.
15. richard, 100, q, Is ErrIO really the right error in this case?
16. richard, 107, M, Need to be more careful about codes returned by mmap.  
Document assumptions.
17. richard, 112, m, Uncast literal zero.
18. richard, 87, M, Close /dev/zero on the error path.
19. richard, 131, NM, Close /dev/zero on destroy.
20. drj, 164, S, Could open /dev/zero for each mapping.  What are the costs of 
this?  Cheaper than keeping a file handle?
21. richard, 138, m, Invalidating the signature is NOT useless.  Explain.
22. richard, 145, m, Document assumptions of success.
23. richard, 181, m, Uncast literal zero.
24. richard, 182, M, Should check errno here, and document assumptions about it.
25. richard, 204, m, Uncast literal zero.
26. richard, 205, M, Should document assumptions of success here.

Brainstorm

drj: We shouldn't do code review just before lunch -- I got bored and hungry 
(and tired).

Edit

1. Actually int, not size_t.  Casts and checks inserted.
2. Ignored.
3. Inserted assumption documentation.
4. Made issue.doc-os-deps.
5. Done.
6. Added.
7. Checked man page.  Yes, it does.
8. Documented.
9. Done.
10. This was wrong anyway.
11. Made issue.share-zero-vm.
12. Yes.
13. Assertion added.
14. Changed, but left in special cases of #ifdef'd grain decls.
15. No.  ErrFAILURE added.  See impl.h.vm.
16. Documented as impl.c.vmsu.assume.mmap.err.
17. Casts inserted.
18. Done.
19. Done.
20. Dunno.  Added to issue.share-zero-vm.
21. Done.
22. Forgotten what I meant.  Tsk.
23. Cast.
24. Done.
25. Cast.
26. Forgotten what I meant.  Tsk.

