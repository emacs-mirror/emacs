# .github/workflows/rst-check.yml -- check syntax of reStructuredText files
#
# This is a GitHub CI workflow
# <https://docs.github.com/en/actions/using-workflows/about-workflows>
# to check the syntax of reStructuredText files.
#
# TODO: The scripts in this file might be better off in an auxillary
# file that can be also be run from the prompt.  Possibly in the
# top-level Makefile.

name: rst-check

on:
  # Run as part of CI checks on branch push and on merged pull request.
  - push
  - pull_request

jobs:
  rst-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install docutils
        run: sudo apt-get install -y docutils
      - name: Check reStructuredText syntax in .rst files
        if: always()
        run: find . -path ./manual/source -prune -o -type f -name '*.rst' -print | ( code=0; while read f; do if ! rst2html --report=2 --exit-status=2 "$f" > /dev/null; then code=1; fi done; exit "$code" )
      - name: Check reStructedText syntax in .txt files
        if: always()
        run: find . -path ./manual/source -prune -o -type f -name '*.txt' -print | ( code=0; while read f; do if head -1 -- "$f" | fgrep -q -e '-*- rst -*-'; then if ! rst2html --report=2 --exit-status=2 "$f" > /dev/null; then code=1; fi; fi; done; exit "$code" )
