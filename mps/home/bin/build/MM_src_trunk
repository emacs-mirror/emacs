#!/bin/sh
#
# Build and test MM at tip of main trunk (the MM_src compound)
# 
# $HopeName: HOMEmm!bin:build:MM_src_trunk(trunk.6) $
#

script="`basename $0`"

msg () {
  echo "$script: $*" 1>&2
}

die () {
  msg "$@"
  exit 1
}

test -d $HOME/Builds || mkdir $HOME/Builds ||
  die "Unable to create Builds directory."

cd $HOME/Builds &&
rm -rf mm &&
hope co -compound MM -branch . -recursive \
  -writable-files abort -missing-dir create -extra-files skip ||
  die "Unable to check out MM from Hope"

cd mm/src &&

# # commented out but not deleted for pedagogical reasons
# # (you might one day want to build a library)
for lib in mps.a
do
  gnumake -r -f suspgc.gmk $lib ||
    die "Unable to build library $lib of trunk"
done

for test in amcss dwstress lockcov locv mpmss mpsicv poolncv qs mpmconft
do
  gnumake -r -f suspgc.gmk $test &&
  for variety in df dp ds ro
  do
    ./suspgc/$variety/$test ||
      die "Unable to build and run test $test of trunk"
  done
done
