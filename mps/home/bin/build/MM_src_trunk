#!/bin/sh
#
# Build and test MM at tip of main trunk (the MM_src compound)
# 
# $HopeName: HOMEmm!bin:build:MM_src_trunk(trunk.17) $
#

script="`basename $0`"

msg () {
  echo "$script: $*" 1>&2
}

die () {
  msg "$@"
  exit 1
}

test -d $HOME/Builds || mkdir $HOME/Builds ||
  die "Unable to create Builds directory"

cd $HOME/Builds &&
rm -rf MM_src_trunk &&
mkdir MM_src_trunk &&
cd MM_src_trunk ||
  die "Unable to get to Builds/MM_src_trunk directory"

hope co -compound MMsrc -branch . -recursive \
  -writable-files quit -missing-dir create -extra-files skip ||
  die "Unable to check out MMsrc(trunk) from Hope"

cd src &&

for lib in mps.a mmsw.a
do
  gnumake -r -f sus8gc.gmk $lib ||
    die "Unable to build library $lib of trunk"
done &&

for test in amcss lockcov locv mpmss mpsicv poolncv \
            qs mpmconft finalcv arenacv awlut
            ## Don't run amsss, because it doesn't work
            ## Don't run dwstress, because it's not a good test
do
  gnumake -r -f sus8gc.gmk $test ||
    die "Unable to build test $test of trunk"
  for variety in hi ci ti
  do
    ./sus8gc/$variety/$test ||
      die "Failed test $variety/$test of trunk"
    rm mpsio.log
  done
done
