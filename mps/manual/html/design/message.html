

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>17. Client message protocol &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Old design" href="old.html" />
    <link rel="next" title="18. GC messages" href="message-gc.html" />
    <link rel="prev" title="16. MPS Configuration" href="locus.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="message-gc.html" title="18. GC messages"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="locus.html" title="16. MPS Configuration"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" accesskey="U">Old design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <span class="target" id="design-message"></span><div class="section" id="client-message-protocol">
<span id="index-0"></span><h1>17. Client message protocol<a class="headerlink" href="#client-message-protocol" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.message"></span><h2>17.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.message.intro"></span><a class="mpstag reference internal" href="#design.mps.message.intro">.intro:</a> The client message protocol provides a means by which
clients can receive messages from the MPS asynchronously. Typical
messages may be low memory notification (or in general low utility),
finalization notification, soft-failure notification. There is a
general assumption that it should not be disastrous for the MPS client
to ignore messages, but that it is probably in the clients best
interest to not ignore messages. The justification for this is that
the MPS cannot force the MPS client to read and act on messages, so no
message should be critical.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">Bogus, since we cannot force clients to check error codes either.
Pekka P. Pirinen, 1997-09-17.</p>
</div>
<p><span class="target" id="design.mps.message.contents"></span><a class="mpstag reference internal" href="#design.mps.message.contents">.contents:</a> This document describes the design of the external and
internal interfaces and concludes with a sketch of an example design
of an internal client. The example is that of implementing
finalization using PoolMRG.</p>
<p><span class="target" id="design.mps.message.readership"></span><a class="mpstag reference internal" href="#design.mps.message.readership">.readership:</a> Any MPS developer.</p>
</div>
<div class="section" id="requirements">
<h2>17.2. Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.message.req"></span><a class="mpstag reference internal" href="#design.mps.message.req">.req:</a> The client message protocol will be used for implementing
finalization (see design.mps.finalize and req.dylan.fun.final). It
will also be used for implementing the notification of various
conditions (possibly req.dylan.prot.consult is relevant here).</p>
</div>
<div class="section" id="external-interface">
<h2>17.3. External interface<a class="headerlink" href="#external-interface" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.message.if.queue"></span><a class="mpstag reference internal" href="#design.mps.message.if.queue">.if.queue:</a> Messages are presented as a single queue per arena.
Various functions are provided to inspect the queue and inspect
messages in it (see below).</p>
<div class="section" id="functions">
<h3>17.3.1. Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.message.if.fun"></span><a class="mpstag reference internal" href="#design.mps.message.if.fun">.if.fun:</a> The following functions are provided:</p>
<p><span class="target" id="design.mps.message.if.fun.poll"></span><a class="mpstag reference internal" href="#design.mps.message.if.fun.poll">.if.fun.poll:</a> <a class="reference internal" href="../topic/message.html#mps_message_poll" title="mps_message_poll"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_poll()</span></tt></a> sees whether there are any
messages pending. Returns 1 only if there is a message on the queue of
arena. Returns 0 otherwise.</p>
<p><span class="target" id="design.mps.message.if.fun.enable"></span><a class="mpstag reference internal" href="#design.mps.message.if.fun.enable">.if.fun.enable:</a> <a class="reference internal" href="../topic/message.html#mps_message_type_enable" title="mps_message_type_enable"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_type_enable()</span></tt></a> enables the flow of
messages of a certain type. The queue of messages of a arena will
contain only messages whose types have been enabled. Initially all
message types are disabled. Effectively this function allows the
client to declare to the MPS what message types the client
understands. The MPS does not generate any messages of a type that
hasn&#8217;t been enabled. This allows the MPS to add new message types (in
subsequent releases of a memory manager) without confusing the client.
The client will only be receiving the messages if they have explicitly
enabled them (and the client presumably only enables message types
when they have written the code to handle them).</p>
<p><span class="target" id="design.mps.message.if.fun.disable"></span><a class="mpstag reference internal" href="#design.mps.message.if.fun.disable">.if.fun.disable:</a> <a class="reference internal" href="../topic/message.html#mps_message_type_disable" title="mps_message_type_disable"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_type_disable()</span></tt></a> disables the flow
of messages of a certain type. The antidote to
<a class="reference internal" href="../topic/message.html#mps_message_type_enable" title="mps_message_type_enable"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_type_enable()</span></tt></a>. Disables the specified message type.
Flushes any existing messages of that type on the queue, and stops any
further generation of messages of that type. This permits clients to
dynamically decline interest in a message type, which may help to
avoid a memory leak or bloated queue when the messages are only
required temporarily.</p>
<p><span class="target" id="design.mps.message.if.fun.get"></span><a class="mpstag reference internal" href="#design.mps.message.if.fun.get">.if.fun.get:</a> <a class="reference internal" href="../topic/message.html#mps_message_get" title="mps_message_get"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_get()</span></tt></a> begins a message &#8220;transaction&#8221;.
If there is a message of the specified type on the queue then the
first such message will be removed from the queue and a handle to it
will be returned to the client via the <tt class="docutils literal"><span class="pre">messageReturn</span></tt> argument; in
this case the function will return <tt class="xref c c-macro docutils literal"><span class="pre">TRUE</span></tt>. Otherwise it will return
<tt class="xref c c-macro docutils literal"><span class="pre">FALSE</span></tt>. Having obtained a handle on a message in this way, the
client can use the type-specific accessors to find out about the
message. When the client is done with the message the client should
call <a class="reference internal" href="../topic/message.html#mps_message_discard" title="mps_message_discard"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_discard()</span></tt></a>; failure to do so will result in a
resource leak.</p>
<p><span class="target" id="design.mps.message.if.fun.discard"></span><a class="mpstag reference internal" href="#design.mps.message.if.fun.discard">.if.fun.discard:</a> <a class="reference internal" href="../topic/message.html#mps_message_discard" title="mps_message_discard"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_discard()</span></tt></a> ends a message
&#8220;transaction&#8221;. It indicates to the MPS that the client is done with
this message and its resources may be reclaimed.</p>
<p><span class="target" id="design.mps.message.if.fun.type.any"></span><a class="mpstag reference internal" href="#design.mps.message.if.fun.type.any">.if.fun.type.any:</a> <a class="reference internal" href="../topic/message.html#mps_message_queue_type" title="mps_message_queue_type"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_queue_type()</span></tt></a> determines the type
of a message in the queue. Returns <tt class="xref c c-macro docutils literal"><span class="pre">TRUE</span></tt> only if there is a message
on the queue of arena, and in this case updates the <tt class="docutils literal"><span class="pre">typeReturn</span></tt>
argument to be the type of a message in the queue. Otherwise returns
<tt class="xref c c-macro docutils literal"><span class="pre">FALSE</span></tt>.</p>
<p><span class="target" id="design.mps.message.if.fun.type"></span><a class="mpstag reference internal" href="#design.mps.message.if.fun.type">.if.fun.type:</a> <a class="reference internal" href="../topic/message.html#mps_message_type" title="mps_message_type"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_type()</span></tt></a> determines the type of a
message (that has already been got). Only legal when inside a message
transaction (that is, after <a class="reference internal" href="../topic/message.html#mps_message_get" title="mps_message_get"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_get()</span></tt></a> and before
<a class="reference internal" href="../topic/message.html#mps_message_discard" title="mps_message_discard"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_discard()</span></tt></a>). Note that the type will be the same as the
type that the client passed in the call to <a class="reference internal" href="../topic/message.html#mps_message_get" title="mps_message_get"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_get()</span></tt></a>.</p>
</div>
<div class="section" id="types-of-messages">
<h3>17.3.2. Types of messages<a class="headerlink" href="#types-of-messages" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.message.type"></span><a class="mpstag reference internal" href="#design.mps.message.type">.type:</a> The type governs the &#8220;shape&#8221; and meaning of the message.</p>
<p><span class="target" id="design.mps.message.type.int"></span><a class="mpstag reference internal" href="#design.mps.message.type.int">.type.int:</a> Types themselves will just be a scalar quantity, an
integer.</p>
<p><span class="target" id="design.mps.message.type.semantics"></span><a class="mpstag reference internal" href="#design.mps.message.type.semantics">.type.semantics:</a> A type indicates the semantics of the message.</p>
<p><span class="target" id="design.mps.message.type.semantics.interpret"></span><a class="mpstag reference internal" href="#design.mps.message.type.semantics.interpret">.type.semantics.interpret:</a> The semantics of a message are
interpreted by the client by calling various accessor methods on the
message.</p>
<p><span class="target" id="design.mps.message.type.accessor"></span><a class="mpstag reference internal" href="#design.mps.message.type.accessor">.type.accessor:</a> The type of a message governs which accessor
methods are legal to apply to the message.</p>
<p><span class="target" id="design.mps.message.type.example"></span><a class="mpstag reference internal" href="#design.mps.message.type.example">.type.example:</a> Some example types:</p>
<p><span class="target" id="design.mps.message.type.finalization"></span><a class="mpstag reference internal" href="#design.mps.message.type.finalization">.type.finalization:</a> There will be a finalization type. The type is
abstractly: <tt class="docutils literal"><span class="pre">FinalizationMessage(Ref)</span></tt>.</p>
<p><span class="target" id="design.mps.message.type.finalization.semantics"></span><a class="mpstag reference internal" href="#design.mps.message.type.finalization.semantics">.type.finalization.semantics:</a> A finalization message indicates that
an object has been discovered to be finalizable (see
design.mps.poolmrg.def.final.object for a definition of finalizable).</p>
<p><span class="target" id="design.mps.message.type.finalization.ref"></span><a class="mpstag reference internal" href="#design.mps.message.type.finalization.ref">.type.finalization.ref:</a> There is an accessor to get the reference
of the finalization message (i.e. a reference to the object which is
finalizable) called <a class="reference internal" href="../topic/finalization.html#mps_message_finalization_ref" title="mps_message_finalization_ref"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_finalization_ref()</span></tt></a>.</p>
<p><span class="target" id="design.mps.message.type.finalization.ref.scan"></span><a class="mpstag reference internal" href="#design.mps.message.type.finalization.ref.scan">.type.finalization.ref.scan:</a> Note that the reference returned
should be stored in scanned memory.</p>
</div>
<div class="section" id="compatibility-issues">
<h3>17.3.3. Compatibility issues<a class="headerlink" href="#compatibility-issues" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.message.compatibility"></span><a class="mpstag reference internal" href="#design.mps.message.compatibility">.compatibility:</a> The following issues affect future compatibility of
the interface:</p>
<p><span class="target" id="design.mps.message.compatibility.future.type-new"></span><a class="mpstag reference internal" href="#design.mps.message.compatibility.future.type-new">.compatibility.future.type-new:</a> Notice that message of a type that
the client doesn&#8217;t understand are not placed on the queue, therefore
the MPS can introduce new types of message and existing client will
still function and will not leak resources. This has been achieved by
getting the client to declare the types that the client understands
(with <a class="reference internal" href="../topic/message.html#mps_message_type_enable" title="mps_message_type_enable"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_type_enable()</span></tt></a>, <a class="reference internal" href="#design.mps.message.if.fun.enable">.if.fun.enable</a>).</p>
<p><span class="target" id="design.mps.message.compatibility.future.type-extend"></span><a class="mpstag reference internal" href="#design.mps.message.compatibility.future.type-extend">.compatibility.future.type-extend:</a> The information available in a
message of a given type can be extended by providing more accessor
methods. Old clients won&#8217;t get any of this information but that&#8217;s
okay.</p>
</div>
</div>
<div class="section" id="internal-interface">
<h2>17.4. Internal interface<a class="headerlink" href="#internal-interface" title="Permalink to this headline">¶</a></h2>
<div class="section" id="types">
<h3>17.4.1. Types<a class="headerlink" href="#types" title="Permalink to this headline">¶</a></h3>
<dl class="type">
<dt id="Message">
struct <a class="reference internal" href="#MessageStruct" title="MessageStruct">MessageStruct</a> *<tt class="descname">Message</tt><a class="headerlink" href="#Message" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.message.message.type"></span><a class="mpstag reference internal" href="#design.mps.message.message.type">.message.type:</a> <a class="reference internal" href="#Message" title="Message"><tt class="xref c c-type docutils literal"><span class="pre">Message</span></tt></a> is the type of messages.</p>
<p><span class="target" id="design.mps.message.message.instance"></span><a class="mpstag reference internal" href="#design.mps.message.message.instance">.message.instance:</a> Messages are instances of Message Classes.</p>
<dl class="type">
<dt id="MessageStruct">
struct <a class="reference internal" href="#MessageStruct" title="MessageStruct">MessageStruct</a> *<tt class="descname">MessageStruct</tt><a class="headerlink" href="#MessageStruct" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.message.message.concrete"></span><a class="mpstag reference internal" href="#design.mps.message.message.concrete">.message.concrete:</a> Concretely a message is represented by a
<a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a>. A <a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a> has the usual signature field
(see design.mps.sig). A <a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a> has a type field which
defines its type, a ring node, which is used to attach the message to
the queue of pending messages, a class field, which identifies a
<a class="reference internal" href="#MessageClass" title="MessageClass"><tt class="xref c c-type docutils literal"><span class="pre">MessageClass</span></tt></a> object.</p>
<p><span class="target" id="design.mps.message.message.intent"></span><a class="mpstag reference internal" href="#design.mps.message.message.intent">.message.intent:</a> The intention is that a <a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a> will be
embedded in some richer object which contains information relevant to
that specific type of message.</p>
<p><span class="target" id="design.mps.message.message.struct"></span><a class="mpstag reference internal" href="#design.mps.message.message.struct">.message.struct:</a> The structure is declared as follows:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">struct</span> <span class="n">MessageStruct</span> <span class="p">{</span>
  <span class="n">Sig</span> <span class="n">sig</span><span class="p">;</span>
  <span class="n">MessageType</span> <span class="n">type</span><span class="p">;</span>
  <span class="n">MessageClass</span> <span class="n">class</span><span class="p">;</span>
  <span class="n">RingStruct</span> <span class="n">node</span><span class="p">;</span>
<span class="p">}</span> <span class="n">MessageStruct</span><span class="p">;</span>
</pre></div>
</div>
<dl class="type">
<dt id="MessageClass">
struct MessageClassStruct *<tt class="descname">MessageClass</tt><a class="headerlink" href="#MessageClass" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.message.class"></span><a class="mpstag reference internal" href="#design.mps.message.class">.class:</a> A message class is an encapsulation of methods. It
encapsulates methods that are applicable to all types of messages
(generic) and methods that are applicable to messages only of a
certain type (type-specific).</p>
<p><span class="target" id="design.mps.message.class.concrete"></span><a class="mpstag reference internal" href="#design.mps.message.class.concrete">.class.concrete:</a> Concretely a message class is represented by a
<tt class="xref c c-type docutils literal"><span class="pre">MessageClassStruct</span></tt> (a struct). Clients of the Message module are
expected to allocate storage for and initialise the
<tt class="xref c c-type docutils literal"><span class="pre">MessageClassStruct</span></tt>. It is expected that such storage will be
allocated and initialised statically.</p>
<p><span class="target" id="design.mps.message.class.one-type"></span><a class="mpstag reference internal" href="#design.mps.message.class.one-type">.class.one-type:</a> A message class implements exactly one message
type. The identifier for this type is stored in the <tt class="docutils literal"><span class="pre">type</span></tt> field of
the <tt class="xref c c-type docutils literal"><span class="pre">MessageClassStruct</span></tt>. Note that the converse is not true: a
single message type may be implemented by two (or more) different
message classes (for example: for two pool classes that require
different implementations for that message type).</p>
<p><span class="target" id="design.mps.message.class.methods.generic"></span><a class="mpstag reference internal" href="#design.mps.message.class.methods.generic">.class.methods.generic:</a> The generic methods are as follows:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">delete</span></tt> &#8211; used when the message is destroyed (by the client
calling <a class="reference internal" href="../topic/message.html#mps_message_discard" title="mps_message_discard"><tt class="xref c c-func docutils literal"><span class="pre">mps_message_discard()</span></tt></a>). The class implementation should
finish the message (by calling <a class="reference internal" href="#MessageFinish" title="MessageFinish"><tt class="xref c c-func docutils literal"><span class="pre">MessageFinish()</span></tt></a>) and storage for
the message should be reclaimed (if applicable).</li>
</ul>
<p><span class="target" id="design.mps.message.class.methods.specific"></span><a class="mpstag reference internal" href="#design.mps.message.class.methods.specific">.class.methods.specific:</a> The type specific methods are:</p>
<p><span class="target" id="design.mps.message.class.methods.specific.finalization"></span><a class="mpstag reference internal" href="#design.mps.message.class.methods.specific.finalization">.class.methods.specific.finalization:</a> Specific to
<tt class="docutils literal"><span class="pre">MessageTypeFinalization</span></tt>:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">finalizationRef</span></tt> &#8211; returns a reference to the finalizable object
represented by this message.</li>
</ul>
<p><span class="target" id="design.mps.message.class.methods.specific.collectionstats"></span><a class="mpstag reference internal" href="#design.mps.message.class.methods.specific.collectionstats">.class.methods.specific.collectionstats:</a> Specific to <tt class="docutils literal"><span class="pre">MessageTypeCollectionStats</span></tt>:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">collectionStatsLiveSize</span></tt> &#8211; returns the number of bytes (of
objects) that were condemned but survived.</li>
<li><tt class="docutils literal"><span class="pre">collectionStatsCondemnedSize</span></tt> &#8211; returns the number of bytes
condemned in the collection.</li>
<li><tt class="docutils literal"><span class="pre">collectionStatsNotCondemnedSize</span></tt> &#8211; returns the the number of
bytes (of objects) that are subject to a GC policy (that is,
collectable) but were not condemned in the collection.</li>
</ul>
<p><span class="target" id="design.mps.message.class.sig.double"></span><a class="mpstag reference internal" href="#design.mps.message.class.sig.double">.class.sig.double:</a> The <tt class="xref c c-type docutils literal"><span class="pre">MessageClassStruct</span></tt> has a signature field
at both ends. This is so that if the <tt class="xref c c-type docutils literal"><span class="pre">MessageClassStruct</span></tt> changes
size (by adding extra methods for example) then any static
initializers will generate errors from the compiler (there will be a
type error causes by initialising a non-signature type field with a
signature) unless the static initializers are changed as well.</p>
<p><span class="target" id="design.mps.message.class.struct"></span><a class="mpstag reference internal" href="#design.mps.message.class.struct">.class.struct:</a> The structure is declared as follows:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">MessageClassStruct</span> <span class="p">{</span>
  <span class="n">Sig</span> <span class="n">sig</span><span class="p">;</span>                      <span class="cm">/* design.mps.sig */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>             <span class="cm">/* Human readable Class name */</span>

  <span class="cm">/* generic methods */</span>
  <span class="n">MessageDeleteMethod</span> <span class="n">delete</span><span class="p">;</span>   <span class="cm">/* terminates a message */</span>

  <span class="cm">/* methods specific to MessageTypeFinalization */</span>
  <span class="n">MessageFinalizationRefMethod</span> <span class="n">finalizationRef</span><span class="p">;</span>

  <span class="cm">/* methods specific to MessageTypeCollectionStats */</span>
  <span class="n">MessageCollectionStatsLiveSizeMethod</span> <span class="n">collectionStatsLiveSize</span><span class="p">;</span>
  <span class="n">MessageCollectionStatsCondemnedSizeMethod</span> <span class="n">collectionStatsCondemnedSize</span><span class="p">;</span>
  <span class="n">MessageCollectionStatsNotCondemnedSizeMethod</span> <span class="n">collectionStatsNotCondemnedSize</span><span class="p">;</span>

  <span class="n">Sig</span> <span class="n">endSig</span><span class="p">;</span>                   <span class="cm">/* design.mps.message.class.sig.double */</span>
<span class="p">}</span> <span class="n">MessageClassStruct</span><span class="p">;</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.message.space.queue"></span><a class="mpstag reference internal" href="#design.mps.message.space.queue">.space.queue:</a> The arena structure is augmented with a structure for
managing for queue of pending messages. This is a ring in the
<tt class="xref c c-type docutils literal"><span class="pre">ArenaStruct</span></tt>:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">struct</span> <span class="n">ArenaStruct</span>
<span class="p">{</span>
  <span class="p">...</span>
  <span class="n">RingStruct</span> <span class="n">messageRing</span><span class="p">;</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>17.4.2. Functions<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="MessageInit">
void <tt class="descname">MessageInit</tt><big>(</big><a class="reference internal" href="arena.html#Arena" title="Arena">Arena</a><em>&nbsp;arena</em>, <a class="reference internal" href="#Message" title="Message">Message</a><em>&nbsp;message</em>, <a class="reference internal" href="#MessageClass" title="MessageClass">MessageClass</a><em>&nbsp;class</em><big>)</big><a class="headerlink" href="#MessageInit" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.message.fun.init"></span><a class="mpstag reference internal" href="#design.mps.message.fun.init">.fun.init:</a> Initializes the <a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a> pointed to by
<tt class="docutils literal"><span class="pre">message</span></tt>. The caller of this function is expected to manage the
store for the <a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a>.</p>
<dl class="function">
<dt id="MessageFinish">
void <tt class="descname">MessageFinish</tt><big>(</big><a class="reference internal" href="#Message" title="Message">Message</a><em>&nbsp;message</em><big>)</big><a class="headerlink" href="#MessageFinish" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.message.fun.finish"></span><a class="mpstag reference internal" href="#design.mps.message.fun.finish">.fun.finish:</a> Finishes the <a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a> pointed to by
<tt class="docutils literal"><span class="pre">message</span></tt>. The caller of this function is expected to manage the
store for the <a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a>.</p>
<dl class="function">
<dt id="MessagePost">
void <tt class="descname">MessagePost</tt><big>(</big><a class="reference internal" href="arena.html#Arena" title="Arena">Arena</a><em>&nbsp;arena</em>, <a class="reference internal" href="#Message" title="Message">Message</a><em>&nbsp;message</em><big>)</big><a class="headerlink" href="#MessagePost" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.message.fun.post"></span><a class="mpstag reference internal" href="#design.mps.message.fun.post">.fun.post:</a> Places a message on the queue of an arena.</p>
<p><span class="target" id="design.mps.message.fun.post.precondition"></span><a class="mpstag reference internal" href="#design.mps.message.fun.post.precondition">.fun.post.precondition:</a> Prior to calling the function, the node
field of the message must be a singleton. After the call to the
function the message will be available for MPS client to access. After
the call to the function the message fields must not be manipulated
except from the message&#8217;s class&#8217;s method functions (that is, you
mustn&#8217;t poke about with the node field in particular).</p>
<dl class="function">
<dt id="MessageEmpty">
void <tt class="descname">MessageEmpty</tt><big>(</big><a class="reference internal" href="arena.html#Arena" title="Arena">Arena</a><em>&nbsp;arena</em><big>)</big><a class="headerlink" href="#MessageEmpty" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.message.fun.empty"></span><a class="mpstag reference internal" href="#design.mps.message.fun.empty">.fun.empty:</a> Empties the message queue. This function has the same
effect as discarding all the messages on the queue. After calling this
function there will be no messages on the queue.</p>
<p><span class="target" id="design.mps.message.fun.empty.internal-only"></span><a class="mpstag reference internal" href="#design.mps.message.fun.empty.internal-only">.fun.empty.internal-only:</a> This functionality is not exposed to
clients. We might want to expose this functionality to our clients in
the future.</p>
</div>
</div>
<div class="section" id="message-life-cycle">
<h2>17.5. Message life cycle<a class="headerlink" href="#message-life-cycle" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.message.life"></span><a class="mpstag reference internal" href="#design.mps.message.life">.life:</a> A message will be allocated by a client of the message
module, it will be initialised by calling <a class="reference internal" href="#MessageInit" title="MessageInit"><tt class="xref c c-func docutils literal"><span class="pre">MessageInit()</span></tt></a>. The
client will eventually post the message on the external queue (in fact
most clients will create a message and then immediately post it). The
message module may then apply any of the methods to the message. The
message module will eventually destroy the message by applying the
<tt class="docutils literal"><span class="pre">delete</span></tt> method to it.</p>
</div>
<div class="section" id="examples">
<h2>17.6. Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="finalization">
<h3>17.6.1. Finalization<a class="headerlink" href="#finalization" title="Permalink to this headline">¶</a></h3>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">Possibly out of date, see design.mps.finalize and
design.mps.poolmrg instead. David Jones, 1997-08-28.</p>
</div>
<p>This subsection is a sketch of how PoolMRG will use Messages for
finalization (see design.mps.poolmrg).</p>
<p>PoolMRG has guardians (see design.mps.poolmrg.guardian). Guardians are
used to manage final references and detect when an object is
finalizable.</p>
<p>The link part of a guardian will include a <a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a>.</p>
<p>The <a class="reference internal" href="#MessageStruct" title="MessageStruct"><tt class="xref c c-type docutils literal"><span class="pre">MessageStruct</span></tt></a> is allocated when the final reference is created
(which is when the referred to object is registered for finalization).
This avoids allocating at the time when the message gets posted (which
might be a tricky, undesirable, or impossible, time to allocate).</p>
<p>PoolMRG has two queues: the entry queue, and the exit queue. The entry
queue will use a ring; the exit queue of MRG will simply be the
external message queue.</p>
<p>The <tt class="docutils literal"><span class="pre">delete</span></tt> method frees both the link part and the reference part
of the guardian.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">17. Client message protocol</a><ul>
<li><a class="reference internal" href="#introduction">17.1. Introduction</a></li>
<li><a class="reference internal" href="#requirements">17.2. Requirements</a></li>
<li><a class="reference internal" href="#external-interface">17.3. External interface</a><ul>
<li><a class="reference internal" href="#functions">17.3.1. Functions</a></li>
<li><a class="reference internal" href="#types-of-messages">17.3.2. Types of messages</a></li>
<li><a class="reference internal" href="#compatibility-issues">17.3.3. Compatibility issues</a></li>
</ul>
</li>
<li><a class="reference internal" href="#internal-interface">17.4. Internal interface</a><ul>
<li><a class="reference internal" href="#types">17.4.1. Types</a></li>
<li><a class="reference internal" href="#id1">17.4.2. Functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#message-life-cycle">17.5. Message life cycle</a></li>
<li><a class="reference internal" href="#examples">17.6. Examples</a><ul>
<li><a class="reference internal" href="#finalization">17.6.1. Finalization</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="locus.html"
                        title="previous chapter">16. MPS Configuration</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="message-gc.html"
                        title="next chapter">18. GC messages</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="message-gc.html" title="18. GC messages"
             >next</a> |</li>
        <li class="right" >
          <a href="locus.html" title="16. MPS Configuration"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" >Old design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>