

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>48. Tracer &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Old design" href="old.html" />
    <link rel="next" title="49. General MPS types" href="type.html" />
    <link rel="prev" title="47. Thread safety in the MPS" href="thread-safety.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="type.html" title="49. General MPS types"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="thread-safety.html" title="47. Thread safety in the MPS"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" accesskey="U">Old design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tracer">
<span id="design-trace"></span><span id="index-0"></span><h1>48. Tracer<a class="headerlink" href="#tracer" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.trace"></span><h2>48.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This document is currently a mixture of very old design notes (the
preformatted section immediately following) and some newer stuff.
It doesn&#8217;t yet form anything like a complete picture.</p>
</div>
</div>
<div class="section" id="architecture">
<h2>48.2. Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.trace.instance.limit"></span><a class="mpstag reference internal" href="#design.mps.trace.instance.limit">.instance.limit:</a> There will be a limit on the number of traces that
can be created at any one time. This effectively limits the number of
concurrent traces. This limitation is expressed in the symbol
<tt class="xref c c-macro docutils literal"><span class="pre">TRACE_MAX</span></tt>.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="xref c c-macro docutils literal"><span class="pre">TRACE_MAX</span></tt> is currently set to 1, see <a class="reference external" href="https://info.ravenbrook.com/project/mps/import/2001-11-05/mmprevol/request/mps/160020">request.mps.160020</a>
&#8220;Multiple traces would not work&#8221;. David Jones, 1998-06-15.</p>
</div>
<p><span class="target" id="design.mps.trace.rate"></span><a class="mpstag reference internal" href="#design.mps.trace.rate">.rate:</a> See <a class="reference external" href="/project/mps/mail/1997/07/31/14-37/0.txt">mail.nickb.1997-07-31.14-37</a>.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">Now revised? See <a class="reference external" href="https://info.ravenbrook.com/project/mps/import/2001-11-05/mmprevol/request/epcore/160062">request.epcore.160062</a> and
change.epcore.minnow.160062. David Jones, 1998-06-15.</p>
</div>
<p><span class="target" id="design.mps.trace.exact.legal"></span><a class="mpstag reference internal" href="#design.mps.trace.exact.legal">.exact.legal:</a> Exact references should either point outside the
arena (to non-managed address space) or to a tract allocated to a
pool. Exact references that are to addresses which the arena has
reserved but hasn&#8217;t allocated memory to are illegal (the exact
reference couldn&#8217;t possibly refer to a real object). Depending on the
future semantics of <tt class="xref c c-func docutils literal"><span class="pre">PoolDestroy()</span></tt> we might need to adjust our
strategy here. See mail.dsm.1996-02-14.18-18 for a strategy of coping
gracefully with <tt class="xref c c-func docutils literal"><span class="pre">PoolDestroy()</span></tt>. We check that this is the case in the
fixer. It may be sensible to make this check CRITICAL in certain
configurations.</p>
<p><span class="target" id="design.mps.trace.fix.fixed.all"></span><a class="mpstag reference internal" href="#design.mps.trace.fix.fixed.all">.fix.fixed.all:</a> <tt class="docutils literal"><span class="pre">ss-&gt;fixedSummary</span></tt> is accumulated (in the fixer)
for all the pointers whether or not they are genuine references. We
could accumulate fewer pointers here; if a pointer fails the
<a class="reference internal" href="arena.html#TractOfAddr" title="TractOfAddr"><tt class="xref c c-func docutils literal"><span class="pre">TractOfAddr()</span></tt></a> test then we know it isn&#8217;t a reference, so we needn&#8217;t
accumulate it into the fixed summary. The design allows this, but it
breaks a useful post-condition on scanning (if the accumulation of
<tt class="docutils literal"><span class="pre">ss-&gt;fixedSummary</span></tt> was moved the accuracy of <tt class="docutils literal"><span class="pre">ss-&gt;fixedSummary</span></tt>
would vary according to the &#8220;width&#8221; of the white summary). See
mail.pekka.1998-02-04.16-48 for improvement suggestions.</p>
</div>
<div class="section" id="analysis">
<h2>48.3. Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.trace.fix.copy-fail"></span><a class="mpstag reference internal" href="#design.mps.trace.fix.copy-fail">.fix.copy-fail:</a> Fixing can always succeed, even if copying the
referenced object has failed (due to lack of memory, for example), by
backing off to treating a reference as ambiguous. Assuming that fixing
an ambiguous reference doesn&#8217;t allocate memory (which is no longer
true for AMC for example). See <a class="reference external" href="https://info.ravenbrook.com/project/mps/import/2001-11-05/mmprevol/request/dylan/170560">request.dylan.170560</a> for a slightly
more sophisticated way to proceed when you can no longer allocate
memory for copying.</p>
</div>
<div class="section" id="ideas">
<h2>48.4. Ideas<a class="headerlink" href="#ideas" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.trace.flip.after"></span><a class="mpstag reference internal" href="#design.mps.trace.flip.after">.flip.after:</a> To avoid excessive barrier impact on the mutator
immediately after flip, we could scan during flip other objects which
are &#8220;near&#8221; the roots, or otherwise known to be likely to be accessed
in the near future.</p>
</div>
<div class="section" id="implementation">
<h2>48.5. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="speed">
<h3>48.5.1. Speed<a class="headerlink" href="#speed" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.trace.fix"></span><a class="mpstag reference internal" href="#design.mps.trace.fix">.fix:</a> The fix path is critical to garbage collection speed.
Abstractly fix is applied to all the references in the non-white heap
and all the references in the copied heap. Remembered sets cut down
the number of segments we have to scan. The zone test cuts down the
number of references we call fix on. The speed of the remainder of the
fix path is still critical to system performance. Various
modifications to and aspects of the system are concerned with
maintaining the speed along this path.</p>
<p><span class="target" id="design.mps.trace.fix.tractofaddr"></span><a class="mpstag reference internal" href="#design.mps.trace.fix.tractofaddr">.fix.tractofaddr:</a> <a class="reference internal" href="arena.html#TractOfAddr" title="TractOfAddr"><tt class="xref c c-func docutils literal"><span class="pre">TractOfAddr()</span></tt></a> is called on every reference that
passes the zone test and is on the critical path, to determine whether
the segment is white. There is no need to examine the segment to
perform this test, since whiteness information is duplicated in
tracts, specifically to optimize this test. <a class="reference internal" href="arena.html#TractOfAddr" title="TractOfAddr"><tt class="xref c c-func docutils literal"><span class="pre">TractOfAddr()</span></tt></a> itself is
a simple class dispatch function (which dispatches to the arena
class&#8217;s <a class="reference internal" href="arena.html#TractOfAddr" title="TractOfAddr"><tt class="xref c c-func docutils literal"><span class="pre">TractOfAddr()</span></tt></a> method). Inlining the dispatch and inlining
the functions called by <tt class="xref c c-func docutils literal"><span class="pre">VMTractOfAddr()</span></tt> makes a small but noticable
difference to the speed of the dylan compiler.</p>
<p><span class="target" id="design.mps.trace.fix.noaver"></span><a class="mpstag reference internal" href="#design.mps.trace.fix.noaver">.fix.noaver:</a> <tt class="xref c c-func docutils literal"><span class="pre">AVER()</span></tt> statements in the code add bulk to the code
(reducing I-cache efficacy) and add branches to the path (polluting
the branch pedictors) resulting in a slow down. Removing all the
<tt class="xref c c-func docutils literal"><span class="pre">AVER()</span></tt> statements from the fix path improves the overall speed of
the Dylan compiler by as much as 9%.</p>
<p><span class="target" id="design.mps.trace.fix.nocopy"></span><a class="mpstag reference internal" href="#design.mps.trace.fix.nocopy">.fix.nocopy:</a> <a class="reference internal" href="poolamc.html#AMCFix" title="AMCFix"><tt class="xref c c-func docutils literal"><span class="pre">AMCFix()</span></tt></a> used to copy objects by using the format&#8217;s
copy method. This involved a function call (through an indirection)
and in <tt class="docutils literal"><span class="pre">dylan_copy</span></tt> a call to <tt class="docutils literal"><span class="pre">dylan_skip</span></tt> (to recompute the
length) and call to <tt class="docutils literal"><span class="pre">memcpy</span></tt> with general parameters. Replacing this
with a direct call to <tt class="docutils literal"><span class="pre">memcpy</span></tt> removes these overheads and the call
to <tt class="docutils literal"><span class="pre">memcpy</span></tt> now has aligned parameters. The call to <tt class="docutils literal"><span class="pre">memcpy</span></tt> is
inlined by the C compiler. This change results in a 4–5% speed-up in
the Dylan compiler.</p>
<p><span class="target" id="design.mps.trace.reclaim"></span><a class="mpstag reference internal" href="#design.mps.trace.reclaim">.reclaim:</a> Because the reclaim phase of the trace (implemented by
<tt class="xref c c-func docutils literal"><span class="pre">TraceReclaim()</span></tt>) examines every segment it is fairly time intensive.
rit&#8217;s profiles presented in <a class="reference external" href="https://info.ravenbrook.com/project/mps/import/2001-11-05/mmprevol/request/dylan/170551">request.dylan.170551</a> show a gap between
the two varieties variety.hi and variety.wi.</p>
<p><span class="target" id="design.mps.trace.reclaim.noaver"></span><a class="mpstag reference internal" href="#design.mps.trace.reclaim.noaver">.reclaim.noaver:</a> Converting <tt class="xref c c-func docutils literal"><span class="pre">AVER()</span></tt> statements in the loops of
<tt class="xref c c-func docutils literal"><span class="pre">TraceReclaim()</span></tt>, <tt class="xref c c-func docutils literal"><span class="pre">PoolReclaim()</span></tt>, <a class="reference internal" href="poolamc.html#AMCReclaim" title="AMCReclaim"><tt class="xref c c-func docutils literal"><span class="pre">AMCReclaim()</span></tt></a> (<a class="reference internal" href="poollo.html#LOReclaim" title="LOReclaim"><tt class="xref c c-func docutils literal"><span class="pre">LOReclaim()</span></tt></a>?
<a class="reference internal" href="poolawl.html#AWLReclaim" title="AWLReclaim"><tt class="xref c c-func docutils literal"><span class="pre">AWLReclaim()</span></tt></a>?) will result in a noticeable speed improvement.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">Insert actual speed improvement here, if any.</p>
</div>
</div>
</div>
<div class="section" id="life-cycle-of-a-trace-object">
<h2>48.6. Life cycle of a trace object<a class="headerlink" href="#life-cycle-of-a-trace-object" title="Permalink to this headline">¶</a></h2>
<p><tt class="xref c c-func docutils literal"><span class="pre">TraceCreate()</span></tt> creates a trace in state <tt class="docutils literal"><span class="pre">TraceINIT</span></tt></p>
<p>Some segments get condemned (made white).</p>
<p><tt class="xref c c-func docutils literal"><span class="pre">TraceStart()</span></tt> gets called which:</p>
<ul class="simple">
<li>Derives an initial reference partition based on the existing
white set.  The white zone set and the segments&#8217; summaries are used to
create an initial grey set.</li>
<li>Emits a <tt class="xref c c-func docutils literal"><span class="pre">GCStart()</span></tt> message.</li>
<li>Initialises <tt class="docutils literal"><span class="pre">trace-&gt;rate</span></tt> by estimating the required scanning
rate.</li>
<li>Moves the trace into the state <tt class="docutils literal"><span class="pre">TraceUNFLIPPED</span></tt>.</li>
<li>Immediately calls <tt class="docutils literal"><span class="pre">traceFlip</span></tt> which flips the trace and moves
it into state <tt class="docutils literal"><span class="pre">TraceFLIPPED</span></tt>.</li>
</ul>
<p>Whilst a trace is alive every so often its <tt class="docutils literal"><span class="pre">traceQuantum</span></tt> method
gets invoked (via <tt class="xref c c-func docutils literal"><span class="pre">TracePoll()</span></tt>) in order to do a quantum of tracing
work. <tt class="docutils literal"><span class="pre">traceQuantum</span></tt> is responsible for ticking through the trace&#8217;s
top-level state machine. Most of the interesting work, the tracing,
happens in the <tt class="docutils literal"><span class="pre">TraceFLIPPED</span></tt> state.</p>
<p>The trace transitions through its states in the following sequence:
<tt class="docutils literal"><span class="pre">TraceINIT</span></tt> → (<tt class="docutils literal"><span class="pre">TraceUNFLIPPED</span></tt>) → <tt class="docutils literal"><span class="pre">TraceFLIPPED</span></tt> →
<tt class="docutils literal"><span class="pre">TraceRECLAIM</span></tt> → <tt class="docutils literal"><span class="pre">TraceFINISHED</span></tt>.</p>
<p>Whilst <tt class="docutils literal"><span class="pre">TraceUNFLIPPED</span></tt> appears in the code, no trace does any work
in this state; all traces are immediately flipped to be in the
<tt class="docutils literal"><span class="pre">TraceFLIPPED</span></tt> state (see above).</p>
<p>Once the trace is in the <tt class="docutils literal"><span class="pre">TraceFINISHED</span></tt> state it performs no more
work and it can be safely destroyed. Generally the callers of
<tt class="docutils literal"><span class="pre">traceQuantum</span></tt> will destroy the trace.</p>
<div class="section" id="making-progress-scanning-grey-segments">
<h3>48.6.1. Making progress: scanning grey segments<a class="headerlink" href="#making-progress-scanning-grey-segments" title="Permalink to this headline">¶</a></h3>
<p>Most of the interesting work of a trace, the actual tracing, happens
in the <tt class="docutils literal"><span class="pre">TraceFLIPPED</span></tt> state (work <em>would</em> happen in the
<tt class="docutils literal"><span class="pre">TraceUNFLIPPED</span></tt> state, but that is not implemented).</p>
<p>The tracer makes progress by choosing a grey segment to scan, and
scanning it. The actual scanning is performed by pools.</p>
<p>Note that at all times a reference partition is maintained.</p>
<p>The order in which the trace scans things determines the semantics of
certain types of references (in particular, weak and final
references). Or, to put it another way the desired semantics of weak
and final references impose certain restrictions on the order in which
the trace can scan things.</p>
<p>The tracer uses a system of <em>reference ranks</em> (or just ranks) so that
it can impose an order on its scanning work. The ranks are ordered.</p>
<p>The tracer proceeds band by band. The first band is all objects it can
reach by following references of the first rank. The second band is
all subsequent objects it can reach by following references of the
second and first ranks. The third band is all subsequent objects it
can reach by following references of the third, second, and first
ranks. And so on. The description of the tracer working like this
originated in <a class="reference internal" href="#rhsk-2007-06-25">[RHSK_2007-06-25]</a>.</p>
<p>A trace keep track of which band it is tracing. This is returned by
the <tt class="xref c c-func docutils literal"><span class="pre">TraceBand()</span></tt> method. Keeping this band information helps it
implement the semantics of finalization and weakness. The band used to
not be explicitly stored, but this hindered the implementation of good
finalization semantics (essentially in some circumstances finalization
messages were delayed by at least one collection cycle, see
<a class="reference external" href="https://info.ravenbrook.com/project/mps/issue/job001658/">job001658</a>.</p>
<p>The band is used when selecting a grey segment to scan (the selection
occurs in <tt class="xref c c-func docutils literal"><span class="pre">traceFindGrey()</span></tt>). The tracer attempts to first find
segments whose rank is the current band, then segments whose rank is
previous to the current band, and so on. If there are no segments
found then the current band is exhausted and the current band is
incremented to the next rank. When the current band is moved through
all the ranks in this fashion there is no more tracing to be done.</p>
</div>
</div>
<div class="section" id="references">
<h2>48.7. References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils citation" frame="void" id="rhsk-2007-06-25" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[RHSK_2007-06-25]</a></td><td>Richard Kistruck. Ravenbrook Limited. 2007-06-25. &#8220;<a class="reference external" href="https://info.ravenbrook.com/mail/2007/06/25/11-35-57/0/">The semantics of rank-based tracing</a>&#8221;.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">48. Tracer</a><ul>
<li><a class="reference internal" href="#introduction">48.1. Introduction</a></li>
<li><a class="reference internal" href="#architecture">48.2. Architecture</a></li>
<li><a class="reference internal" href="#analysis">48.3. Analysis</a></li>
<li><a class="reference internal" href="#ideas">48.4. Ideas</a></li>
<li><a class="reference internal" href="#implementation">48.5. Implementation</a><ul>
<li><a class="reference internal" href="#speed">48.5.1. Speed</a></li>
</ul>
</li>
<li><a class="reference internal" href="#life-cycle-of-a-trace-object">48.6. Life cycle of a trace object</a><ul>
<li><a class="reference internal" href="#making-progress-scanning-grey-segments">48.6.1. Making progress: scanning grey segments</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">48.7. References</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="thread-safety.html"
                        title="previous chapter">47. Thread safety in the MPS</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="type.html"
                        title="next chapter">49. General MPS types</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="type.html" title="49. General MPS types"
             >next</a> |</li>
        <li class="right" >
          <a href="thread-safety.html" title="47. Thread safety in the MPS"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" >Old design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>