

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1. Allocation frame protocol &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Old design" href="old.html" />
    <link rel="next" title="2. Arena" href="arena.html" />
    <link rel="prev" title="Old design" href="old.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="arena.html" title="2. Arena"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="old.html" title="Old design"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" accesskey="U">Old design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="allocation-frame-protocol">
<span id="design-alloc-frame"></span><span id="index-0"></span><h1>1. Allocation frame protocol<a class="headerlink" href="#allocation-frame-protocol" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.alloc-frame"></span><h2>1.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.alloc-frame.intro"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.intro">.intro:</a> This document explains the design of the support for
allocation frames in MPS.</p>
<p><span class="target" id="design.mps.alloc-frame.readership"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.readership">.readership:</a> This document is intended for any MM developer.</p>
<p><span class="target" id="design.mps.alloc-frame.overview"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.overview">.overview:</a> Allocation frames are used for implementing stack pools;
each stack frame corresponds to an allocation frame. Allocation frames
may also be suitable for implementing other sub-pool groupings, such
as generations and ramp allocation patterns.</p>
<p><span class="target" id="design.mps.alloc-frame.overview.ambition"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.overview.ambition">.overview.ambition:</a> We now believe this to be a design that loses
too many advantages of stack allocation for questionable gains. The
requirements are almost entirely based on unanalysed anecdote, instead
of actual clients.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">We plan to supersede this with a stack pool design at some point
in the future. Pekka P. Pirinen, 2000-03-09.</p>
</div>
</div>
<div class="section" id="definitions">
<h2>1.2. Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.alloc-frame.def.alloc-frame"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.def.alloc-frame">.def.alloc-frame:</a> An allocation frame is a generic name for a
device which groups objects together with other objects at allocation
time, and which may have a parent/child relationship with other
allocation frames.</p>
</div>
<div class="section" id="purpose">
<h2>1.3. Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.alloc-frame.purpose.stack-allocation"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.purpose.stack-allocation">.purpose.stack-allocation:</a> The allocation frame protocol is
intended to support efficient memory management for stack allocation,
that is, the allocation of objects which have dynamic extent.</p>
<p><span class="target" id="design.mps.alloc-frame.purpose.general"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.purpose.general">.purpose.general:</a> The allocation frame protocol is intended to be
sufficiently general that it will be useful in supporting other types
of nested allocation patterns too. For example, it could be used to
for EPVM-style save and restore, ramp allocation patterns or
generations.</p>
</div>
<div class="section" id="requirements">
<h2>1.4. Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<div class="section" id="known-requirements">
<h3>1.4.1. Known requirements<a class="headerlink" href="#known-requirements" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.alloc-frame.req.stack-alloc"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.stack-alloc">.req.stack-alloc:</a> Provide a interface for clients to describe a
stack allocation pattern, as an alternative to using the control
stack.</p>
<p><span class="target" id="design.mps.alloc-frame.req.efficient"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.efficient">.req.efficient:</a> Permit an implementation which is comparable in
efficiency to allocating on the control stack.</p>
<p><span class="target" id="design.mps.alloc-frame.req.ap"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.ap">.req.ap:</a> Support allocation via allocation points (APs).</p>
<p><span class="target" id="design.mps.alloc-frame.req.format"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.format">.req.format:</a> Support the allocation of formatted objects.</p>
<p><span class="target" id="design.mps.alloc-frame.req.scan"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.scan">.req.scan:</a> Ensure that objects in allocation frames can participate
in garbage collection by being scanned.</p>
<p><span class="target" id="design.mps.alloc-frame.req.fix"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.fix">.req.fix:</a> Ensure that objects in allocation frames can participate
in garbage collection by accepting Fix requests.</p>
<p><span class="target" id="design.mps.alloc-frame.req.condemn"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.condemn">.req.condemn:</a> Ensure that objects in allocation frames can
participate in garbage collection by being condemned.</p>
<p><span class="target" id="design.mps.alloc-frame.attr.locking"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.attr.locking">.attr.locking:</a> Minimize the synchronization cost for the creation
and destruction of frames.</p>
</div>
<div class="section" id="proto-requirements">
<h3>1.4.2. Proto-requirements<a class="headerlink" href="#proto-requirements" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.alloc-frame.proto-req"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.proto-req">.proto-req:</a> The following are possible requirements that might be
important in the future. The design does not necessarily meet all
these requirements, but it does consider them all. Each requirement
either has direct support in the framework, or could be supported with
future additions to the framework.</p>
<p><span class="target" id="design.mps.alloc-frame.req.parallels"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.parallels">.req.parallels:</a> The allocation frame protocol should provide a
framework for exploiting the parallels between stack extents,
generations and &#8220;ramps&#8221;.</p>
<p><span class="target" id="design.mps.alloc-frame.req.pool-destroy"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.pool-destroy">.req.pool-destroy:</a> It should be possible to use allocation frames
to free all objects in a pool without destroying the pool.</p>
<p><span class="target" id="design.mps.alloc-frame.req.epvm"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.epvm">.req.epvm:</a> It should be possible to implement EPVM-style save and
restore operations by creating and destroying allocation frames.</p>
<p><span class="target" id="design.mps.alloc-frame.req.subst"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.subst">.req.subst:</a> It should be possible to substitute a stack pool with a
GC-ed pool so that erroneous use of a stack pool can be detected.</p>
<p><span class="target" id="design.mps.alloc-frame.req.format-extensions"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.format-extensions">.req.format-extensions:</a> It should be possible for stack pools to
utilize the same format as any other pool, including debugging formats
that include fenceposting, etc.</p>
<p><span class="target" id="design.mps.alloc-frame.req.mis-nest"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.mis-nest">.req.mis-nest:</a> Should ensure &#8220;mis-nested&#8221; stacks are safe.</p>
<p><span class="target" id="design.mps.alloc-frame.req.non-top-level"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.non-top-level">.req.non-top-level:</a> Should support allocation in the non-top stack
extent.</p>
<p><span class="target" id="design.mps.alloc-frame.req.copy-if-necessary"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.copy-if-necessary">.req.copy-if-necessary:</a> Should ensure that stack pools can support
&#8220;copy-if-necessary&#8221; (so that low-level system code can heapify stack
objects.)</p>
<p><span class="target" id="design.mps.alloc-frame.req.preserve"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.preserve">.req.preserve:</a> When an object is in an allocation frame which is
being destroyed, it should be possible to preserve that object in the
parent frame.</p>
<p><span class="target" id="design.mps.alloc-frame.req.contained"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.contained">.req.contained:</a> Should allow clients to ask if an object is
&#8220;contained&#8221; in a frame. The object is contained in a frame if it is
affected when the frame is ended.</p>
<p><span class="target" id="design.mps.alloc-frame.req.alloc-with-other"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.req.alloc-with-other">.req.alloc-with-other:</a> Should allow clients to allocate an object
in the same frame as another object.</p>
</div>
</div>
<div class="section" id="overview">
<h2>1.5. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.alloc-frame.frame-classes"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.frame-classes">.frame-classes:</a> The protocol supports different types of allocation
frames, which are represented as &#8220;frame classes&#8221;. It&#8217;s up to pools to
determine which classes of allocation frames they support. Pools which
support more than one frame class rely on the client to indicate which
class is currently of interest. The client indicates this by means of
an operation which stores the class in the buffer to which the
allocation point is attached.</p>
<p><span class="target" id="design.mps.alloc-frame.frame-handles"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.frame-handles">.frame-handles:</a> Allocation frames are described via abstract &#8220;frame
handles&#8221;. Pools may choose what the representation of a frame handle
should be. Frame handles are static, and the client need not store
them in a GC root.</p>
<p><span class="target" id="design.mps.alloc-frame.lightweight-frames"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lightweight-frames">.lightweight-frames:</a> The design includes an extension to the
allocation point protocol, which permits the creation and destruction
of allocation frames without the necessity for claiming the arena
lock. Such frames are called &#8220;lightweight frames&#8221;.</p>
</div>
<div class="section" id="operations">
<h2>1.6. Operations<a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.alloc-frame.op.intro"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.op.intro">.op.intro:</a> Each operation has both an external (client) interface
and an internal (MPS) interface. The external function takes an
allocation point as a parameter, determines which buffer and pool it
belongs to, and calls the internal function with the buffer and pool
as parameters.</p>
<p><span class="target" id="design.mps.alloc-frame.op.obligatory"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.op.obligatory">.op.obligatory:</a> The following operations are supported on any
allocation point which supports allocation frames:-</p>
<p><span class="target" id="design.mps.alloc-frame.operation.push"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.operation.push">.operation.push:</a> The <tt class="xref c c-func docutils literal"><span class="pre">PushFrame()</span></tt> operation creates a new
allocation frame of the currently chosen frame class, makes this new
frame the current frame, and returns a handle for the frame.</p>
<p><span class="target" id="design.mps.alloc-frame.operation.pop"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.operation.pop">.operation.pop:</a> The <tt class="xref c c-func docutils literal"><span class="pre">PopFrame()</span></tt> operation takes a frame handle
as a parameter. Some pool classes might insist or assume that this is
the handle for the current frame. It finds the parent of that frame
and makes it the current frame. The operation indicates that all
children of the new current frame contain objects which are likely to
be dead. The reclaim policy is up to the pool; some classes might
insist or assume that the objects must be dead, and eagerly free them.
Note that this might introduce the possibility of leaving dangling
pointers elsewhere in the arena. If so, it&#8217;s up to the pool to decide
what to do about this.</p>
<p><span class="target" id="design.mps.alloc-frame.op.optional"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.op.optional">.op.optional:</a> The following operations are supported for some
allocation frames, but not all. Pools may choose to support some or
all of these operations for certain frame classes. An unsupported
operation will return a failure value:-</p>
<p><span class="target" id="design.mps.alloc-frame.operation.select"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.operation.select">.operation.select:</a> The <tt class="xref c c-func docutils literal"><span class="pre">SelectFrame()</span></tt> operation takes a frame
handle as a parameter and makes that frame the current frame. It does
not indicate that any children of the current frame contain objects
which are likely to be dead.</p>
<p><span class="target" id="design.mps.alloc-frame.operation.select-addr"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.operation.select-addr">.operation.select-addr:</a> The <tt class="xref c c-func docutils literal"><span class="pre">SelectFrameOfAddr()</span></tt> operation takes
an address as a parameter and makes the frame of that address the
current frame. It does not indicate that any children of the current
frame contain objects which are likely to be dead.</p>
<p><span class="target" id="design.mps.alloc-frame.operation.in-frame"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.operation.in-frame">.operation.in-frame:</a> The <tt class="xref c c-func docutils literal"><span class="pre">AddrInFrame()</span></tt> operation determines
whether the supplied address is the address of an object allocated in
the supplied frame, or any child of that frame.</p>
<p><span class="target" id="design.mps.alloc-frame.operation.set"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.operation.set">.operation.set:</a> The <tt class="xref c c-func docutils literal"><span class="pre">SetFrameClass()</span></tt> operation takes a frame
class and an allocation point as parameters, and makes that the
current frame class for the allocation point. The next <tt class="xref c c-func docutils literal"><span class="pre">PushFrame()</span></tt>
operation will create a new frame of that class.</p>
</div>
<div class="section" id="interface">
<h2>1.7. Interface<a class="headerlink" href="#interface" title="Permalink to this headline">¶</a></h2>
<div class="section" id="external-types">
<h3>1.7.1. External types<a class="headerlink" href="#external-types" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.alloc-frame.type.client.frame-handle"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.type.client.frame-handle">.type.client.frame-handle:</a> Frame handles are defined as the abstract
type <a class="reference internal" href="../topic/frame.html#mps_frame_t" title="mps_frame_t"><tt class="xref c c-type docutils literal"><span class="pre">mps_frame_t</span></tt></a>.</p>
<dl class="type">
<dt id="mps_frame_class_t">
struct mps_frame_class_s *<tt class="descname">mps_frame_class_t</tt><a class="headerlink" href="#mps_frame_class_t" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.type.client.frame-class"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.type.client.frame-class">.type.client.frame-class:</a> Frame classes are defined as an abstract
type.</p>
<p><span class="target" id="design.mps.alloc-frame.type.client.frame-class.access"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.type.client.frame-class.access">.type.client.frame-class.access:</a> Clients access frame classes by
means of dedicated functions for each frame class.</p>
</div>
<div class="section" id="external-functions">
<h3>1.7.2. External functions<a class="headerlink" href="#external-functions" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.alloc-frame.fn.client.push"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.client.push">.fn.client.push:</a> <a class="reference internal" href="../topic/frame.html#mps_ap_frame_push" title="mps_ap_frame_push"><tt class="xref c c-func docutils literal"><span class="pre">mps_ap_frame_push()</span></tt></a> is used by clients to
invoke the <tt class="xref c c-func docutils literal"><span class="pre">PushFrame()</span></tt> operation. For lightweight frames, this
might not invoke the corresponding internal function.</p>
<p><span class="target" id="design.mps.alloc-frame.fn.client.pop"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.client.pop">.fn.client.pop:</a> <a class="reference internal" href="../topic/frame.html#mps_ap_frame_pop" title="mps_ap_frame_pop"><tt class="xref c c-func docutils literal"><span class="pre">mps_ap_frame_pop()</span></tt></a> is used by clients to invoke
the <tt class="xref c c-func docutils literal"><span class="pre">PopFrame()</span></tt> operation. For lightweight frames, this might not
invoke the corresponding internal function.</p>
<dl class="function">
<dt id="mps_ap_frame_select">
<a class="reference internal" href="../topic/error.html#mps_res_t" title="mps_res_t">mps_res_t</a> <tt class="descname">mps_ap_frame_select</tt><big>(</big><a class="reference internal" href="../topic/allocation.html#mps_ap_t" title="mps_ap_t">mps_ap_t</a><em>&nbsp;buf</em>, <a class="reference internal" href="../topic/frame.html#mps_frame_t" title="mps_frame_t">mps_frame_t</a><em>&nbsp;frame</em><big>)</big><a class="headerlink" href="#mps_ap_frame_select" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.client.select"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.client.select">.fn.client.select:</a> This following function is used by clients to
invoke the <tt class="xref c c-func docutils literal"><span class="pre">SelectFrame()</span></tt> operation.</p>
<dl class="function">
<dt id="mps_ap_frame_select_from_addr">
<a class="reference internal" href="../topic/error.html#mps_res_t" title="mps_res_t">mps_res_t</a> <tt class="descname">mps_ap_frame_select_from_addr</tt><big>(</big><a class="reference internal" href="../topic/allocation.html#mps_ap_t" title="mps_ap_t">mps_ap_t</a><em>&nbsp;buf</em>, <a class="reference internal" href="../topic/interface.html#mps_addr_t" title="mps_addr_t">mps_addr_t</a><em>&nbsp;addr</em><big>)</big><a class="headerlink" href="#mps_ap_frame_select_from_addr" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.client.select-addr"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.client.select-addr">.fn.client.select-addr:</a> This function is used by clients to invoke
the <tt class="xref c c-func docutils literal"><span class="pre">SelectFrameOfAddr()</span></tt> operation.</p>
<dl class="function">
<dt id="mps_ap_addr_in_frame">
<a class="reference internal" href="../topic/error.html#mps_res_t" title="mps_res_t">mps_res_t</a> <tt class="descname">mps_ap_addr_in_frame</tt><big>(</big><a class="reference internal" href="../topic/interface.html#mps_bool_t" title="mps_bool_t">mps_bool_t</a><em>&nbsp;*inframe_o</em>, <a class="reference internal" href="../topic/allocation.html#mps_ap_t" title="mps_ap_t">mps_ap_t</a><em>&nbsp;buf</em>, <a class="reference internal" href="../topic/interface.html#mps_addr_t" title="mps_addr_t">mps_addr_t</a><em>&nbsp;*addrref</em>, <a class="reference internal" href="../topic/frame.html#mps_frame_t" title="mps_frame_t">mps_frame_t</a><em>&nbsp;frame</em><big>)</big><a class="headerlink" href="#mps_ap_addr_in_frame" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.client.in-frame"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.client.in-frame">.fn.client.in-frame:</a> This function is used by clients to invoke the
<tt class="xref c c-func docutils literal"><span class="pre">AddrInFrame()</span></tt> operation.</p>
<dl class="function">
<dt>
<tt class="descname">mps_res_t mps_ap_set_frame_class(mps_ap_t buf, mps_frame_class_t</tt></dt>
<dd></dd></dl>

<p>class)</p>
<p><span class="target" id="design.mps.alloc-frame.fn.client.set"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.client.set">.fn.client.set:</a> This function is used by clients to invoke the
<tt class="xref c c-func docutils literal"><span class="pre">SetFrameClass()</span></tt> operation.</p>
<dl class="function">
<dt id="mps_alloc_frame_class_stack">
<a class="reference internal" href="#mps_frame_class_t" title="mps_frame_class_t">mps_frame_class_t</a> <tt class="descname">mps_alloc_frame_class_stack</tt><big>(</big>void<big>)</big><a class="headerlink" href="#mps_alloc_frame_class_stack" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.client.stack-frame-class"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.client.stack-frame-class">.fn.client.stack-frame-class:</a> This function is used by clients to
access the frame class used for simple stack allocation.</p>
</div>
<div class="section" id="internal-types">
<h3>1.7.3. Internal types<a class="headerlink" href="#internal-types" title="Permalink to this headline">¶</a></h3>
<dl class="type">
<dt id="AllocFrame">
struct AllocFrameStruct *<tt class="descname">AllocFrame</tt><a class="headerlink" href="#AllocFrame" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.type.frame-handle"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.type.frame-handle">.type.frame-handle:</a> Frame handles are defined as an abstract type.</p>
<dl class="type">
<dt id="AllocFrameClass">
struct AllocFrameClassStruct *<tt class="descname">AllocFrameClass</tt><a class="headerlink" href="#AllocFrameClass" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.type.frame-class"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.type.frame-class">.type.frame-class:</a> Frame classes are defined as an abstract type.</p>
<dl class="type">
<dt id="PoolFramePushMethod">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">(*PoolFramePushMethod)</tt><big>(</big><a class="reference internal" href="#AllocFrame" title="AllocFrame">AllocFrame</a><em>&nbsp;*frameReturn</em>, Pool<em>&nbsp;pool</em>, Buffer<em>&nbsp;buf</em><big>)</big><a class="headerlink" href="#PoolFramePushMethod" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.push"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.push">.fn.push:</a> A pool method of this type is called (if needed) to
invoke the <tt class="xref c c-func docutils literal"><span class="pre">PushFrame()</span></tt> operation.</p>
<dl class="type">
<dt id="PoolFramePopMethod">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">(*PoolFramePopMethod)</tt><big>(</big>Pool<em>&nbsp;pool</em>, Buffer<em>&nbsp;buf</em>, <a class="reference internal" href="#AllocFrame" title="AllocFrame">AllocFrame</a><em>&nbsp;frame</em><big>)</big><a class="headerlink" href="#PoolFramePopMethod" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.pop"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.pop">.fn.pop:</a> A pool method of this type is called (if needed)
to invoke the PopFrame operation:</p>
<dl class="type">
<dt id="PoolFrameSelectMethod">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">(*PoolFrameSelectMethod)</tt><big>(</big>Pool<em>&nbsp;pool</em>, Buffer<em>&nbsp;buf</em>, <a class="reference internal" href="#AllocFrame" title="AllocFrame">AllocFrame</a><em>&nbsp;frame</em><big>)</big><a class="headerlink" href="#PoolFrameSelectMethod" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.select"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.select">.fn.select:</a> A pool method of this type is called to invoke the
<tt class="xref c c-func docutils literal"><span class="pre">SelectFrame()</span></tt> operation.</p>
<dl class="type">
<dt id="PoolFrameSelectFromAddrMethod">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">(*PoolFrameSelectFromAddrMethod)</tt><big>(</big>Pool<em>&nbsp;pool</em>, Buffer<em>&nbsp;buf</em>, <a class="reference internal" href="type.html#Addr" title="Addr">Addr</a><em>&nbsp;addr</em><big>)</big><a class="headerlink" href="#PoolFrameSelectFromAddrMethod" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.select-addr"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.select-addr">.fn.select-addr:</a> A pool method of this type is called to invoke the
<tt class="xref c c-func docutils literal"><span class="pre">SelectFrameOfAddr()</span></tt> operation.</p>
<dl class="type">
<dt id="PoolAddrInFrameMethod">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">(*PoolAddrInFrameMethod)</tt><big>(</big><a class="reference internal" href="type.html#Bool" title="Bool">Bool</a><em>&nbsp;*inframeReturn</em>, Pool<em>&nbsp;pool</em>, <a class="reference internal" href="seg.html#Seg" title="Seg">Seg</a><em>&nbsp;seg</em>, <a class="reference internal" href="type.html#Addr" title="Addr">Addr</a><em>&nbsp;*addrref</em>, <a class="reference internal" href="#AllocFrame" title="AllocFrame">AllocFrame</a><em>&nbsp;frame</em><big>)</big><a class="headerlink" href="#PoolAddrInFrameMethod" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.in-frame"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.in-frame">.fn.in-frame:</a> A pool method of this type is called to invoke the
<tt class="xref c c-func docutils literal"><span class="pre">AddrInFrame()</span></tt> operation.</p>
<dl class="type">
<dt id="PoolSetFrameClassMethod">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">(*PoolSetFrameClassMethod)</tt><big>(</big>Pool<em>&nbsp;pool</em>, Buffer<em>&nbsp;buf</em>, <a class="reference internal" href="#AllocFrameClass" title="AllocFrameClass">AllocFrameClass</a><em>&nbsp;class</em><big>)</big><a class="headerlink" href="#PoolSetFrameClassMethod" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.alloc-frame.fn.set"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.fn.set">.fn.set:</a> A pool method of this type is called to invoke the
<tt class="xref c c-func docutils literal"><span class="pre">SetFrameClass()</span></tt> operation.</p>
</div>
</div>
<div class="section" id="lightweight-frames">
<h2>1.8. Lightweight frames<a class="headerlink" href="#lightweight-frames" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>1.8.1. Overview<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.overview"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.overview">.lw-frame.overview:</a> Allocation points provide direct support for
lightweight frames, and are designed to permit PushFrame and PopFrame
operations without the need for locking and delegation to the pool
method. Pools can disable this mechanism for any allocation point, so
that the pool method is always called. The pool method will be called
whenever synchronization is required for other reasons (e.g. the
buffer is tripped).</p>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.model"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.model">.lw-frame.model:</a> Lightweight frames offer direct support for a
particular model of allocation frame use, whereby the PushFrame
operation returns the current allocation pointer as a frame handle,
and the PopFrame operation causes the allocation pointer to be reset
to the address of the frame handle. This model should be suitable for
simple stack frames, where more advanced operations like SelectFrame
are not supported. It may also be suitable for more advanced
allocation frame models when they are being used simply. The use of a
complex operation always involves synchronization via locking, and the
pool may disable lightweight synchronization temporarily at this time.</p>
</div>
<div class="section" id="state">
<h3>1.8.2. State<a class="headerlink" href="#state" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.states"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.states">.lw-frame.states:</a> Allocation points supporting lightweight frames
will be in one of the following states:</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Valid</td>
<td>Indicates that <tt class="xref c c-func docutils literal"><span class="pre">PushFrame()</span></tt> can be a lightweight
operation and need not be synchronized.</td>
</tr>
<tr class="row-even"><td>PopPending</td>
<td>Indicates that there has been a <tt class="xref c c-func docutils literal"><span class="pre">PopFrame()</span></tt> operation
that the pool must respond to.</td>
</tr>
<tr class="row-odd"><td>Disabled</td>
<td>Indicates that the pool has disabled support for lightweight
operations for this AP.</td>
</tr>
</tbody>
</table>
<p>These states are in addition to the state normally held by an AP for
allocation purposes. An AP will be in the Disabled state at creation.</p>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.transitions"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.transitions">.lw-frame.transitions:</a> State transitions happen under the following
circumstances:</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="69%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Valid → PopPending</td>
<td>As a result of a client <tt class="xref c c-func docutils literal"><span class="pre">PopFrame()</span></tt>
operation.</td>
</tr>
<tr class="row-even"><td>Valid → Disabled</td>
<td>At the choice of the pool (for example, when
responding to a <tt class="xref c c-func docutils literal"><span class="pre">SelectFrame()</span></tt> operation).</td>
</tr>
<tr class="row-odd"><td>PopPending → Valid</td>
<td>At the choice of the pool, when processing a
<tt class="xref c c-func docutils literal"><span class="pre">PopFrame()</span></tt>.</td>
</tr>
<tr class="row-even"><td>PopPending → Disabled</td>
<td>At the choice of the pool, when processing a
<tt class="xref c c-func docutils literal"><span class="pre">PopFrame()</span></tt>.</td>
</tr>
<tr class="row-odd"><td>Disabled → Valid</td>
<td>At the choice of the pool.</td>
</tr>
<tr class="row-even"><td>Disabled → Popframe</td>
<td>Illegal.</td>
</tr>
</tbody>
</table>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.state-impl"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.state-impl">.lw-frame.state-impl:</a> Each AP contains 3 additional fields to hold this state:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">mps_addr_t</span> <span class="n">frameptr</span><span class="p">;</span>
<span class="kt">mps_bool_t</span> <span class="n">enabled</span><span class="p">;</span>
<span class="kt">mps_bool_t</span> <span class="n">lwPopPending</span><span class="p">;</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.enabled"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.enabled">.lw-frame.enabled:</a> The <tt class="docutils literal"><span class="pre">enabled</span></tt> slot holds the following values for
each state:</p>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="62%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Valid</td>
<td><tt class="xref c c-macro docutils literal"><span class="pre">TRUE</span></tt></td>
</tr>
<tr class="row-even"><td>PopPending</td>
<td><tt class="xref c c-macro docutils literal"><span class="pre">TRUE</span></tt></td>
</tr>
<tr class="row-odd"><td>Disabled</td>
<td><tt class="xref c c-macro docutils literal"><span class="pre">FALSE</span></tt></td>
</tr>
</tbody>
</table>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.frameptr"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.frameptr">.lw-frame.frameptr:</a> The <tt class="docutils literal"><span class="pre">frameptr</span></tt> slot holds the following values
for each state:</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Valid</td>
<td><tt class="xref c c-macro docutils literal"><span class="pre">NULL</span></tt></td>
</tr>
<tr class="row-even"><td>PopPending</td>
<td>Frame handle for most recently popped frame.</td>
</tr>
<tr class="row-odd"><td>Disabled</td>
<td><tt class="xref c c-macro docutils literal"><span class="pre">NULL</span></tt></td>
</tr>
</tbody>
</table>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.lwPopPending"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.lwPopPending">.lw-frame.lwPopPending:</a> The <tt class="docutils literal"><span class="pre">lwPopPending</span></tt> slot holds the
following values for each state:</p>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="62%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Valid</td>
<td><tt class="xref c c-macro docutils literal"><span class="pre">FALSE</span></tt></td>
</tr>
<tr class="row-even"><td>PopPending</td>
<td><tt class="xref c c-macro docutils literal"><span class="pre">TRUE</span></tt></td>
</tr>
<tr class="row-odd"><td>Disabled</td>
<td><tt class="xref c c-macro docutils literal"><span class="pre">FALSE</span></tt></td>
</tr>
</tbody>
</table>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.state-for-gc"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.state-for-gc">.lw-frame.state-for-gc:</a> It is not necessary for the tracer, format
code, pool, or any other part of the GC support in MPS to read either
of the two additional AP fields in order to scan a segment which
supports a lightweight allocation frame.</p>
</div>
<div class="section" id="synchronization">
<h3>1.8.3. Synchronization<a class="headerlink" href="#synchronization" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.sync"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.sync">.lw-frame.sync:</a> The purpose of the design is that mutator may
access the state of an AP without locking with MPS (via the external
functions). The design assumes the normal MPS restriction that an
operation on an AP may only be performed by a single mutator thread at
a time. Each of the operations on allocation frames counts as an
operation on an AP.</p>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.sync.pool"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.sync.pool">.lw-frame.sync.pool:</a> Pools are permitted to read or modify the
lightweight frame state of an AP only in response to an operation on
that AP.</p>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.sync.external"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.sync.external">.lw-frame.sync.external:</a> The external functions
<a class="reference internal" href="../topic/frame.html#mps_ap_frame_push" title="mps_ap_frame_push"><tt class="xref c c-func docutils literal"><span class="pre">mps_ap_frame_push()</span></tt></a> and <a class="reference internal" href="../topic/frame.html#mps_ap_frame_pop" title="mps_ap_frame_pop"><tt class="xref c c-func docutils literal"><span class="pre">mps_ap_frame_pop()</span></tt></a> are permitted to
read the values of the <tt class="docutils literal"><span class="pre">enabled</span></tt> and <tt class="docutils literal"><span class="pre">frameptr</span></tt> fields for the
supplied AP without claiming the arena lock. They are permitted to
modify the <tt class="docutils literal"><span class="pre">frameptr</span></tt> field if and only if <tt class="docutils literal"><span class="pre">enabled</span> <span class="pre">==</span> <span class="pre">FALSE</span></tt>.</p>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.sync.trip"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.sync.trip">.lw-frame.sync.trip:</a> When a buffer trip happens, and the trap
wasn&#8217;t set by MPS itself (that is, it wasn&#8217;t because of a flip or for
logging), then the buffer code must check whether the AP has state
PopPending. If it does, the buffer code must call the Pool.</p>
</div>
<div class="section" id="implementation">
<h3>1.8.4. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.push"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.push">.lw-frame.push:</a> The external <tt class="xref c c-func docutils literal"><span class="pre">PushFrame()</span></tt> operation
(<a class="reference internal" href="../topic/frame.html#mps_ap_frame_push" title="mps_ap_frame_push"><tt class="xref c c-func docutils literal"><span class="pre">mps_ap_frame_push()</span></tt></a>) performs the following operations:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">IF</span> <span class="p">(</span><span class="o">!</span><span class="n">APIsTrapped</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">StateOfFrame</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">==</span> <span class="n">Valid</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">==</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span>
   <span class="o">*</span><span class="n">frame_o</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>
<span class="n">ELSE</span>
  <span class="n">WITH_ARENA_LOCK</span>
    <span class="n">PerformInternalPushFrameOperation</span><span class="p">(...)</span>
  <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.alloc-frame.lw-frame.pop"></span><a class="mpstag reference internal" href="#design.mps.alloc-frame.lw-frame.pop">.lw-frame.pop:</a> The external <tt class="xref c c-func docutils literal"><span class="pre">PopFrame()</span></tt> operation
(<a class="reference internal" href="../topic/frame.html#mps_ap_frame_pop" title="mps_ap_frame_pop"><tt class="xref c c-func docutils literal"><span class="pre">mps_ap_frame_pop()</span></tt></a>) performs the following operations:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">IF</span> <span class="p">(</span><span class="n">StateOfFrame</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Disabled</span><span class="p">)</span>
  <span class="n">TrapAP</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>  <span class="cm">/* ensure next allocation or push involves the pool */</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">frameptr</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">lwpopPending</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
  <span class="n">WITH_ARENA_LOCK</span>
    <span class="n">PerformInternalPopFrameOperation</span><span class="p">(...)</span>
  <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1. Allocation frame protocol</a><ul>
<li><a class="reference internal" href="#introduction">1.1. Introduction</a></li>
<li><a class="reference internal" href="#definitions">1.2. Definitions</a></li>
<li><a class="reference internal" href="#purpose">1.3. Purpose</a></li>
<li><a class="reference internal" href="#requirements">1.4. Requirements</a><ul>
<li><a class="reference internal" href="#known-requirements">1.4.1. Known requirements</a></li>
<li><a class="reference internal" href="#proto-requirements">1.4.2. Proto-requirements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#overview">1.5. Overview</a></li>
<li><a class="reference internal" href="#operations">1.6. Operations</a></li>
<li><a class="reference internal" href="#interface">1.7. Interface</a><ul>
<li><a class="reference internal" href="#external-types">1.7.1. External types</a></li>
<li><a class="reference internal" href="#external-functions">1.7.2. External functions</a></li>
<li><a class="reference internal" href="#internal-types">1.7.3. Internal types</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lightweight-frames">1.8. Lightweight frames</a><ul>
<li><a class="reference internal" href="#id1">1.8.1. Overview</a></li>
<li><a class="reference internal" href="#state">1.8.2. State</a></li>
<li><a class="reference internal" href="#synchronization">1.8.3. Synchronization</a></li>
<li><a class="reference internal" href="#implementation">1.8.4. Implementation</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="old.html"
                        title="previous chapter">Old design</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="arena.html"
                        title="next chapter">2. Arena</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="arena.html" title="2. Arena"
             >next</a> |</li>
        <li class="right" >
          <a href="old.html" title="Old design"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" >Old design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>