

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>51. VM for Solaris &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Old design" href="old.html" />
    <link rel="next" title="52. The WriteF function" href="writef.html" />
    <link rel="prev" title="50. VM for Digital Unix" href="vmo1.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="writef.html" title="52. The WriteF function"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="vmo1.html" title="50. VM for Digital Unix"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" accesskey="U">Old design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <span class="target" id="design-vmso"></span><div class="section" id="vm-for-solaris">
<span id="index-0"></span><h1>51. VM for Solaris<a class="headerlink" href="#vm-for-solaris" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning" id="design.mps.vmso">
<p class="first admonition-title">Warning</p>
<p class="last">As of 2013-05-26, the MPS is no longer supported on Solaris, so
this document is only of historical interest.</p>
</div>
<div class="section" id="introduction">
<h2>51.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.vmso.intro"></span><a class="mpstag reference internal" href="#design.mps.vmso.intro">.intro:</a> This is the design for the VM implementation on Solaris 2.x
(see os.so for OS details). The implementation is in MMsrc!vmso.c
(impl.c.vm). The design follows the design for and implements the
contract of the generic VM interface (design.mps.vm). To summarize:
The VM module provides a mechanism to reserve large (relative to the
amount of RAM) amounts of address space, and functions to map (back
with RAM) and unmap portions of this address space.</p>
<p><span class="target" id="design.mps.vmso.source"></span><a class="mpstag reference internal" href="#design.mps.vmso.source">.source:</a> Much of the implementation (and hence the design) was
inherited from the SunOS4 implementation. Not that there&#8217;s any design
for that. You&#8217;ll find the <tt class="docutils literal"><span class="pre">mmap(2)</span></tt> (for the system call <tt class="xref c c-func docutils literal"><span class="pre">mmap()</span></tt>)
and the <tt class="docutils literal"><span class="pre">zero(7d)</span></tt> (for the device <tt class="docutils literal"><span class="pre">/dev/zero</span></tt>) man pages useful
as well. The generic interface and some generic design is in
design.mps.vm.</p>
</div>
<div class="section" id="definitions">
<h2>51.2. Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.vmso.def"></span><a class="mpstag reference internal" href="#design.mps.vmso.def">.def:</a> See design.mps.vm.def.* for definitions common to all VMs.</p>
</div>
<div class="section" id="overview">
<h2>51.3. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.vmso.over"></span><a class="mpstag reference internal" href="#design.mps.vmso.over">.over:</a> The system calls <tt class="xref c c-func docutils literal"><span class="pre">mmap()</span></tt> and <tt class="xref c c-func docutils literal"><span class="pre">munmap()</span></tt> are used to
access the underlying functionality. They are used in slightly unusual
ways, typically to overcome baroque features or implementation details
of the operating system.</p>
<p><span class="target" id="design.mps.vmso.over.reserve"></span><a class="mpstag reference internal" href="#design.mps.vmso.over.reserve">.over.reserve:</a> In order to reserve address space, a mapping to a
file (<tt class="docutils literal"><span class="pre">/etc/passwd</span></tt> as it happens) is created with no protection
allowed.</p>
<p><span class="target" id="design.mps.vmso.over.map"></span><a class="mpstag reference internal" href="#design.mps.vmso.over.map">.over.map:</a> In order to map memory, a mapping to <tt class="docutils literal"><span class="pre">/dev/zero</span></tt> is
created.</p>
<p><span class="target" id="design.mps.vmso.over.destroy"></span><a class="mpstag reference internal" href="#design.mps.vmso.over.destroy">.over.destroy:</a> When the VM is destroyed, <tt class="xref c c-func docutils literal"><span class="pre">munmap()</span></tt> is used to
remove all the mappings previously created.</p>
</div>
<div class="section" id="implementation">
<h2>51.4. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.vmso.impl.create"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.create">.impl.create:</a> <a class="reference internal" href="vm.html#VMCreate" title="VMCreate"><tt class="xref c c-func docutils literal"><span class="pre">VMCreate()</span></tt></a></p>
<p><span class="target" id="design.mps.vmso.impl.create.vmstruct"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.create.vmstruct">.impl.create.vmstruct:</a> Enough pages to hold the <tt class="xref c c-type docutils literal"><span class="pre">VMStruct</span></tt> are
allocated by creating a mapping to <tt class="docutils literal"><span class="pre">/dev/zero</span></tt> (a read/write private
mapping), and using initializing the memory as a <tt class="xref c c-type docutils literal"><span class="pre">VMStruct</span></tt>.</p>
<p><span class="target" id="design.mps.vmso.impl.create.reserve"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.create.reserve">.impl.create.reserve:</a> The size parameter is rounded up to page size
and this amount of address space is reserved. The address space is
reserved by creating a shared mapping to <tt class="docutils literal"><span class="pre">/etc/passwd</span></tt> with no
access allowed (the <tt class="docutils literal"><span class="pre">prot</span></tt> argument is <tt class="xref c c-macro docutils literal"><span class="pre">PROT_NONE</span></tt>, and the
<tt class="docutils literal"><span class="pre">flags</span></tt> argument is <tt class="xref c c-macro docutils literal"><span class="pre">MAP_SHARED</span></tt>).</p>
<p><span class="target" id="design.mps.vmso.impl.create.reserve.mmap.justify"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.create.reserve.mmap.justify">.impl.create.reserve.mmap.justify:</a> <tt class="xref c c-func docutils literal"><span class="pre">mmap()</span></tt> gives us a flexible
way to allocate address space without interfering with any other
component in the process. Because we don&#8217;t specify <tt class="xref c c-macro docutils literal"><span class="pre">MAP_FIXED</span></tt> we
are guaranteed to get a range of addresses that are not in use. Other
components must cooperate by not attempting to create mappings
specifying <tt class="xref c c-macro docutils literal"><span class="pre">MAP_FIXED</span></tt> and an address in the range that the MPS has
reserved.</p>
<p><span class="target" id="design.mps.vmso.impl.create.reserve.passwd.justify"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.create.reserve.passwd.justify">.impl.create.reserve.passwd.justify:</a> Mapping <tt class="docutils literal"><span class="pre">/etc/passwd</span></tt> like
this worked on SunOS&nbsp;4 (so this implementation inherited it). Mapping
<tt class="docutils literal"><span class="pre">/dev/zero</span></tt> with <tt class="docutils literal"><span class="pre">prot=PROT_NONE</span></tt> and <tt class="docutils literal"><span class="pre">flags=MAP_PRIVATE</span></tt> does
not work because Solaris gratuitously allocates swap (even though you
can&#8217;t use the memory).</p>
<p><span class="target" id="design.mps.vmso.impl.create.reserve.improve"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.create.reserve.improve">.impl.create.reserve.improve:</a> However, it would appears that or-ing
in <tt class="xref c c-macro docutils literal"><span class="pre">MAP_NORESERVE</span></tt> mapping <tt class="docutils literal"><span class="pre">/dev/zero</span></tt> will reserve address space
without allocating swap, so this might be worth trying. That is, with
<tt class="docutils literal"><span class="pre">prot=PROT_NONE</span></tt> and <tt class="docutils literal"><span class="pre">flags=MAP_PRIVATE|MAP_NORESERVE</span></tt>. However
the following caveat comes from the original implementation:
&#8220;Experiments have shown that attempting to reserve address space by
mapping <tt class="docutils literal"><span class="pre">/dev/zero</span></tt> results in swap being reserved. This appears to
be a bug, so we work round it by using <tt class="docutils literal"><span class="pre">/etc/passwd</span></tt>, the only file
we can think of which is pretty much guaranteed to be around.&#8221; So that
might not work after all.</p>
<p><span class="target" id="design.mps.vmso.impl.map"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.map">.impl.map:</a> <tt class="xref c c-func docutils literal"><span class="pre">VMMap()</span></tt></p>
<p><span class="target" id="design.mps.vmso.impl.map.zero"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.map.zero">.impl.map.zero:</a> A mapping to <tt class="docutils literal"><span class="pre">/dev/zero</span></tt> is created at the
relevant addresses (overriding the map to <tt class="docutils literal"><span class="pre">/etc/passwd</span></tt> that was
previously in place for those addresses). The <tt class="docutils literal"><span class="pre">prot</span></tt> argument is
specified as <tt class="docutils literal"><span class="pre">PROT_READ|PROT_WRITE|PROT_EXEC</span></tt> (so that any access is
allowed), the <tt class="docutils literal"><span class="pre">flags</span></tt> argument as <tt class="docutils literal"><span class="pre">MAP_PRIVATE|MAP_FIXED</span></tt>. The
flag <tt class="xref c c-macro docutils literal"><span class="pre">MAP_PRIVATE</span></tt> means that the mapping is not shared with child
processes (child processes will have a mapping, but changes to the
memory will not be shared). The flag <tt class="xref c c-macro docutils literal"><span class="pre">MAP_FIXED</span></tt> guarantees that we
get the mapping at the specified address). The <tt class="docutils literal"><span class="pre">zero(7d)</span></tt> man page
documents this as a way to create a &#8220;zero-initialized unnamed memory
object&#8221;.</p>
<p><span class="target" id="design.mps.vmso.impl.map.error"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.map.error">.impl.map.error:</a> If there&#8217;s not enough swap space for the mapping,
<tt class="xref c c-func docutils literal"><span class="pre">mmap()</span></tt> will return <tt class="xref c c-macro docutils literal"><span class="pre">EAGAIN</span></tt>, not <tt class="xref c c-macro docutils literal"><span class="pre">ENOMEM</span></tt>, although you might
not think so from the man page.</p>
<p><span class="target" id="design.mps.vmso.impl.unmap"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.unmap">.impl.unmap:</a> <tt class="xref c c-func docutils literal"><span class="pre">VMUnmap()</span></tt></p>
<p><span class="target" id="design.mps.vmso.impl.unmap.reserve"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.unmap.reserve">.impl.unmap.reserve:</a> The relevant addresses are returned to the
reserved state by creating a mapping to <tt class="docutils literal"><span class="pre">/etc/passwd</span></tt> (overriding
the map <tt class="docutils literal"><span class="pre">/dev/zero</span></tt> that was previously in place for those
addresses). As for <a class="reference internal" href="vm.html#VMCreate" title="VMCreate"><tt class="xref c c-func docutils literal"><span class="pre">VMCreate()</span></tt></a> (see <a class="reference internal" href="#design.mps.vmso.impl.create.reserve">.impl.create.reserve</a> above)
the <tt class="docutils literal"><span class="pre">prot</span></tt> argument is <tt class="xref c c-macro docutils literal"><span class="pre">PROT_NONE</span></tt>, but the <tt class="docutils literal"><span class="pre">flags</span></tt> argument has
the addition <tt class="xref c c-macro docutils literal"><span class="pre">MAP_FIXED</span></tt> flags (so is <tt class="docutils literal"><span class="pre">MAP_SHARED|MAP_FIXED</span></tt>).</p>
<p><span class="target" id="design.mps.vmso.impl.unmap.reserve.offset"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.unmap.reserve.offset">.impl.unmap.reserve.offset:</a> The offset argument is specified to be
the offset of the addresses being unmapped from the base of the
reserved VM area.</p>
<p><span class="target" id="design.mps.vmso.impl.unmap.reserve.offset.justify"></span><a class="mpstag reference internal" href="#design.mps.vmso.impl.unmap.reserve.offset.justify">.impl.unmap.reserve.offset.justify:</a> Not specifying the offset like
this makes Solaris create a separate mapping (in the kernel) each time
Unmap is used, eventually the call to <tt class="xref c c-func docutils literal"><span class="pre">mmap()</span></tt> will fail. Specifying
offset like this does not cause Solaris to create any extra mappings,
the existing mapping to <tt class="docutils literal"><span class="pre">/etc/passwd</span></tt> gets reused.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">51. VM for Solaris</a><ul>
<li><a class="reference internal" href="#introduction">51.1. Introduction</a></li>
<li><a class="reference internal" href="#definitions">51.2. Definitions</a></li>
<li><a class="reference internal" href="#overview">51.3. Overview</a></li>
<li><a class="reference internal" href="#implementation">51.4. Implementation</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="vmo1.html"
                        title="previous chapter">50. VM for Digital Unix</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="writef.html"
                        title="next chapter">52. The WriteF function</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="writef.html" title="52. The WriteF function"
             >next</a> |</li>
        <li class="right" >
          <a href="vmo1.html" title="50. VM for Digital Unix"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" >Old design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>