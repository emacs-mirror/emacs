

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>13. I/O subsystem &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Old design" href="old.html" />
    <link rel="next" title="14. Library interface" href="lib.html" />
    <link rel="prev" title="12. C interface design" href="interface-c.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="lib.html" title="14. Library interface"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="interface-c.html" title="12. C interface design"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" accesskey="U">Old design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="i-o-subsystem">
<span id="design-io"></span><span id="index-0"></span><h1>13. I/O subsystem<a class="headerlink" href="#i-o-subsystem" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.io"></span><h2>13.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.io.intro"></span><a class="mpstag reference internal" href="#design.mps.io.intro">.intro:</a> This document is the design of the MPS I/O Subsystem, a
part of the plinth.</p>
<p><span class="target" id="design.mps.io.readership"></span><a class="mpstag reference internal" href="#design.mps.io.readership">.readership:</a> This document is intended for MPS developers.</p>
</div>
<div class="section" id="background">
<h2>13.2. Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.io.bg"></span><a class="mpstag reference internal" href="#design.mps.io.bg">.bg:</a> This design is partly based on the design of the Internet User
Datagram Protocol (UDP). Mainly I used this to make sure I hadn&#8217;t left
out anything which we might need.</p>
</div>
<div class="section" id="purpose">
<h2>13.3. Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.io.purpose"></span><a class="mpstag reference internal" href="#design.mps.io.purpose">.purpose:</a> The purpose of the MPS I/O Subsystem is to provide a
means to measure, debug, control, and test a memory manager build
using the MPS.</p>
<p><span class="target" id="design.mps.io.purpose.measure"></span><a class="mpstag reference internal" href="#design.mps.io.purpose.measure">.purpose.measure:</a> Measurement consists of emitting data which can
be collected and analysed in order to improve the attributes of
application program, quite possibly by adjusting parameters of the
memory manager (see overview.mps.usage).</p>
<p><span class="target" id="design.mps.io.purpose.control"></span><a class="mpstag reference internal" href="#design.mps.io.purpose.control">.purpose.control:</a> Control means adjusting the behaviour of the MM
dynamically. For example, one might want to adjust a parameter in
order to observe the effect, then transfer that adjustment to the
client application later.</p>
<p><span class="target" id="design.mps.io.purpose.test"></span><a class="mpstag reference internal" href="#design.mps.io.purpose.test">.purpose.test:</a> Test output can be used to ensure that the memory
manager is behaving as expected in response to certain inputs.</p>
</div>
<div class="section" id="requirements">
<h2>13.4. Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<div class="section" id="general">
<h3>13.4.1. General<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.io.req.fun.non-hosted"></span><a class="mpstag reference internal" href="#design.mps.io.req.fun.non-hosted">.req.fun.non-hosted:</a> The MPM must be a host-independent system.</p>
<p><span class="target" id="design.mps.io.req.attr.host"></span><a class="mpstag reference internal" href="#design.mps.io.req.attr.host">.req.attr.host:</a> It should be easy for the client to set up the MPM
for a particular host (such as a washing machine).</p>
</div>
<div class="section" id="functional">
<h3>13.4.2. Functional<a class="headerlink" href="#functional" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.io.req.fun.measure"></span><a class="mpstag reference internal" href="#design.mps.io.req.fun.measure">.req.fun.measure:</a> The subsystem must allow the MPS to transmit
quantitative measurement data to an external tool so that the system
can be tuned.</p>
<p><span class="target" id="design.mps.io.req.fun.debug"></span><a class="mpstag reference internal" href="#design.mps.io.req.fun.debug">.req.fun.debug:</a> The subsystem must allow the MPS to transmit
qualitative information about its operation to an external tool so
that the system can be debugged.</p>
<p><span class="target" id="design.mps.io.req.fun.control"></span><a class="mpstag reference internal" href="#design.mps.io.req.fun.control">.req.fun.control:</a> The subsystem must allow the MPS to receive
control information from an external tool so that the system can be
adjusted while it is running.</p>
<p><span class="target" id="design.mps.io.req.dc.env.no-net"></span><a class="mpstag reference internal" href="#design.mps.io.req.dc.env.no-net">.req.dc.env.no-net:</a> The subsystem should operate in environments
where there is no networking available.</p>
<p><span class="target" id="design.mps.io.req.dc.env.no-fs"></span><a class="mpstag reference internal" href="#design.mps.io.req.dc.env.no-fs">.req.dc.env.no-fs:</a> The subsystem should operate in environments
where there is no filesystem available.</p>
</div>
</div>
<div class="section" id="architecture">
<h2>13.5. Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.io.arch.diagram"></span><a class="mpstag reference internal" href="#design.mps.io.arch.diagram">.arch.diagram:</a> I/O Architecture Diagram</p>
<p>[missing diagram]</p>
<p><span class="target" id="design.mps.io.arch.int"></span><a class="mpstag reference internal" href="#design.mps.io.arch.int">.arch.int:</a> The I/O Interface is a C function call interface by
which the MPM sends and receives &#8220;messages&#8221; to and from the hosted I/O
module.</p>
<p><span class="target" id="design.mps.io.arch.module"></span><a class="mpstag reference internal" href="#design.mps.io.arch.module">.arch.module:</a> The modules are part of the MPS but not part of the
freestanding core system (see design.mps.exec-env). The I/O module is
responsible for transmitting those messages to the external tools, and
for receiving messages from external tools and passing them to the
MPM.</p>
<p><span class="target" id="design.mps.io.arch.module.example"></span><a class="mpstag reference internal" href="#design.mps.io.arch.module.example">.arch.module.example:</a> For example, the &#8220;file implementation&#8221; might
just send/write telemetry messages into a file so that they can be
received/read later by an off-line measurement tool.</p>
<p><span class="target" id="design.mps.io.arch.external"></span><a class="mpstag reference internal" href="#design.mps.io.arch.external">.arch.external:</a> The I/O Interface is part of interface to the
freestanding core system (see design.mps.exec-env). This is so that
the MPS can be deployed in a freestanding environment, with a special
I/O module. For example, if the MPS is used in a washing machine the
I/O module could communicate by writing output to the seven-segment
display.</p>
<div class="section" id="example-configurations">
<h3>13.5.1. Example configurations<a class="headerlink" href="#example-configurations" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.io.example.telnet"></span><a class="mpstag reference internal" href="#design.mps.io.example.telnet">.example.telnet:</a> This shows the I/O subsystem communicating with a
telnet client over a TCP/IP connection. In this case, the I/O
subsystem is translating the I/O Interface into an interactive text
protocol so that the user of the telnet client can talk to the MM.</p>
<p>[missing diagram]</p>
<p><span class="target" id="design.mps.io.example.file"></span><a class="mpstag reference internal" href="#design.mps.io.example.file">.example.file:</a> This shows the I/O subsystem dumping measurement
data into a file which is later read and analysed. In this case the
I/O subsystem is simply writing out binary in a format which can be
decoded.</p>
<p>[missing diagram]</p>
<p><span class="target" id="design.mps.io.example.serial"></span><a class="mpstag reference internal" href="#design.mps.io.example.serial">.example.serial:</a> This shows the I/O subsystem communicating with a
graphical analysis tool over a serial link. This could be useful for a
developer who has two machines in close proximity and no networking
support.</p>
<p><span class="target" id="design.mps.io.example.local"></span><a class="mpstag reference internal" href="#design.mps.io.example.local">.example.local:</a> In this example the application is talking directly
to the I/O subsystem. This is useful when the application is a
reflective development environment (such as MLWorks) which wants to
observe its own behaviour.</p>
<p>[missing diagram]</p>
</div>
</div>
<div class="section" id="interface">
<h2>13.6. Interface<a class="headerlink" href="#interface" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.io.if.msg"></span><a class="mpstag reference internal" href="#design.mps.io.if.msg">.if.msg:</a> The I/O interface is oriented around opaque binary
&#8220;messages&#8221; which the I/O module must pass between the MPM and external
tools. The I/O module need not understand or interpret the contents of
those messages.</p>
<p><span class="target" id="design.mps.io.if.msg.opaque"></span><a class="mpstag reference internal" href="#design.mps.io.if.msg.opaque">.if.msg.opaque:</a> The messages are opaque in order to minimize the
dependency of the I/O module on the message internals. It should be
possible for clients to implement their own I/O modules for unusual
environments. We do not want to reveal the internal structure of our
data to the clients. Nor do we want to burden them with the details of
our protocols. We&#8217;d also like their code to be independent of ours, so
that we can expand or change the protocols without requiring them to
modify their modules.</p>
<p><span class="target" id="design.mps.io.if.msg.dgram"></span><a class="mpstag reference internal" href="#design.mps.io.if.msg.dgram">.if.msg.dgram:</a> Neither the MPM nor the external tools should assume
that the messages will be delivered in finite time, exactly once, or
in order. This will allow the I/O modules to be implemented using
unreliable transport layers such as the Internet User Datagram Protocl
(UDP). It will also give the I/O module the freedom to drop
information rather than block on a congested network, or stop the
memory manager when the disk is full, or similar events which really
shouldn&#8217;t cause the memory manager to stop working. The protocols we
need to implement at the high level can be design to be robust against
lossage without much difficulty.</p>
<div class="section" id="i-o-module-state">
<h3>13.6.1. I/O module state<a class="headerlink" href="#i-o-module-state" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.io.if.state"></span><a class="mpstag reference internal" href="#design.mps.io.if.state">.if.state:</a> The I/O module may have some internal state to preserve.
The I/O Interface defines a type for this state, <a class="reference internal" href="../topic/plinth.html#mps_io_t" title="mps_io_t"><tt class="xref c c-type docutils literal"><span class="pre">mps_io_t</span></tt></a>, a
pointer to an incomplete structure <tt class="xref c c-type docutils literal"><span class="pre">mps_io_s</span></tt>. The I/O module is at
liberty to define this structure.</p>
</div>
<div class="section" id="message-types">
<h3>13.6.2. Message types<a class="headerlink" href="#message-types" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.io.if.type"></span><a class="mpstag reference internal" href="#design.mps.io.if.type">.if.type:</a> The I/O module must be able to deliver messages of
several different types. It will probably choose to send them to
different destinations based on their type: telemetry to the
measurement tool, debugging output to the debugger, etc.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="kt">int</span> <span class="n">mps_io_type_t</span><span class="p">;</span>
<span class="k">enum</span> <span class="p">{</span>
  <span class="n">MPS_IO_TYPE_TELEMETRY</span><span class="p">,</span>
  <span class="n">MPS_IO_TYPE_DEBUG</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="limits">
<h3>13.6.3. Limits<a class="headerlink" href="#limits" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.io.if.message-max"></span><a class="mpstag reference internal" href="#design.mps.io.if.message-max">.if.message-max:</a> The interface will define an unsigned integral
constant <tt class="xref c c-macro docutils literal"><span class="pre">MPS_IO_MESSAGE_MAX</span></tt> which will be the maximum size of
messages that the MPM will pass to <a class="reference internal" href="#mps_io_send" title="mps_io_send"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_send()</span></tt></a> (<a class="reference internal" href="#design.mps.io.if.send">.if.send</a>) and
the maximum size it will expect to receive from <a class="reference internal" href="#mps_io_receive" title="mps_io_receive"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_receive()</span></tt></a>.</p>
</div>
<div class="section" id="interface-set-up-and-tear-down">
<h3>13.6.4. Interface set-up and tear-down<a class="headerlink" href="#interface-set-up-and-tear-down" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.io.if.create"></span><a class="mpstag reference internal" href="#design.mps.io.if.create">.if.create:</a> The MPM will call <a class="reference internal" href="../topic/plinth.html#mps_io_create" title="mps_io_create"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_create()</span></tt></a> to set up the I/O
module. On success, this function should return <a class="reference internal" href="../topic/error.html#MPS_RES_OK" title="MPS_RES_OK"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_RES_OK</span></tt></a>. It may
also initialize a &#8220;state&#8221; value which will be passed to subsequent
calls through the interface.</p>
<p><span class="target" id="design.mps.io.if.destroy"></span><a class="mpstag reference internal" href="#design.mps.io.if.destroy">.if.destroy:</a> The MPM will call <a class="reference internal" href="../topic/plinth.html#mps_io_destroy" title="mps_io_destroy"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_destroy()</span></tt></a> to tear down
the I/O module, after which it guarantees that the state value will
not be used again. The <tt class="docutils literal"><span class="pre">state</span></tt> parameter is the state previously
returned by <a class="reference internal" href="../topic/plinth.html#mps_io_create" title="mps_io_create"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_create()</span></tt></a> (<a class="reference internal" href="#design.mps.io.if.create">.if.create</a>).</p>
</div>
<div class="section" id="message-send-and-receive">
<h3>13.6.5. Message send and receive<a class="headerlink" href="#message-send-and-receive" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="mps_io_send">
extern <a class="reference internal" href="../topic/error.html#mps_res_t" title="mps_res_t">mps_res_t</a> <tt class="descname">mps_io_send</tt><big>(</big><a class="reference internal" href="../topic/plinth.html#mps_io_t" title="mps_io_t">mps_io_t</a><em>&nbsp;state</em>, mps_io_type_t<em>&nbsp;type</em>, void<em>&nbsp;*message</em>, size_t<em>&nbsp;size</em><big>)</big><a class="headerlink" href="#mps_io_send" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.io.if.send"></span><a class="mpstag reference internal" href="#design.mps.io.if.send">.if.send:</a> The MPM will call <a class="reference internal" href="#mps_io_send" title="mps_io_send"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_send()</span></tt></a> when it wishes to
send a message to a destination. The <tt class="docutils literal"><span class="pre">state</span></tt> parameter is the state
previously returned by <a class="reference internal" href="../topic/plinth.html#mps_io_create" title="mps_io_create"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_create()</span></tt></a> (<a class="reference internal" href="#design.mps.io.if.create">.if.create</a>). The
<tt class="docutils literal"><span class="pre">type</span></tt> parameter is the type (<a class="reference internal" href="#design.mps.io.if.type">.if.type</a>) of the message. The
<tt class="docutils literal"><span class="pre">message</span></tt> parameter is a pointer to a buffer containing the message,
and <tt class="docutils literal"><span class="pre">size</span></tt> is the length of that message, in bytes. The I/O module
must make an effort to deliver the message to the destination, but is
not expected to guarantee delivery. The function should return
<a class="reference internal" href="../topic/error.html#MPS_RES_IO" title="MPS_RES_IO"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_RES_IO</span></tt></a> only if a serious error occurs that should cause the
MPM to return with an error to the client application. Failure to
deliver the message does not count.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">Should there be a timeout parameter? What are the timing
constraints? <a class="reference internal" href="#mps_io_send" title="mps_io_send"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_send()</span></tt></a> shouldn&#8217;t block.</p>
</div>
<dl class="function">
<dt id="mps_io_receive">
extern <a class="reference internal" href="../topic/error.html#mps_res_t" title="mps_res_t">mps_res_t</a> <tt class="descname">mps_io_receive</tt><big>(</big><a class="reference internal" href="../topic/plinth.html#mps_io_t" title="mps_io_t">mps_io_t</a><em>&nbsp;state</em>, void<em>&nbsp;**buffer_o</em>, size_t<em>&nbsp;*size_o</em><big>)</big><a class="headerlink" href="#mps_io_receive" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.io.if.receive"></span><a class="mpstag reference internal" href="#design.mps.io.if.receive">.if.receive:</a> The MPM will call <a class="reference internal" href="#mps_io_receive" title="mps_io_receive"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_receive()</span></tt></a> when it wants
to see if a message has been sent to it. The <tt class="docutils literal"><span class="pre">state</span></tt> parameter is
the state previously returned by <a class="reference internal" href="../topic/plinth.html#mps_io_create" title="mps_io_create"><tt class="xref c c-func docutils literal"><span class="pre">mps_io_create()</span></tt></a> (<a class="reference internal" href="#design.mps.io.if.create">.if.create</a>).
The <tt class="docutils literal"><span class="pre">buffer_o</span></tt> parameter is a pointer to a value which should be
updated with a pointer to a buffer containing the message received.
The <tt class="docutils literal"><span class="pre">size_o</span></tt> parameter is a pointer to a value which should be
updated with the length of the message received. If there is no
message ready for receipt, the length returned should be zero.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">Should we be able to receive truncated messages? How can this be
done neatly?</p>
</div>
</div>
</div>
<div class="section" id="i-o-module-implementations">
<h2>13.7. I/O module implementations<a class="headerlink" href="#i-o-module-implementations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="routeing">
<h3>13.7.1. Routeing<a class="headerlink" href="#routeing" title="Permalink to this headline">¶</a></h3>
<p>The I/O module must decide where to send the various messages. A
file-based implementation could put them in different files based on
their types. A network-based implementation must decide how to address
the messages. In either case, any configuration must either be
statically compiled into the module, or else read from some external
source such as a configuration file.</p>
</div>
</div>
<div class="section" id="notes">
<h2>13.8. Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<p>The external tools should be able to reconstruct stuff from partial
info. For example, you come across a fragment of an old log containing
just a few old messages. What can you do with it?</p>
<p>Here&#8217;s some completely untested code which might do the job for UDP.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#include &quot;mpsio.h&quot;</span>

<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">mps_io_s</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">sock</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">mine</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">telemetry</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">debugging</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mps_io_s</span><span class="p">;</span>

<span class="k">static</span> <span class="n">mps_bool_t</span> <span class="n">inited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">mps_io_s</span> <span class="n">state</span><span class="p">;</span>


<span class="n">mps_res_t</span> <span class="nf">mps_io_create</span><span class="p">(</span><span class="n">mps_io_t</span> <span class="o">*</span><span class="n">mps_io_o</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">inited</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">MPS_RES_LIMIT</span><span class="p">;</span>

  <span class="n">state</span><span class="p">.</span><span class="n">mine</span> <span class="o">=</span> <span class="cm">/* setup somehow from config */</span><span class="p">;</span>
  <span class="n">state</span><span class="p">.</span><span class="n">telemetry</span> <span class="o">=</span> <span class="cm">/* setup something from config */</span><span class="p">;</span>
  <span class="n">state</span><span class="p">.</span><span class="n">debugging</span> <span class="o">=</span> <span class="cm">/* setup something from config */</span><span class="p">;</span>

  <span class="cm">/* Make a socket through which to communicate. */</span>
  <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">MPS_RES_IO</span><span class="p">;</span>

  <span class="cm">/* Set socket to non-blocking mode. */</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">O_NDELAY</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">MPS_RES_IO</span><span class="p">;</span>

  <span class="cm">/* Bind the socket to some UDP port so that we can receive messages. */</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">state</span><span class="p">.</span><span class="n">mine</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">mine</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">MPS_RES_IO</span><span class="p">;</span>

  <span class="n">state</span><span class="p">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>

  <span class="n">inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="o">*</span><span class="n">mps_io_o</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">MPS_RES_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">mps_io_destroy</span><span class="p">(</span><span class="n">mps_io_t</span> <span class="n">mps_io</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">mps_io</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">inited</span><span class="p">);</span>

  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">close</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">sock</span><span class="p">);</span>

  <span class="n">inited</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">mps_res_t</span> <span class="nf">mps_io_send</span><span class="p">(</span><span class="n">mps_io_t</span> <span class="n">mps_io</span><span class="p">,</span> <span class="n">mps_type_t</span> <span class="n">type</span><span class="p">,</span>
                      <span class="kt">void</span> <span class="o">*</span><span class="n">message</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">toaddr</span><span class="p">;</span>

  <span class="n">assert</span><span class="p">(</span><span class="n">mps_io</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">inited</span><span class="p">);</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="nl">MPS_IO_TYPE_TELEMETRY:</span>
    <span class="n">toaddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">state</span><span class="p">.</span><span class="n">telemetry</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>

    <span class="nl">MPS_IO_TYPE_DEBUGGING:</span>
    <span class="n">toaddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">state</span><span class="p">.</span><span class="n">debugging</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
    <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">MPS_RES_UNIMPL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">sendto</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">sock</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">toaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">toaddr</span><span class="p">));</span>

  <span class="k">return</span> <span class="n">MPS_RES_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">mps_res_t</span> <span class="nf">mps_io_receive</span><span class="p">(</span><span class="n">mps_io_t</span> <span class="n">mps_io</span><span class="p">,</span>
                         <span class="kt">void</span> <span class="o">**</span><span class="n">message_o</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">**</span><span class="n">size_o</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MPS_IO_MESSAGE_MAX</span><span class="p">];</span>

  <span class="n">assert</span><span class="p">(</span><span class="n">mps_io</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">inited</span><span class="p">);</span>

  <span class="n">r</span> <span class="o">=</span> <span class="n">recvfrom</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* Ignore interrupted system calls, and failures due to lack */</span>
      <span class="cm">/* of resources (they might go away.) */</span>
      <span class="k">case</span> <span class="n">EINTR</span>: <span class="k">case</span> <span class="n">ENOMEM</span>: <span class="k">case</span> <span class="n">ENOSR</span>:
      <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="nl">default:</span>
      <span class="k">return</span> <span class="n">MPS_RES_IO</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="o">*</span><span class="n">message_o</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
  <span class="o">*</span><span class="n">size_o</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">MPS_RES_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="attachments">
<h2>13.9. Attachments<a class="headerlink" href="#attachments" title="Permalink to this headline">¶</a></h2>
<p>&#8220;O Architecture Diagram&#8221;
&#8220;O Configuration Diagrams&#8221;</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">13. I/O subsystem</a><ul>
<li><a class="reference internal" href="#introduction">13.1. Introduction</a></li>
<li><a class="reference internal" href="#background">13.2. Background</a></li>
<li><a class="reference internal" href="#purpose">13.3. Purpose</a></li>
<li><a class="reference internal" href="#requirements">13.4. Requirements</a><ul>
<li><a class="reference internal" href="#general">13.4.1. General</a></li>
<li><a class="reference internal" href="#functional">13.4.2. Functional</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture">13.5. Architecture</a><ul>
<li><a class="reference internal" href="#example-configurations">13.5.1. Example configurations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#interface">13.6. Interface</a><ul>
<li><a class="reference internal" href="#i-o-module-state">13.6.1. I/O module state</a></li>
<li><a class="reference internal" href="#message-types">13.6.2. Message types</a></li>
<li><a class="reference internal" href="#limits">13.6.3. Limits</a></li>
<li><a class="reference internal" href="#interface-set-up-and-tear-down">13.6.4. Interface set-up and tear-down</a></li>
<li><a class="reference internal" href="#message-send-and-receive">13.6.5. Message send and receive</a></li>
</ul>
</li>
<li><a class="reference internal" href="#i-o-module-implementations">13.7. I/O module implementations</a><ul>
<li><a class="reference internal" href="#routeing">13.7.1. Routeing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#notes">13.8. Notes</a></li>
<li><a class="reference internal" href="#attachments">13.9. Attachments</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="interface-c.html"
                        title="previous chapter">12. C interface design</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="lib.html"
                        title="next chapter">14. Library interface</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="lib.html" title="14. Library interface"
             >next</a> |</li>
        <li class="right" >
          <a href="interface-c.html" title="12. C interface design"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" >Old design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>