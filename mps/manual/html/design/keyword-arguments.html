

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8. Keyword arguments in the MPS &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Design" href="index.html" />
    <link rel="next" title="9. Ranges" href="range.html" />
    <link rel="prev" title="7. C Style – formatting" href="guide.impl.c.format.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="range.html" title="9. Ranges"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="guide.impl.c.format.html" title="7. C Style – formatting"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <span class="target" id="design-keyword-arguments"></span><div class="section" id="keyword-arguments-in-the-mps">
<span id="index-0"></span><h1>8. Keyword arguments in the MPS<a class="headerlink" href="#keyword-arguments-in-the-mps" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>8.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Up to version 1.111, the <a class="reference external" href="http://www.ravenbrook.com/project/mps/">Memory Pool System</a> used varags to pass arguments
to arena and pool classes, because the general MPS interface can&#8217;t
specify what arguments those classes might need in C prototypes. This
mechanism was error-prone and did not allow for any optional arguments,
meaning that the client had to specify or predict esoteric tuning
parameters.</p>
<p>Starting with version 1.112, the MPS uses an idiom for keyword arguments.</p>
</div>
<div class="section" id="overview">
<h2>8.2. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The basic design is not specific to the MPS.  The keyword argument list is
passed as an array of argument structures which look like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">mps_key_s</span> <span class="o">*</span><span class="kt">mps_key_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">mps_arg_s</span> <span class="p">{</span>
  <span class="kt">mps_key_t</span> <span class="n">key</span><span class="p">;</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
    <span class="cm">/* etc. */</span>
  <span class="p">}</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mps_arg_s</span><span class="p">;</span>
</pre></div>
</div>
<p>The argument list is assembled and passed like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">mps_arg_s</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">MPS_KEY_MIN_SIZE</span><span class="p">;</span>
<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">val</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">MPS_KEY_MAX_SIZE</span><span class="p">;</span>
<span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">val</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
<span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">MPS_KEY_ARGS_END</span><span class="p">;</span>
<span class="n">mps_pool_create_k</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="p">,</span> <span class="n">some_pool_class</span><span class="p">(),</span> <span class="n">args</span><span class="p">);</span>
</pre></div>
</div>
<p>This can be written quite concisely in C99:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">mps_pool_create_k</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="p">,</span> <span class="n">some_pool_class</span><span class="p">(),</span>
        <span class="p">(</span><span class="n">mps_arg_s</span> <span class="p">[]){{</span><span class="n">MPS_KEY_MIN_SIZE</span><span class="p">,</span> <span class="p">{.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">}},</span>
                       <span class="p">{</span><span class="n">MPS_KEY_MAX_SIZE</span><span class="p">,</span> <span class="p">{.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">}},</span>
                       <span class="p">{</span><span class="n">MPS_KEY_ARGS_END</span><span class="p">}});</span>
</pre></div>
</div>
<p>The arguments that are recognised and used by the function are removed
from the array (and the subsequent arguments moved up) so that if they
are all consumed the array has <tt class="xref c c-macro docutils literal"><span class="pre">MPS_KEY_ARGS_END</span></tt> in slot zero on
return. This can be checked by the caller.</p>
<ul class="simple">
<li>It&#8217;s not a static error to pass excess arguments.  This makes it easy to
substitute one pool or arena class for another (which might ignore some
arguments).  The caller can check that <tt class="docutils literal"><span class="pre">args[0].key</span></tt> is
<tt class="xref c c-macro docutils literal"><span class="pre">MPS_KEY_ARGS_END</span></tt> if desired.</li>
<li>NULL is not a valid argument list.  This is in line with general MPS
design principles to avoid accidental omissions.  For convenience, we
provide <tt class="docutils literal"><span class="pre">mps_args_none</span></tt> as a static empty argument list.</li>
<li>NULL is not a valid argument key.  This is in line with general MPS
design principles to avoid accidental omissions.  Every key points to
a structure with a signature that can be checked.  This makes it virtually
impossible to get an argument list with bad keys or that is unterminated
past MPS checking.</li>
</ul>
</div>
<div class="section" id="internals">
<h2>8.3. Internals<a class="headerlink" href="#internals" title="Permalink to this headline">¶</a></h2>
<p>Internally, keys are static constant structures which are signed and contain
a checking method for the argument, like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">mps_arg_s</span> <span class="o">*</span><span class="n">Arg</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">mps_key_s</span> <span class="p">{</span>
  <span class="n">Sig</span> <span class="n">sig</span><span class="p">;</span>              <span class="cm">/* Always KeySig */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
  <span class="n">Bool</span> <span class="nf">check</span><span class="p">(</span><span class="n">Arg</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span> <span class="n">KeyStruct</span><span class="p">;</span>
</pre></div>
</div>
<p>They are mostly declared in the modules that consume them, except for a few
common keys.  Declarations look like:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">const</span> <span class="n">KeyStruct</span> <span class="n">_mps_key_extend_by</span> <span class="o">=</span> <span class="p">{</span><span class="n">KeySig</span><span class="p">,</span> <span class="s">&quot;extend_by&quot;</span><span class="p">,</span> <span class="n">ArgCheckSize</span><span class="p">};</span>
</pre></div>
</div>
<p>but <tt class="docutils literal"><span class="pre">arg.h</span></tt> provides a macro for this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">ARG_DEFINE_KEY</span><span class="p">(</span><span class="n">extend_by</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</pre></div>
</div>
<p>We define keys as static structures (rather than, say, an enum) because:</p>
<ul class="simple">
<li>The set of keys can be extended indefinitely.</li>
<li>The set of keys can be extended by indepdently linked modules.</li>
<li>The structure contents allow strong checking of argument lists.</li>
</ul>
<p>In the MPS Interface, we declare keys like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mps_key_s</span> <span class="n">_mps_key_extend_by</span><span class="p">;</span>
<span class="cp">#define MPS_KEY_EXTEND_BY (&amp;_mps_key_extend_by)</span>
</pre></div>
</div>
<p>The underscore on the symbol requests that client code doesn&#8217;t reference
it, but instead uses the macro.  This gives us adaptability to change the
design and replace keys with, say, magic numbers.</p>
</div>
<div class="section" id="the-varargs-legacy">
<h2>8.4. The varargs legacy<a class="headerlink" href="#the-varargs-legacy" title="Permalink to this headline">¶</a></h2>
<p>For backward compatibility, varargs to arena and pool creation are
converted into keyword arguments by position, using a method in the
arena or pool class. For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">MVVarargs</span><span class="p">(</span><span class="n">ArgStruct</span> <span class="n">args</span><span class="p">[],</span> <span class="kt">va_list</span> <span class="n">varargs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">MPS_KEY_EXTEND_BY</span><span class="p">;</span>
  <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">val</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">varargs</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
  <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">MPS_KEY_MEAN_SIZE</span><span class="p">;</span>
  <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">val</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">varargs</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
  <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">MPS_KEY_MAX_SIZE</span><span class="p">;</span>
  <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">val</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">varargs</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
  <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">MPS_KEY_ARGS_END</span><span class="p">;</span>
  <span class="n">AVER</span><span class="p">(</span><span class="n">ArgListCheck</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This leaves the main body of code, and any future code, free to just
handle keyword arguments only.</p>
<p>The use of varargs is deprecated in the manual and the interface and these
methods can be deleted at some point in the future.</p>
</div>
<div class="section" id="references">
<h2>8.5. References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils citation" frame="void" id="rb-2012-05-24" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[RB_2012-05-24]</td><td>Richard Brooksby. Ravenbrook Limited. 2012-05-24. &#8220;<a class="reference external" href="https://info.ravenbrook.com/mail/2012/05/24/21-19-15/0/">Keyword and optional arguments</a>&#8221;.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">8. Keyword arguments in the MPS</a><ul>
<li><a class="reference internal" href="#introduction">8.1. Introduction</a></li>
<li><a class="reference internal" href="#overview">8.2. Overview</a></li>
<li><a class="reference internal" href="#internals">8.3. Internals</a></li>
<li><a class="reference internal" href="#the-varargs-legacy">8.4. The varargs legacy</a></li>
<li><a class="reference internal" href="#references">8.5. References</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="guide.impl.c.format.html"
                        title="previous chapter">7. C Style &#8211; formatting</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="range.html"
                        title="next chapter">9. Ranges</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="range.html" title="9. Ranges"
             >next</a> |</li>
        <li class="right" >
          <a href="guide.impl.c.format.html" title="7. C Style – formatting"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>