

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3. MPS Configuration &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Design" href="index.html" />
    <link rel="next" title="4. The critical path through the MPS" href="critical-path.html" />
    <link rel="prev" title="2. Coalescing block structure" href="cbs.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="critical-path.html" title="4. The critical path through the MPS"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cbs.html" title="2. Coalescing block structure"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mps-configuration">
<span id="design-config"></span><span id="index-0"></span><h1>3. MPS Configuration<a class="headerlink" href="#mps-configuration" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.config"></span><h2>3.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.config.intro"></span><a class="mpstag reference internal" href="#design.mps.config.intro">.intro:</a> This document describes how the <a class="reference external" href="http://www.ravenbrook.com/project/mps/">Memory Pool System</a> source code is configured so
that it can target different architectures, operating systems, build
environments, varieties, and products.</p>
</div>
<div class="section" id="requirements">
<h2>3.2. Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.config.req.import"></span><a class="mpstag reference internal" href="#design.mps.config.req.import">.req.import:</a> The MPS must be simple to include in third-party projects.</p>
<p><span class="target" id="design.mps.config.req.arch"></span><a class="mpstag reference internal" href="#design.mps.config.req.arch">.req.arch:</a> Allow architecture specific configurations of the MPS, so
that we can vary the MPS according to the target architecture.</p>
<p><span class="target" id="design.mps.config.req.os"></span><a class="mpstag reference internal" href="#design.mps.config.req.os">.req.os:</a> Allow operating system specific configurations of the MPS,
so that we can vary the MPS according to the target OS.</p>
<p><span class="target" id="design.mps.config.req.builder"></span><a class="mpstag reference internal" href="#design.mps.config.req.builder">.req.builder:</a> Allow build environment specific configurations of the
MPS, so that we can vary the MPS according to the compiler, etc.</p>
<p><span class="target" id="design.mps.config.req.var"></span><a class="mpstag reference internal" href="#design.mps.config.req.var">.req.var:</a> Allow configurations with different amounts of
instrumentation (assertions, metering, etc.).</p>
<p><span class="target" id="design.mps.config.req.impact"></span><a class="mpstag reference internal" href="#design.mps.config.req.impact">.req.impact:</a> The configuration system should have a minimal effect on
maintainability of the implementation.</p>
<p><span class="target" id="design.mps.config.req.port"></span><a class="mpstag reference internal" href="#design.mps.config.req.port">.req.port:</a> The system should be easy to port across platforms.</p>
<p><span class="target" id="design.mps.config.req.maint"></span><a class="mpstag reference internal" href="#design.mps.config.req.maint">.req.maint:</a> Maintenance of the configuration and build system should
not consume much developer time.</p>
<div class="section" id="retired-requirements">
<h3>3.2.1. Retired requirements<a class="headerlink" href="#retired-requirements" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.config.req.prod"></span><a class="mpstag reference internal" href="#design.mps.config.req.prod">.req.prod:</a> Allow product specific configurations of the MPS, so that
we can build variants of the MPS for use in different products.  This
requirement has been retired on 2012-09-03 as part of work on the
<a class="reference external" href="/project/mps/branch/2012-08-15/variety-reform">variety-reform</a> branch.  Client-specific customisation of the MPS will
be handled in source control, while the MPS source remains generic, to
reduce costs and increase reliability.  See <a class="reference internal" href="#rb-2012-09-13">[RB_2012-09-13]</a>.</p>
</div>
</div>
<div class="section" id="definitions">
<h2>3.3. Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.config.def.platform"></span><a class="mpstag reference internal" href="#design.mps.config.def.platform">.def.platform:</a> A <em>platform</em> is a combination of an architecture
(<a class="reference internal" href="#design.mps.config.def.arch">.def.arch</a>), an operating system (<a class="reference internal" href="#design.mps.config.def.os">.def.os</a>), and a builder
(<a class="reference internal" href="#design.mps.config.def.builder">.def.builder</a>).  The set of supported platforms is maintained in the
<a class="reference external" href="../manual/html/guide/build.html#platforms">Platforms section of &#8220;Building the Memory Pool System&#8221;</a>.</p>
<p><span class="target" id="design.mps.config.def.arch"></span><a class="mpstag reference internal" href="#design.mps.config.def.arch">.def.arch:</a> An <em>architecture</em> is processor type with associated calling
conventions and other binary interface stuff these days often called the
<a class="reference external" href="http://en.wikipedia.org/wiki/Application_binary_interface">ABI</a>.
Most importantly for the MPS it determines the layout of the register
file, thread context, and thread stack.</p>
<p><span class="target" id="design.mps.config.def.os"></span><a class="mpstag reference internal" href="#design.mps.config.def.os">.def.os:</a> An <em>operating system</em> is the interface to external resources.
Most importantly for the MPS it determines the low level interface to
virtual memory (if any) and threading.</p>
<p><span class="target" id="design.mps.config.def.builder"></span><a class="mpstag reference internal" href="#design.mps.config.def.builder">.def.builder:</a> A <em>builder</em> is the tools (C compiler, etc.) used to make
the target (<a class="reference internal" href="#design.mps.config.def.target">.def.target</a>).  The MPS minimises use of compiler-specific
extensions, but this is handy for suppressing warnings, inlining hints,
etc.</p>
<p><span class="target" id="design.mps.config.def.var"></span><a class="mpstag reference internal" href="#design.mps.config.def.var">.def.var:</a> A <em>variety</em> determines things like the amount of debugging,
internal consistency checking, annotation, etc.  In modern IDEs this
called a &#8220;build configuration&#8221; and the usual default is to have two:
&#8220;debug&#8221; and &#8220;release&#8221;. The MPS predates this convention, but the concept
is the same.</p>
<p><span class="target" id="design.mps.config.def.prod"></span><a class="mpstag reference internal" href="#design.mps.config.def.prod">.def.prod:</a> A <em>product</em> is the intended product into which the MPS will
fit, e.g. ScriptWorks, Dylan, etc.  We no longer maintain this concept
as a dimension of configuration since <a class="reference internal" href="#design.mps.config.req.prod">.req.prod</a> has been retired.</p>
<p><span class="target" id="design.mps.config.def.target"></span><a class="mpstag reference internal" href="#design.mps.config.def.target">.def.target:</a> The <em>target</em> is the result of the build.</p>
</div>
<div class="section" id="overview">
<h2>3.4. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.config.import.source"></span><a class="mpstag reference internal" href="#design.mps.config.import.source">.import.source:</a> The MPS can be simply included in client products as
source code.  Since <a class="reference external" href="http://www.ravenbrook.com/project/mps/version/1.110/">version 1.110</a> we made it possible to simply
include the file <tt class="docutils literal"><span class="pre">mps.c</span></tt> in a client&#8217;s build process, without
requiring a separate build of the MPS or linking a library.  This is
described <a class="reference external" href="../manual/html/guide/build.html#compiling-for-production">section 2.3.1, &#8220;Compiling for production&#8221; of the MPS manual</a>.</p>
<p><span class="target" id="design.mps.config.no-gen"></span><a class="mpstag reference internal" href="#design.mps.config.no-gen">.no-gen:</a> No generated code or external tools are required.  On most
platforms the only tool is the C compiler.  On 64-bit Windows we require
the assembler since Microsoft withdrew in-line assembler from their C
compiler.</p>
<p><span class="target" id="design.mps.config.no-spaghetti"></span><a class="mpstag reference internal" href="#design.mps.config.no-spaghetti">.no-spaghetti:</a> Several of the MPS team have worked on some extremely
messy code bases which used a great number of <tt class="docutils literal"><span class="pre">#ifdef</span></tt> statements.
These quickly became very expensive to maintain and develop.  The
general rule in the MPS is &#8220;no <tt class="docutils literal"><span class="pre">#ifdefs</span></tt>&#8221;.  Instead, platform-specific
code is kept in separate source files and selected by carefully controlled
<tt class="docutils literal"><span class="pre">#ifdefs</span></tt>, such as in <a class="reference external" href="../code/mps.c">mps.c</a>.</p>
<p><span class="target" id="design.mps.config.min-dep"></span><a class="mpstag reference internal" href="#design.mps.config.min-dep">.min-dep:</a> Dependency on a particular configuration should be
minimized and localized when developing code.  This is enshrined in the
general rules for implementation [ref?] that are enforced by MPS
development procedures including code review and inspection.</p>
</div>
<div class="section" id="the-build-system">
<h2>3.5. The build system<a class="headerlink" href="#the-build-system" title="Permalink to this headline">¶</a></h2>
<div class="section" id="abstract-build-function">
<h3>3.5.1. Abstract build function<a class="headerlink" href="#abstract-build-function" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.config.build.fun"></span><a class="mpstag reference internal" href="#design.mps.config.build.fun">.build.fun:</a> The MPS implementation assumes only a simple &#8220;build
function&#8221; that takes a set of sources, possibly in several languages,
compiles them with a set of predefined preprocessor symbols, and links
the result with a set of libraries to form the target:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">target</span> <span class="o">:=</span> <span class="n">build</span><span class="p">(</span><span class="o">&lt;</span><span class="n">defs</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">srcs</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">libs</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.build.sep"></span><a class="mpstag reference internal" href="#design.mps.config.build.sep">.build.sep:</a> Separate compilation and linkage can be seen as a
memoization of this function, and is not strictly necessary for the
build. Indeed, since <cite>version 1.110</cite> we found that modern compilers
are quite happy to compile the whole MPS in one go <a class="reference internal" href="#design.mps.config.import.source">.import.source</a>.</p>
<p><span class="target" id="design.mps.config.build.cc"></span><a class="mpstag reference internal" href="#design.mps.config.build.cc">.build.cc:</a> A consequence of this approach is that it should always
be possible to build a complete target with a single UNIX command line
calling the compiler driver (usually &#8220;cc&#8221; or &#8220;gcc&#8221;), for example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">cc</span> <span class="o">-</span><span class="n">o</span> <span class="n">main</span> <span class="o">-</span><span class="n">DCONFIG_VAR_DF</span> <span class="n">foo</span><span class="p">.</span><span class="n">c</span> <span class="n">bar</span><span class="p">.</span><span class="n">c</span> <span class="n">baz</span><span class="p">.</span><span class="n">s</span> <span class="o">-</span><span class="n">lz</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.build.defs"></span><a class="mpstag reference internal" href="#design.mps.config.build.defs">.build.defs:</a> The &#8220;defs&#8221; are the set of preprocessor macros which are to be
predefined when compiling the module sources:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">CONFIG_VAR_</span><span class="o">&lt;</span><span class="n">variety</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The variety-codes are the letter code that appears after &#8220;variety.&#8221; in
the tag of the relevant variety document (see variety.*) converted to
upper case. Currently (2012-09-03):</p>
<p><span class="target" id="design.mps.config.var.hot"></span><a class="mpstag reference internal" href="#design.mps.config.var.hot">.var.hot:</a> <tt class="xref c c-macro docutils literal"><span class="pre">HOT</span></tt></p>
<blockquote>
<div>Intended for release in products.  Optimised, reduced internal
checking, especially on the critical path <a class="reference internal" href="#rb-2012-09-07">[RB_2012-09-07]</a>.</div></blockquote>
<p><span class="target" id="design.mps.config.var.cool"></span><a class="mpstag reference internal" href="#design.mps.config.var.cool">.var.cool:</a> <tt class="xref c c-macro docutils literal"><span class="pre">COOL</span></tt></p>
<blockquote>
<div>Intended for use during development.  Moderately thorough internal
consistency checking.  Reduced optimisation to allow for
single-stepping.</div></blockquote>
<p><span class="target" id="design.mps.config.var.rash"></span><a class="mpstag reference internal" href="#design.mps.config.var.rash">.var.rash:</a> <tt class="xref c c-macro docutils literal"><span class="pre">RASH</span></tt></p>
<blockquote>
<div>No internal checking at all.  Slight performance improvement over
<a class="reference internal" href="#design.mps.config.var.hot">.var.hot</a> at the cost of early detection of memory management
bugs.  We do not advise use of this variety, as memory management
bugs tend to be extremely expensive to deal with.</div></blockquote>
<p><span class="target" id="design.mps.config.default.hot"></span><a class="mpstag reference internal" href="#design.mps.config.default.hot">.default.hot:</a> If no <tt class="xref c c-macro docutils literal"><span class="pre">CONFIG_VAR</span></tt> is present, <tt class="xref c c-macro docutils literal"><span class="pre">HOT</span></tt> is assumed in
<a class="reference external" href="&lt;../code/config.h&gt;">config.h</a>.</p>
<p><span class="target" id="design.mps.config.build.srcs"></span><a class="mpstag reference internal" href="#design.mps.config.build.srcs">.build.srcs:</a> The &#8220;srcs&#8221; are the set of sources that must be
compiled in order to build the target. The set of sources may vary
depending on the configuration. For example, different sets of sources
may be required to build different architectures.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">This is a dependency between the makefile (or whatever) and the
module configuration in <a class="reference external" href="&lt;../code/config.h&gt;">config.h</a>.</p>
</div>
<p><span class="target" id="design.mps.config.build.libs"></span><a class="mpstag reference internal" href="#design.mps.config.build.libs">.build.libs:</a> The &#8220;libs&#8221; are the set of libraries to which the
compiled sources must be linked in order to build the target. For
example, when building a test program, it might include the ANSI C
library and an operating system interface library.</p>
</div>
<div class="section" id="file-structure">
<h3>3.5.2. File Structure<a class="headerlink" href="#file-structure" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.config.file.dir"></span><a class="mpstag reference internal" href="#design.mps.config.file.dir">.file.dir:</a> The MPS source code is arranged in a single directory
called &#8220;code&#8221; containing all the sources for the whole family of
targets.</p>
<p><span class="target" id="design.mps.config.file.base"></span><a class="mpstag reference internal" href="#design.mps.config.file.base">.file.base:</a> The names of sources must be unique in the first eight
characters in order to conform to FAT filesystem naming restrictions.
(Do not scoff &#8211; this has been an important requirement as recently as
2012!)</p>
<p><span class="target" id="design.mps.config.file.ext"></span><a class="mpstag reference internal" href="#design.mps.config.file.ext">.file.ext:</a> The extension may be up to three characters and directly
indicates the source language.</p>
<p><span class="target" id="design.mps.config.file.platform"></span><a class="mpstag reference internal" href="#design.mps.config.file.platform">.file.platform:</a> Platform-specific files include the platform code
in their name.  See <a class="reference internal" href="#design.mps.config.mod.impls">.mod.impls</a>.</p>
</div>
<div class="section" id="modules-and-naming">
<h3>3.5.3. Modules and naming<a class="headerlink" href="#modules-and-naming" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.config.mod.unique"></span><a class="mpstag reference internal" href="#design.mps.config.mod.unique">.mod.unique:</a> Each module has an identifier which is unique within the MPS.</p>
<p><span class="target" id="design.mps.config.mod.impls"></span><a class="mpstag reference internal" href="#design.mps.config.mod.impls">.mod.impls:</a> Each module has one or more implementations which may be
in any language supported by the relevant build environment.</p>
<p><span class="target" id="design.mps.config.mod.primary"></span><a class="mpstag reference internal" href="#design.mps.config.mod.primary">.mod.primary:</a> The primary implementation of a module is written in
target-independent ANSI C in a source file with the same name as the
module.</p>
<p><span class="target" id="design.mps.config.mod.an"></span><a class="mpstag reference internal" href="#design.mps.config.mod.an">.mod.an:</a> Where there are platform-specific implementations and an
inferior portable ANSI C fallback implementation, &#8220;an&#8221; is used in
place of the platform code.</p>
<p><span class="target" id="design.mps.config.mod.secondary"></span><a class="mpstag reference internal" href="#design.mps.config.mod.secondary">.mod.secondary:</a> The names of other implementations should begin
with the same prefix (the module id or a shortened version of it) and
be suffixed with on or more target parameter codes (defined below). In
particular, the names of assembly language sources must include the
target parameter code for the relevant architecture.</p>
<p><span class="target" id="design.mps.config.mod.example"></span><a class="mpstag reference internal" href="#design.mps.config.mod.example">.mod.example:</a> For example, the stack scanner is defined in <a class="reference external" href="../code/ss.h">ss.h</a> (which is platform-independent).  It has some
platform-independent C in <a class="reference external" href="../code/ss.c">ss.c</a> and, for example,
<a class="reference external" href="../code/ssw3i6mv.c">ssw3i6mv.c</a> is specific to Windows on the x64
architecture built with Microsoft Visual C.</p>
</div>
<div class="section" id="build-system-rationale">
<h3>3.5.4. Build system rationale<a class="headerlink" href="#build-system-rationale" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.config.build.rat"></span><a class="mpstag reference internal" href="#design.mps.config.build.rat">.build.rat:</a> This simple design makes it possible to build the MPS
using many different tools.  Microsoft Visual C and other graphical
development tools do not support much in the way of generated sources,
staged building, or other such stuff.  The Visual C and Xcode &#8220;project&#8221;
files correspond closely to a closure of the build function
(<a class="reference internal" href="#design.mps.config.build.fun">.build.fun</a>).  The simplicity of the build function has also made it
easy to set up builds using NMAKE (DOS), MPW (Macintosh), and to get the
MPS up and running on other platforms such as FreeBSD and Linux in very
little time.  The cost of maintaining the build systems on these various
platforms is also reduced to a minimum, allowing the MPS developers to
concentrate on primary development.  The source code is kept simple and
straightforward.  When looking at MPS sources you can tell exactly what
is going to be generated with very little context.  The sources are not
munged beyond the standard ANSI C preprocessor.</p>
<p><span class="target" id="design.mps.config.build.port"></span><a class="mpstag reference internal" href="#design.mps.config.build.port">.build.port:</a> The portability requirement (<a class="reference internal" href="#design.mps.config.req.port">.req.port</a>) implies that
the build system must use only standard tools that will be available on
all conceivable target platforms.  Experience of development
environments on the Macintosh (Metrowerks Codewarrior) and Windows NT
(Visual C++) indicates that we cannot assume much sophistication in the
use of file structure by development environments.  The best that we can
hope for is the ability to combine a fixed list of source files,
libraries, and predefined preprocessor symbols into a single target.</p>
<p><span class="target" id="design.mps.config.build.maint"></span><a class="mpstag reference internal" href="#design.mps.config.build.maint">.build.maint:</a> The maintainability requirement (<a class="reference internal" href="#design.mps.config.req.maint">.req.maint</a>) implies
that we don&#8217;t spend time trying to develop a set of tools to support
anything more complicated than the simple build function described
above.  The effort in constructing and maintaining a portable system of
this kind is considerable. Such efforts failed in the Electronic
Publishing division of Harlequin.</p>
</div>
</div>
<div class="section" id="implementation">
<h2>3.6. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.config.impl"></span><a class="mpstag reference internal" href="#design.mps.config.impl">.impl:</a> The two implementation files <a class="reference external" href="&lt;../code/config.h&gt;">config.h</a> and <a class="reference external" href="&lt;../code/mpstd.h&gt;">mpstd.h</a> can be
seen as preprocessor programs which &#8220;accept&#8221; build parameters and &#8220;emit&#8221;
configuration parameters (<a class="reference internal" href="#design.mps.config.fig.impl">.fig.impl</a>).  The build parameters are
defined either by the builder (in the case of target detection) or by
the build function (in the case of selecting the variety).</p>
<p><span class="target" id="design.mps.config.fig.impl"></span><a class="mpstag reference internal" href="#design.mps.config.fig.impl">.fig.impl:</a></p>
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="17%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Build parameters</th>
<th class="head">Source file</th>
<th class="head">Configuration parameters</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference internal" href="../topic/error.html#CONFIG_VAR_HOT" title="CONFIG_VAR_HOT"><tt class="xref c c-macro docutils literal"><span class="pre">CONFIG_VAR_HOT</span></tt></a></td>
<td>⟶ <tt class="docutils literal"><span class="pre">config.h</span></tt></td>
<td>⟶ <tt class="xref c c-macro docutils literal"><span class="pre">MPS_ASSERT_STRING</span></tt>, etc.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">_WIN32</span></tt></td>
<td>⟶ <tt class="docutils literal"><span class="pre">mpstd.h</span></tt></td>
<td>⟶ <a class="reference internal" href="../topic/platform.html#MPS_OS_W3" title="MPS_OS_W3"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_OS_W3</span></tt></a>, etc.</td>
</tr>
</tbody>
</table>
<p><span class="target" id="design.mps.config.impl.dep"></span><a class="mpstag reference internal" href="#design.mps.config.impl.dep">.impl.dep:</a> No source code, other than the directives in <a class="reference external" href="&lt;../code/config.h&gt;">config.h</a>
and <a class="reference external" href="&lt;../code/mpstd.h&gt;">mpstd.h</a>, should depend on any build parameters.  That is,
identifers beginning &#8220;CONFIG_&#8221; should only appear in impl.h.config.
Code may depend on configuration parameters in certain, limited ways, as
defined below (<a class="reference internal" href="#design.mps.config.conf">.conf</a>).</p>
<div class="section" id="target-platform-detection">
<h3>3.6.1. Target platform detection<a class="headerlink" href="#target-platform-detection" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.config.pf"></span><a class="mpstag reference internal" href="#design.mps.config.pf">.pf:</a> The target platform is &#8220;detected&#8221; by the preprocessor directives in
<a class="reference external" href="&lt;../code/mpstd.h&gt;">mpstd.h</a>.</p>
<p><span class="target" id="design.mps.config.pf.form"></span><a class="mpstag reference internal" href="#design.mps.config.pf.form">.pf.form:</a> This file consists of sets of directives of the form:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#elif &lt;conjunction of builder predefinitions&gt;</span>
<span class="cp">#define MPS_PF_&lt;platform code&gt;</span>
<span class="cp">#define MPS_OS_&lt;operating system code&gt;</span>
<span class="cp">#define MPS_ARCH_&lt;architecture code&gt;</span>
<span class="cp">#define MPS_BUILD_&lt;builder code&gt;</span>
<span class="cp">#define MPS_T_WORD     &lt;word type&gt;</span>
<span class="cp">#define MPS_T_ULONGEST &lt;longest unsigned integer type&gt;</span>
<span class="cp">#define MPS_WORD_SHIFT &lt;word shift&gt;</span>
<span class="cp">#define MPS_PF_ALIGN   &lt;minimum alignment&gt;</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.pf.detect"></span><a class="mpstag reference internal" href="#design.mps.config.pf.detect">.pf.detect:</a> The conjunction of builder predefinitions is a constant
expression which detects the target platform.  It is a logical AND of
expressions which look for preprocessor symbols defined by the build
environment to indicate the target.  These must be accompanied by a
reference to the build tool documentation from which the symbols came.
For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cm">/* &quot;Predefined Macros&quot; from &quot;Visual Studio 2010&quot; on MSDN</span>
<span class="cm"> * &lt;http://msdn.microsoft.com/en-us/library/b0084kay(v=vs.100).aspx&gt;. */</span>

<span class="cp">#elif defined(_MSC_VER) &amp;&amp; defined(_WIN32) &amp;&amp; defined(_M_IX86)</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.pf.codes"></span><a class="mpstag reference internal" href="#design.mps.config.pf.codes">.pf.codes:</a> The declarations of the platform, operating system,
architecture, and builder codes define preprocessor macros corresponding
the the target detected (<a class="reference internal" href="#design.mps.config.pf.detect">.pf.detect</a>).  For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define MPS_PF_W3I3MV</span>
<span class="cp">#define MPS_OS_W3</span>
<span class="cp">#define MPS_ARCH_I3</span>
<span class="cp">#define MPS_BUILD_MV</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.pf.word"></span><a class="mpstag reference internal" href="#design.mps.config.pf.word">.pf.word:</a> The declaration of <a class="reference internal" href="../topic/platform.html#MPS_T_WORD" title="MPS_T_WORD"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_T_WORD</span></tt></a> defines the unsigned
integral type which corresponds, on the detected target, to the
machine word. It is used to defined the MPS Word type
(design.mps.type.word). For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define MPS_T_WORD      unsigned long</span>
</pre></div>
</div>
<p>We avoid using <tt class="docutils literal"><span class="pre">typedef</span></tt> here because <a class="reference external" href="&lt;../code/mpstd.h&gt;">mpstd.h</a> could potentially
be included in assembly language source code.</p>
<p><span class="target" id="design.mps.config.pf.word-width"></span><a class="mpstag reference internal" href="#design.mps.config.pf.word-width">.pf.word-width:</a> The declaration of <a class="reference internal" href="../topic/platform.html#MPS_WORD_WIDTH" title="MPS_WORD_WIDTH"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_WORD_WIDTH</span></tt></a> defines the
number of bits in the type defined by <a class="reference internal" href="../topic/platform.html#MPS_T_WORD" title="MPS_T_WORD"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_T_WORD</span></tt></a> (<a class="reference internal" href="#design.mps.config.pf.word">.pf.word</a>) on the
target. For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define MPS_WORD_WIDTH  32</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.pf.word-shift"></span><a class="mpstag reference internal" href="#design.mps.config.pf.word-shift">.pf.word-shift:</a> The declaration of <a class="reference internal" href="../topic/platform.html#MPS_WORD_SHIFT" title="MPS_WORD_SHIFT"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_WORD_SHIFT</span></tt></a> defines the log
to the base 2 of <a class="reference internal" href="../topic/platform.html#MPS_WORD_WIDTH" title="MPS_WORD_WIDTH"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_WORD_WIDTH</span></tt></a>.  For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define MPS_WORD_SHIFT  5</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.pf.pf-align"></span><a class="mpstag reference internal" href="#design.mps.config.pf.pf-align">.pf.pf-align:</a> The declaration of <a class="reference internal" href="../topic/platform.html#MPS_PF_ALIGN" title="MPS_PF_ALIGN"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_PF_ALIGN</span></tt></a> defines the minimum
alignment which must be used for a memory block to permit any normal
processor memory access.  In other words, it is the maximum alignment
required by the processor for normal memory access.  For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define MPS_PF_ALIGN    4</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.pf.ulongest"></span><a class="mpstag reference internal" href="#design.mps.config.pf.ulongest">.pf.ulongest:</a> The declaration of <a class="reference internal" href="../topic/platform.html#MPS_T_ULONGEST" title="MPS_T_ULONGEST"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_T_ULONGEST</span></tt></a> defines the
longest available unsigned integer type on the platform.  This is
usually just <tt class="docutils literal"><span class="pre">unsigned</span> <span class="pre">long</span></tt> but under Microsoft C on 64-bit Windows
<tt class="docutils literal"><span class="pre">unsigned</span> <span class="pre">long</span></tt> is just 32-bits (curse them!)  For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define MPS_T_ULONGEST      unsigned __int64</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.pf.pf-string"></span><a class="mpstag reference internal" href="#design.mps.config.pf.pf-string">.pf.pf-string:</a> The declaration of <a class="reference internal" href="../topic/platform.html#MPS_PF_STRING" title="MPS_PF_STRING"><tt class="xref c c-macro docutils literal"><span class="pre">MPS_PF_STRING</span></tt></a> defines a string
that is used to identify the target platform in <a class="reference external" href="../code/version.c">version.c</a>.  For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define MPS_PF_STRING   &quot;w3i6mv&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="target-varieties">
<h3>3.6.2. Target varieties<a class="headerlink" href="#target-varieties" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.config.var"></span><a class="mpstag reference internal" href="#design.mps.config.var">.var:</a> The target variety is handled by preprocessor directives in
impl.h.config.</p>
<p><span class="target" id="design.mps.config.var.form"></span><a class="mpstag reference internal" href="#design.mps.config.var.form">.var.form:</a> The file contains sets of directives of the form:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#if defined(CONFIG_VAR_COOL)</span>
<span class="cp">#define CONFIG_ASSERT</span>
<span class="cp">#define CONFIG_ASSERT_ALL</span>
<span class="cp">#define CONFIG_STATS</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.config.var.detect"></span><a class="mpstag reference internal" href="#design.mps.config.var.detect">.var.detect:</a> The configured variety is one of the variety
preprocessor definitions passed to the build function
(<a class="reference internal" href="#design.mps.config.build.defs">.build.defs</a>), for example, <a class="reference internal" href="../topic/error.html#CONFIG_VAR_COOL" title="CONFIG_VAR_COOL"><tt class="xref c c-macro docutils literal"><span class="pre">CONFIG_VAR_COOL</span></tt></a>. These are
decoupled in order to keep the number of supported varieties small,
controlling each feature (for example, assertions) by a single
preprocessor definition, and maintaining flexibility about which
features are enabled in each variety.</p>
<p><span class="target" id="design.mps.config.var.symbols"></span><a class="mpstag reference internal" href="#design.mps.config.var.symbols">.var.symbols:</a> The directives should define whatever symbols are
necessary to control featrues. These symbols parameterize other parts
of the code, such as the declaration of assertions, etc. The symbols
should all begin with the prefix <tt class="xref c c-macro docutils literal"><span class="pre">CONFIG_</span></tt>.</p>
</div>
</div>
<div class="section" id="source-code-configuration">
<h2>3.7. Source code configuration<a class="headerlink" href="#source-code-configuration" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.config.conf"></span><a class="mpstag reference internal" href="#design.mps.config.conf">.conf:</a> This section describes how the configuration may affect the
source code of the MPS.</p>
<p><span class="target" id="design.mps.config.conf.limit"></span><a class="mpstag reference internal" href="#design.mps.config.conf.limit">.conf.limit:</a> The form of dependency allowed is carefully limited to
ensure that code remains maintainable and portable (<a class="reference internal" href="#design.mps.config.req.impact">.req.impact</a>).</p>
<p><span class="target" id="design.mps.config.conf.min"></span><a class="mpstag reference internal" href="#design.mps.config.conf.min">.conf.min:</a> The dependency of code on configuration parameters should
be kept to a minimum in order to keep the system maintainable
(<a class="reference internal" href="#design.mps.config.req.impact">.req.impact</a>).</p>
<div class="section" id="configuration-parameters">
<h3>3.7.1. Configuration Parameters<a class="headerlink" href="#configuration-parameters" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.config.conf.params"></span><a class="mpstag reference internal" href="#design.mps.config.conf.params">.conf.params:</a> The compilation of a module is parameterized by:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">MPS_ARCH_</span><span class="o">&lt;</span><span class="n">arch</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span>
<span class="n">MPS_OS_</span><span class="o">&lt;</span><span class="n">os</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span>
<span class="n">MPS_BUILDER_</span><span class="o">&lt;</span><span class="n">builder</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span>
<span class="n">MPS_PF_</span><span class="o">&lt;</span><span class="n">platform</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="abstract-and-concrete-module-interfaces">
<h3>3.7.2. Abstract and Concrete Module Interfaces<a class="headerlink" href="#abstract-and-concrete-module-interfaces" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.config.abs.caller"></span><a class="mpstag reference internal" href="#design.mps.config.abs.caller">.abs.caller:</a> Basic principle: the caller musn&#8217;t be affected by
configuration of a module. This reduces complexity and dependency of
configuration.  All callers use the same abstract interface.  Caller
code does not change.</p>
<p><span class="target" id="design.mps.config.abs.interface"></span><a class="mpstag reference internal" href="#design.mps.config.abs.interface">.abs.interface:</a> Abstract interface includes:</p>
<ul class="simple">
<li>method definitions (logical function prototypes which may be macro methods)</li>
<li>names of types</li>
<li>names of constants</li>
<li>names of structures and fields which form part of the interface, and
possibly their types, depending on the protocol defined</li>
<li>the protocols</li>
</ul>
<p><span class="target" id="design.mps.config.abs.rule"></span><a class="mpstag reference internal" href="#design.mps.config.abs.rule">.abs.rule:</a> The abstract interface to a module may not be altered by a
configuration parameter.  However, the concrete interface may vary.</p>
<p>For example, this isn&#8217;t allowed, because there is a change in the interface:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#if defined(PROT_FOO)</span>
<span class="kt">void</span> <span class="n">ProtSpong</span><span class="p">(</span><span class="n">Foo</span> <span class="n">foo</span><span class="p">,</span> <span class="n">Bar</span> <span class="n">bar</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="n">ProtSpong</span><span class="p">(</span><span class="n">Bar</span> <span class="n">bar</span><span class="p">,</span> <span class="n">Foo</span> <span class="n">foo</span><span class="p">);</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>This example shows how:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#ifdef PROTECTION</span>
<span class="kt">void</span> <span class="n">ProtSync</span><span class="p">(</span><span class="n">Space</span> <span class="n">space</span><span class="p">);</span>
<span class="cp">/* more decls. */</span>
<span class="cp">#else </span><span class="cm">/* PROTECTION not */</span><span class="cp"></span>
<span class="cp">#define ProtSync(space) NOOP</span>
<span class="cp">/* more decls. */</span>
<span class="cp">#endif </span><span class="cm">/* PROTECTION */</span><span class="cp"></span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#if defined(PROT_FOO)</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">ProtStruct</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">foo</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ProtStruct</span><span class="p">;</span>
<span class="cp">#define ProtSpong(prot)  X((prot)-&gt;foo)</span>
<span class="cp">#elif defined(PROT_BAR)</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">ProtStruct</span> <span class="p">{</span>
  <span class="kt">float</span> <span class="n">bar</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ProtStruct</span><span class="p">;</span>
<span class="cp">#define ProtSpong(prot)  Y((prot)-&gt;bar)</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;No PROT_* configured.&quot;</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>Configuration parameters may not be used to vary implementations in C files.
For example, this sort of thing:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">map</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(MPS_OS_W3)</span>
  <span class="n">VirtualAlloc</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="cp">#elif defined(MPS_OS_SU)</span>
  <span class="n">mmap</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">frob</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;No implementation of map.&quot;</span>
<span class="cp">#endif</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This violates <a class="reference internal" href="#design.mps.config.no-spaghetti">.no-spaghetti</a>.</p>
</div>
</div>
<div class="section" id="to-document">
<h2>3.8. To document<a class="headerlink" href="#to-document" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>What about constants in config.h?</li>
<li>Update files to refer to this design document.</li>
<li>Explain the role of <tt class="docutils literal"><span class="pre">mps.c</span></tt></li>
<li>Reference to <tt class="docutils literal"><span class="pre">build.txt</span></tt></li>
<li>Procedures for adding an architecture, etc.</li>
<li>Reduce duplication in this document (especially after
<a class="reference internal" href="#configuration-parameters">Configuration Parameters</a> which looks like it&#8217;s been pasted in from
elsewhere.)</li>
</ul>
</div>
<div class="section" id="references">
<h2>3.9. References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils citation" frame="void" id="rb-2012-09-07" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[RB_2012-09-07]</a></td><td>Richard Brooksby. Ravenbrook Limited. 2012-09-07. &#8220;<a class="reference external" href="http://www.ravenbrook.com/project/mps/master/design/critical-path">The critical path through the MPS</a>&#8221;.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="rb-2012-09-13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[RB_2012-09-13]</a></td><td>Richard Brooksby. Ravenbrook Limited. 2013-09-13. &#8220;<a class="reference external" href="https://info.ravenbrook.com/mail/2012/09/13/16-43-35/0/">The Configura CET custom mainline</a>&#8221;.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="pp-2005-03-01" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[PP_2005-03-01]</td><td>Pekka Pirinen. Global Graphics. 2005-03-01. &#8220;<a class="reference external" href="https://info.ravenbrook.com/mail/2005/03/01/15-45-17/0/">MPS platforms</a>&#8221;.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3. MPS Configuration</a><ul>
<li><a class="reference internal" href="#introduction">3.1. Introduction</a></li>
<li><a class="reference internal" href="#requirements">3.2. Requirements</a><ul>
<li><a class="reference internal" href="#retired-requirements">3.2.1. Retired requirements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#definitions">3.3. Definitions</a></li>
<li><a class="reference internal" href="#overview">3.4. Overview</a></li>
<li><a class="reference internal" href="#the-build-system">3.5. The build system</a><ul>
<li><a class="reference internal" href="#abstract-build-function">3.5.1. Abstract build function</a></li>
<li><a class="reference internal" href="#file-structure">3.5.2. File Structure</a></li>
<li><a class="reference internal" href="#modules-and-naming">3.5.3. Modules and naming</a></li>
<li><a class="reference internal" href="#build-system-rationale">3.5.4. Build system rationale</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation">3.6. Implementation</a><ul>
<li><a class="reference internal" href="#target-platform-detection">3.6.1. Target platform detection</a></li>
<li><a class="reference internal" href="#target-varieties">3.6.2. Target varieties</a></li>
</ul>
</li>
<li><a class="reference internal" href="#source-code-configuration">3.7. Source code configuration</a><ul>
<li><a class="reference internal" href="#configuration-parameters">3.7.1. Configuration Parameters</a></li>
<li><a class="reference internal" href="#abstract-and-concrete-module-interfaces">3.7.2. Abstract and Concrete Module Interfaces</a></li>
</ul>
</li>
<li><a class="reference internal" href="#to-document">3.8. To document</a></li>
<li><a class="reference internal" href="#references">3.9. References</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="cbs.html"
                        title="previous chapter">2. Coalescing block structure</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="critical-path.html"
                        title="next chapter">4. The critical path through the MPS</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="critical-path.html" title="4. The critical path through the MPS"
             >next</a> |</li>
        <li class="right" >
          <a href="cbs.html" title="2. Coalescing block structure"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>