

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>2. Coalescing block structure &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Design" href="index.html" />
    <link rel="next" title="3. MPS Configuration" href="config.html" />
    <link rel="prev" title="1. Queue design" href="abq.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="config.html" title="3. MPS Configuration"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="abq.html" title="1. Queue design"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="coalescing-block-structure">
<h1>2. Coalescing block structure<a class="headerlink" href="#coalescing-block-structure" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.cbs"></span><h2>2.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.cbs.intro"></span><a class="mpstag reference internal" href="#design.mps.cbs.intro">.intro:</a> This is the design for impl.c.cbs, which implements a data
structure for the management of non-intersecting memory ranges, with
eager coalescence.</p>
<p><span class="target" id="design.mps.cbs.readership"></span><a class="mpstag reference internal" href="#design.mps.cbs.readership">.readership:</a> This document is intended for any MM developer.</p>
<p><span class="target" id="design.mps.cbs.source"></span><a class="mpstag reference internal" href="#design.mps.cbs.source">.source:</a> design.mps.poolmv2, design.mps.poolmvff.</p>
<p><span class="target" id="design.mps.cbs.overview"></span><a class="mpstag reference internal" href="#design.mps.cbs.overview">.overview:</a> The &#8220;coalescing block structure&#8221; is a set of addresses
(or a subset of address space), with provision for efficient
management of contiguous ranges, including insertion and deletion,
high level communication with the client about the size of contiguous
ranges, and detection of protocol violations.</p>
</div>
<div class="section" id="definitions">
<h2>2.2. Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.cbs.def.range"></span><a class="mpstag reference internal" href="#design.mps.cbs.def.range">.def.range:</a> A (contiguous) <em>range</em> of addresses is a semi-open
interval on address space.</p>
<p><span class="target" id="design.mps.cbs.def.isolated"></span><a class="mpstag reference internal" href="#design.mps.cbs.def.isolated">.def.isolated:</a> A contiguous range is <em>isolated</em> with respect to
some property it has, if adjacent elements do not have that property.</p>
</div>
<div class="section" id="requirements">
<h2>2.3. Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.cbs.req.set"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.set">.req.set:</a> Must maintain a set of addresses.</p>
<p><span class="target" id="design.mps.cbs.req.fast"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.fast">.req.fast:</a> Common operations must have a low amortized cost.</p>
<p><span class="target" id="design.mps.cbs.req.add"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.add">.req.add:</a> Must be able to add address ranges to the set.</p>
<p><span class="target" id="design.mps.cbs.req.remove"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.remove">.req.remove:</a> Must be able to remove address ranges from the set.</p>
<p><span class="target" id="design.mps.cbs.req.size"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.size">.req.size:</a> Must report concisely to the client when isolated
contiguous ranges of at least a certain size appear and disappear.</p>
<p><span class="target" id="design.mps.cbs.req.iterate"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.iterate">.req.iterate:</a> Must support the iteration of all isolated
contiguous ranges. This will not be a common operation.</p>
<p><span class="target" id="design.mps.cbs.req.protocol"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.protocol">.req.protocol:</a> Must detect protocol violations.</p>
<p><span class="target" id="design.mps.cbs.req.debug"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.debug">.req.debug:</a> Must support debugging of client code.</p>
<p><span class="target" id="design.mps.cbs.req.small"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.small">.req.small:</a> Must have a small space overhead for the storage of
typical subsets of address space and not have abysmal overhead for the
storage of any subset of address space.</p>
<p><span class="target" id="design.mps.cbs.req.align"></span><a class="mpstag reference internal" href="#design.mps.cbs.req.align">.req.align:</a> Must support an alignment (the alignment of all
addresses specifying ranges) of down to <tt class="docutils literal"><span class="pre">sizeof(void&nbsp;*)</span></tt> without
losing memory.</p>
</div>
<div class="section" id="interface">
<h2>2.4. Interface<a class="headerlink" href="#interface" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.cbs.header"></span><a class="mpstag reference internal" href="#design.mps.cbs.header">.header:</a> CBS is used through impl.h.cbs.</p>
<div class="section" id="external-types">
<h3>2.4.1. External types<a class="headerlink" href="#external-types" title="Permalink to this headline">¶</a></h3>
<dl class="type">
<dt id="CBS">
struct CBSStruct *<tt class="descname">CBS</tt><a class="headerlink" href="#CBS" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.type.cbs"></span><a class="mpstag reference internal" href="#design.mps.cbs.type.cbs">.type.cbs:</a> <a class="reference internal" href="#CBS" title="CBS"><tt class="xref c c-macro docutils literal"><span class="pre">CBS</span></tt></a> is the main data structure for manipulating a
CBS. It is intended that a <tt class="xref c c-type docutils literal"><span class="pre">CBSStruct</span></tt> be embedded in another
structure. No convenience functions are provided for the allocation or
deallocation of the CBS.</p>
<dl class="type">
<dt id="CBSIterateMethod">
<a class="reference internal" href="type.html#Bool" title="Bool">Bool</a> <tt class="descname">(*CBSIterateMethod)</tt><big>(</big><a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em>, <a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;range</em>, void<em>&nbsp;*closureP</em>, <a class="reference internal" href="type.html#Size" title="Size">Size</a><em>&nbsp;closureS</em><big>)</big><a class="headerlink" href="#CBSIterateMethod" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.type.cbs.iterate.method"></span><a class="mpstag reference internal" href="#design.mps.cbs.type.cbs.iterate.method">.type.cbs.iterate.method:</a> Type <a class="reference internal" href="#CBSIterateMethod" title="CBSIterateMethod"><tt class="xref c c-type docutils literal"><span class="pre">CBSIterateMethod</span></tt></a> is a callback
function that may be passed to <a class="reference internal" href="#CBSIterate" title="CBSIterate"><tt class="xref c c-func docutils literal"><span class="pre">CBSIterate()</span></tt></a>. It is called for
every isolated contiguous range in address order. The function must
returns a <a class="reference internal" href="type.html#Bool" title="Bool"><tt class="xref c c-type docutils literal"><span class="pre">Bool</span></tt></a> indicating whether to continue with the iteration.</p>
</div>
<div class="section" id="external-functions">
<h3>2.4.2. External functions<a class="headerlink" href="#external-functions" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="CBSInit">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">CBSInit</tt><big>(</big><a class="reference internal" href="arena.html#Arena" title="Arena">Arena</a><em>&nbsp;arena</em>, <a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em>, void<em>&nbsp;*owner</em>, <a class="reference internal" href="type.html#Align" title="Align">Align</a><em>&nbsp;alignment</em>, <a class="reference internal" href="type.html#Bool" title="Bool">Bool</a><em>&nbsp;fastFind</em>, ArgList<em>&nbsp;args</em><big>)</big><a class="headerlink" href="#CBSInit" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.function.cbs.init"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.init">.function.cbs.init:</a> <a class="reference internal" href="#CBSInit" title="CBSInit"><tt class="xref c c-func docutils literal"><span class="pre">CBSInit()</span></tt></a> is the function that initialises
the CBS structure. It performs allocation in the supplied arena. The
parameter <tt class="docutils literal"><span class="pre">owner</span></tt> is passed to <tt class="xref c c-func docutils literal"><span class="pre">MeterInit()</span></tt>, an <tt class="docutils literal"><span class="pre">alignment</span></tt>
indicates the alignment of ranges to be maintained. An initialised CBS
contains no ranges.</p>
<p><tt class="docutils literal"><span class="pre">fastFind</span></tt>, if set, causes the CBS to maintain, for each subtree,
the size of the largest block in that subtree. This must be true if
any of the <a class="reference internal" href="#CBSFindFirst" title="CBSFindFirst"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindFirst()</span></tt></a>, <a class="reference internal" href="#CBSFindLast" title="CBSFindLast"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindLast()</span></tt></a>, or
<a class="reference internal" href="#CBSFindLargest" title="CBSFindLargest"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindLargest()</span></tt></a> functions are going to be used on the CBS.</p>
<p><a class="reference internal" href="#CBSInit" title="CBSInit"><tt class="xref c c-func docutils literal"><span class="pre">CBSInit()</span></tt></a> may take one keyword argument:</p>
<ul class="simple">
<li><tt class="xref c c-macro docutils literal"><span class="pre">MPS_KEY_CBS_EXTEND_BY</span></tt> (type <a class="reference internal" href="type.html#Size" title="Size"><tt class="xref c c-type docutils literal"><span class="pre">Size</span></tt></a>; default 4096) is the size
of segment that the CBS will request from the arena in which to
allocate its <tt class="docutils literal"><span class="pre">CBSBlock</span></tt> structures.</li>
</ul>
<dl class="function">
<dt id="CBSFinish">
void <tt class="descname">CBSFinish</tt><big>(</big><a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em><big>)</big><a class="headerlink" href="#CBSFinish" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.function.cbs.finish"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.finish">.function.cbs.finish:</a> <a class="reference internal" href="#CBSFinish" title="CBSFinish"><tt class="xref c c-func docutils literal"><span class="pre">CBSFinish()</span></tt></a> is the function that finishes
the CBS structure and discards any other resources associated with the
CBS.</p>
<dl class="function">
<dt id="CBSInsert">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">CBSInsert</tt><big>(</big><a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;rangeReturn</em>, <a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em>, <a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;range</em><big>)</big><a class="headerlink" href="#CBSInsert" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.function.cbs.insert"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.insert">.function.cbs.insert:</a> If any part of <tt class="docutils literal"><span class="pre">range</span></tt> is already in the
CBS, then leave it unchanged and return <tt class="docutils literal"><span class="pre">ResFAIL</span></tt>. Otherwise,
attempt to insert <tt class="docutils literal"><span class="pre">range</span></tt> into the CBS. If the insertion succeeds,
then update <tt class="docutils literal"><span class="pre">rangeReturn</span></tt> to describe the contiguous isolated range
containing the inserted range (this may differ from <tt class="docutils literal"><span class="pre">range</span></tt> if there
was coalescence on either side) and return <tt class="docutils literal"><span class="pre">ResOK</span></tt>. If the insertion
fails, return a result code indicating allocation failure.</p>
<p><span class="target" id="design.mps.cbs.function.cbs.insert.fail"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.insert.fail">.function.cbs.insert.fail:</a> Insertion of a valid range (that is, one
that does not overlap with any range in the CBS) can only fail if the
new range is isolated and the allocation of the necessary data
structure to represent it failed.</p>
<dl class="function">
<dt id="CBSDelete">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">CBSDelete</tt><big>(</big><a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;rangeReturn</em>, <a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em>, <a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;range</em><big>)</big><a class="headerlink" href="#CBSDelete" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.function.cbs.delete"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.delete">.function.cbs.delete:</a> If any part of the range is not in the CBS,
then leave the CBS unchanged and return <tt class="docutils literal"><span class="pre">ResFAIL</span></tt>. Otherwise, update
<tt class="docutils literal"><span class="pre">rangeReturn</span></tt> to describe the contiguous isolated range that
contains <tt class="docutils literal"><span class="pre">range</span></tt> (this may differ from <tt class="docutils literal"><span class="pre">range</span></tt> if there are
fragments on either side) and attempt to delete the range from the
CBS. If the deletion succeeds, return <tt class="docutils literal"><span class="pre">ResOK</span></tt>. If the deletion
fails, return a result code indicating allocation failure.</p>
<p><span class="target" id="design.mps.cbs.function.cbs.delete.fail"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.delete.fail">.function.cbs.delete.fail:</a> Deletion of a valid range (that is, one
that is wholly contained in the CBS) can only fail if there are
fragments on both sides and the allocation of the necessary data
structures to represent them fails.</p>
<p><span class="target" id="design.mps.cbs.function.cbs.delete.return"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.delete.return">.function.cbs.delete.return:</a> <a class="reference internal" href="#CBSDelete" title="CBSDelete"><tt class="xref c c-func docutils literal"><span class="pre">CBSDelete()</span></tt></a> returns the contiguous
isolated range that contains <tt class="docutils literal"><span class="pre">range</span></tt> even if the deletion fails.
This is so that the caller can try deleting the whole block (which is
guaranteed to succeed) and managing the fragments using a fallback
strategy.</p>
<dl class="function">
<dt id="CBSIterate">
void <tt class="descname">CBSIterate</tt><big>(</big><a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em>, <a class="reference internal" href="#CBSIterateMethod" title="CBSIterateMethod">CBSIterateMethod</a><em>&nbsp;iterate</em>, void<em>&nbsp;*closureP</em>, <a class="reference internal" href="type.html#Size" title="Size">Size</a><em>&nbsp;closureS</em><big>)</big><a class="headerlink" href="#CBSIterate" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.function.cbs.iterate"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.iterate">.function.cbs.iterate:</a> <a class="reference internal" href="#CBSIterate" title="CBSIterate"><tt class="xref c c-func docutils literal"><span class="pre">CBSIterate()</span></tt></a> is the function used to
iterate all isolated contiguous ranges in a CBS. It receives a
pointer, <a class="reference internal" href="type.html#Size" title="Size"><tt class="xref c c-type docutils literal"><span class="pre">Size</span></tt></a> closure pair to pass on to the iterator method,
and an iterator method to invoke on every range in address order. If
the iterator method returns <tt class="xref c c-macro docutils literal"><span class="pre">FALSE</span></tt>, then the iteration is
terminated.</p>
<dl class="function">
<dt id="CBSDescribe">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">CBSDescribe</tt><big>(</big><a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em>, <a class="reference internal" href="../topic/plinth.html#mps_lib_FILE" title="mps_lib_FILE">mps_lib_FILE</a><em>&nbsp;*stream</em><big>)</big><a class="headerlink" href="#CBSDescribe" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.function.cbs.describe"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.describe">.function.cbs.describe:</a> <a class="reference internal" href="#CBSDescribe" title="CBSDescribe"><tt class="xref c c-func docutils literal"><span class="pre">CBSDescribe()</span></tt></a> is a function that prints
a textual representation of the CBS to the given stream, indicating
the contiguous ranges in order, as well as the structure of the
underlying splay tree implementation. It is provided for debugging
purposes only.</p>
<dl class="function">
<dt id="CBSFindFirst">
<a class="reference internal" href="type.html#Bool" title="Bool">Bool</a> <tt class="descname">CBSFindFirst</tt><big>(</big><a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;rangeReturn</em>, <a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;oldRangeReturn</em>, <a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em>, <a class="reference internal" href="type.html#Size" title="Size">Size</a><em>&nbsp;size</em>, FindDelete<em>&nbsp;findDelete</em><big>)</big><a class="headerlink" href="#CBSFindFirst" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.function.cbs.find.first"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.find.first">.function.cbs.find.first:</a> Locate the first block (in address order)
within the CBS of at least the specified size, update <tt class="docutils literal"><span class="pre">rangeReturn</span></tt>
to describe that range, and return <tt class="xref c c-macro docutils literal"><span class="pre">TRUE</span></tt>. If there is no such
block, it returns <tt class="xref c c-macro docutils literal"><span class="pre">FALSE</span></tt>.</p>
<p>In addition, optionally delete the top, bottom, or all of the found
range, depending on the <tt class="docutils literal"><span class="pre">findDelete</span></tt> argument. This saves a separate
call to <a class="reference internal" href="#CBSDelete" title="CBSDelete"><tt class="xref c c-func docutils literal"><span class="pre">CBSDelete()</span></tt></a>, and uses the knowledge of exactly where we
found the range. The value of <tt class="docutils literal"><span class="pre">findDelete</span></tt> must come from this
enumeration:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">enum</span> <span class="p">{</span>
    <span class="n">FindDeleteNONE</span><span class="p">,</span>    <span class="cm">/* don&#39;t delete after finding */</span>
    <span class="n">FindDeleteLOW</span><span class="p">,</span>     <span class="cm">/* delete size bytes from low end of block */</span>
    <span class="n">FindDeleteHIGH</span><span class="p">,</span>    <span class="cm">/* delete size bytes from high end of block */</span>
    <span class="n">FindDeleteENTIRE</span>   <span class="cm">/* delete entire range */</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The original contiguous isolated range in which the range was found is
returned via the <tt class="docutils literal"><span class="pre">oldRangeReturn</span></tt> argument. (If <tt class="docutils literal"><span class="pre">findDelete</span></tt> is
<tt class="docutils literal"><span class="pre">FindDeleteNONE</span></tt> or <tt class="docutils literal"><span class="pre">FindDeleteENTIRE</span></tt>, then this will be
identical to the range returned via the <tt class="docutils literal"><span class="pre">rangeReturn</span></tt> argument.)</p>
<p><a class="reference internal" href="#CBSFindFirst" title="CBSFindFirst"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindFirst()</span></tt></a> requires that <tt class="docutils literal"><span class="pre">fastFind</span></tt> was true when
<a class="reference internal" href="#CBSInit" title="CBSInit"><tt class="xref c c-func docutils literal"><span class="pre">CBSInit()</span></tt></a> was called.</p>
<dl class="function">
<dt id="CBSFindLast">
<a class="reference internal" href="type.html#Bool" title="Bool">Bool</a> <tt class="descname">CBSFindLast</tt><big>(</big><a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;rangeReturn</em>, <a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;oldRangeReturn</em>, <a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em>, <a class="reference internal" href="type.html#Size" title="Size">Size</a><em>&nbsp;size</em>, FindDelete<em>&nbsp;findDelete</em><big>)</big><a class="headerlink" href="#CBSFindLast" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.function.cbs.find.last"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.find.last">.function.cbs.find.last:</a> Like <a class="reference internal" href="#CBSFindFirst" title="CBSFindFirst"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindFirst()</span></tt></a>, except that it
finds the last block in address order.</p>
<dl class="function">
<dt id="CBSFindLargest">
<a class="reference internal" href="type.html#Bool" title="Bool">Bool</a> <tt class="descname">CBSFindLargest</tt><big>(</big><a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;rangeReturn</em>, <a class="reference internal" href="range.html#Range" title="Range">Range</a><em>&nbsp;oldRangeReturn</em>, <a class="reference internal" href="#CBS" title="CBS">CBS</a><em>&nbsp;cbs</em>, <a class="reference internal" href="type.html#Size" title="Size">Size</a><em>&nbsp;size</em>, FindDelete<em>&nbsp;findDelete</em><big>)</big><a class="headerlink" href="#CBSFindLargest" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.cbs.function.cbs.find.largest"></span><a class="mpstag reference internal" href="#design.mps.cbs.function.cbs.find.largest">.function.cbs.find.largest:</a> Locate the largest block within the
CBS, and if that block is at least as big as <tt class="docutils literal"><span class="pre">size</span></tt>, return its
range via the <tt class="docutils literal"><span class="pre">rangeReturn</span></tt> argument, and return <tt class="xref c c-macro docutils literal"><span class="pre">TRUE</span></tt>. If there
are no blocks in the CBS at least as large as <tt class="docutils literal"><span class="pre">size</span></tt>, return
<tt class="xref c c-macro docutils literal"><span class="pre">FALSE</span></tt>. Pass 0 for <tt class="docutils literal"><span class="pre">size</span></tt> if you want the largest block
unconditionally.</p>
<p>Like <a class="reference internal" href="#CBSFindFirst" title="CBSFindFirst"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindFirst()</span></tt></a>, optionally delete the range (specifying
<tt class="docutils literal"><span class="pre">FindDeleteLOW</span></tt> or <tt class="docutils literal"><span class="pre">FindDeleteHIGH</span></tt> has the same effect as
<tt class="docutils literal"><span class="pre">FindDeleteENTIRE</span></tt>). This feature requires that <tt class="docutils literal"><span class="pre">fastFind</span></tt> was
true when <a class="reference internal" href="#CBSInit" title="CBSInit"><tt class="xref c c-func docutils literal"><span class="pre">CBSInit()</span></tt></a> was called.</p>
</div>
</div>
<div class="section" id="implementation">
<h2>2.5. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.cbs.impl"></span><a class="mpstag reference internal" href="#design.mps.cbs.impl">.impl:</a> This section is concerned with describing various aspects of
the implementation. It does not form part of the interface definition.</p>
<div class="section" id="splay-tree">
<h3>2.5.1. Splay tree<a class="headerlink" href="#splay-tree" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.cbs.impl.splay"></span><a class="mpstag reference internal" href="#design.mps.cbs.impl.splay">.impl.splay:</a> The CBS is principally implemented using a splay tree
(see <a class="reference external" href="splay">design.mps.splay</a>). Each splay tree node is embedded in a
<tt class="docutils literal"><span class="pre">CBSBlock</span></tt> that represents a semi-open address range. The key passed
for comparison is the base of another range.</p>
<p><span class="target" id="design.mps.cbs.impl.splay.fast-find"></span><a class="mpstag reference internal" href="#design.mps.cbs.impl.splay.fast-find">.impl.splay.fast-find:</a> <a class="reference internal" href="#CBSFindFirst" title="CBSFindFirst"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindFirst()</span></tt></a> and <a class="reference internal" href="#CBSFindLast" title="CBSFindLast"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindLast()</span></tt></a> use
the update/refresh facility of splay trees to store, in each
<tt class="docutils literal"><span class="pre">CBSBlock</span></tt>, an accurate summary of the maximum block size in the
tree rooted at the corresponding splay node. This allows rapid
location of the first or last suitable block, and very rapid failure
if there is no suitable block.</p>
<p><span class="target" id="design.mps.cbs.impl.find-largest"></span><a class="mpstag reference internal" href="#design.mps.cbs.impl.find-largest">.impl.find-largest:</a> <a class="reference internal" href="#CBSFindLargest" title="CBSFindLargest"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindLargest()</span></tt></a> simply finds out the size
of the largest block in the CBS from the root of the tree, using
<a class="reference internal" href="splay.html#SplayRoot" title="SplayRoot"><tt class="xref c c-func docutils literal"><span class="pre">SplayRoot()</span></tt></a>, and does <a class="reference internal" href="splay.html#SplayFindFirst" title="SplayFindFirst"><tt class="xref c c-func docutils literal"><span class="pre">SplayFindFirst()</span></tt></a> for a block of that
size. This is O(log&nbsp;<em>n</em>) in the size of the free list, so it&#8217;s about
the best you can do without maintaining a separate priority queue,
just to do <a class="reference internal" href="#CBSFindLargest" title="CBSFindLargest"><tt class="xref c c-func docutils literal"><span class="pre">CBSFindLargest()</span></tt></a>.</p>
</div>
<div class="section" id="low-memory-behaviour">
<h3>2.5.2. Low memory behaviour<a class="headerlink" href="#low-memory-behaviour" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.cbs.impl.low-mem"></span><a class="mpstag reference internal" href="#design.mps.cbs.impl.low-mem">.impl.low-mem:</a> When the CBS tries to allocate a new <tt class="docutils literal"><span class="pre">CBSBlock</span></tt>
structure for a new isolated range as a result of either
<a class="reference internal" href="#CBSInsert" title="CBSInsert"><tt class="xref c c-func docutils literal"><span class="pre">CBSInsert()</span></tt></a> or <a class="reference internal" href="#CBSDelete" title="CBSDelete"><tt class="xref c c-func docutils literal"><span class="pre">CBSDelete()</span></tt></a>, and there is insufficient memory
to allocation the <tt class="docutils literal"><span class="pre">CBSBlock</span></tt> structure, then the range is not added
to the CBS or deleted from it, and the call to <a class="reference internal" href="#CBSInsert" title="CBSInsert"><tt class="xref c c-func docutils literal"><span class="pre">CBSInsert()</span></tt></a> or
<a class="reference internal" href="#CBSDelete" title="CBSDelete"><tt class="xref c c-func docutils literal"><span class="pre">CBSDelete()</span></tt></a> returns <tt class="docutils literal"><span class="pre">ResMEMORY</span></tt>.</p>
</div>
<div class="section" id="the-cbs-block">
<h3>2.5.3. The CBS block<a class="headerlink" href="#the-cbs-block" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.cbs.impl.cbs.block"></span><a class="mpstag reference internal" href="#design.mps.cbs.impl.cbs.block">.impl.cbs.block:</a> The block contains a base-limit pair and a splay
tree node.</p>
<p><span class="target" id="design.mps.cbs.impl.cbs.block.special"></span><a class="mpstag reference internal" href="#design.mps.cbs.impl.cbs.block.special">.impl.cbs.block.special:</a> The base and limit may be equal if the
block is halfway through being deleted.</p>
<p><span class="target" id="design.mps.cbs.impl.cbs.block.special.just"></span><a class="mpstag reference internal" href="#design.mps.cbs.impl.cbs.block.special.just">.impl.cbs.block.special.just:</a> This conflates values and status, but
is justified because block size is very important.</p>
</div>
</div>
<div class="section" id="testing">
<h2>2.6. Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.cbs.test"></span><a class="mpstag reference internal" href="#design.mps.cbs.test">.test:</a> The following testing will be performed on this module:</p>
<p><span class="target" id="design.mps.cbs.test.cbstest"></span><a class="mpstag reference internal" href="#design.mps.cbs.test.cbstest">.test.cbstest:</a> There is a stress test for this module in
impl.c.cbstest. This allocates a large block of memory and then
simulates the allocation and deallocation of ranges within this block
using both a <a class="reference internal" href="#CBS" title="CBS"><tt class="xref c c-macro docutils literal"><span class="pre">CBS</span></tt></a> and a <a class="reference internal" href="bt.html#BT" title="BT"><tt class="xref c c-type docutils literal"><span class="pre">BT</span></tt></a>. It makes both valid and invalid
requests, and compares the <a class="reference internal" href="#CBS" title="CBS"><tt class="xref c c-macro docutils literal"><span class="pre">CBS</span></tt></a> response to the correct behaviour
as determined by the <a class="reference internal" href="bt.html#BT" title="BT"><tt class="xref c c-type docutils literal"><span class="pre">BT</span></tt></a>. It also iterates the ranges in the
<a class="reference internal" href="#CBS" title="CBS"><tt class="xref c c-macro docutils literal"><span class="pre">CBS</span></tt></a>, comparing them to the <a class="reference internal" href="bt.html#BT" title="BT"><tt class="xref c c-type docutils literal"><span class="pre">BT</span></tt></a>. It also invokes the
<a class="reference internal" href="#CBSDescribe" title="CBSDescribe"><tt class="xref c c-func docutils literal"><span class="pre">CBSDescribe()</span></tt></a> method, but makes no automatic test of the resulting
output. It does not currently test the callbacks.</p>
<p><span class="target" id="design.mps.cbs.test.pool"></span><a class="mpstag reference internal" href="#design.mps.cbs.test.pool">.test.pool:</a> Several pools (currently <a class="reference external" href="poolmvt">MVT</a> and <a class="reference external" href="poolmvff">MVFF</a>) are implemented
on top of a CBS. These pool are subject to testing in development, QA,
and are/will be heavily exercised by customers.</p>
</div>
<div class="section" id="notes-for-future-development">
<h2>2.7. Notes for future development<a class="headerlink" href="#notes-for-future-development" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.cbs.future.not-splay"></span><a class="mpstag reference internal" href="#design.mps.cbs.future.not-splay">.future.not-splay:</a> The initial implementation of CBSs is based on
splay trees. It could be revised to use any other data structure that
meets the requirements (especially <a class="reference internal" href="#design.mps.cbs.req.fast">.req.fast</a>).</p>
<p><span class="target" id="design.mps.cbs.future.hybrid"></span><a class="mpstag reference internal" href="#design.mps.cbs.future.hybrid">.future.hybrid:</a> It would be possible to attenuate the problem of
<a class="reference internal" href="#design.mps.cbs.risk.overhead">.risk.overhead</a> (below) by using a single word bit set to represent
the membership in a (possibly aligned) word-width of grains. This
might be used for block sizes less than a word-width of grains,
converting them when they reach all free in the bit set. Note that
this would make coalescence slightly less eager, by up to
<tt class="docutils literal"><span class="pre">(word-width</span> <span class="pre">-</span> <span class="pre">1)</span></tt>.</p>
</div>
<div class="section" id="risks">
<h2>2.8. Risks<a class="headerlink" href="#risks" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.cbs.risk.overhead"></span><a class="mpstag reference internal" href="#design.mps.cbs.risk.overhead">.risk.overhead:</a> Clients should note that the current implementation
of CBSs has a space overhead proportional to the number of isolated
contiguous ranges. [Four words per range.] If the CBS contains every
other grain in an area, then the overhead will be large compared to
the size of that area. [Four words per two grains.] The CBS structure
is thus suitable only for managing large enough ranges.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">2. Coalescing block structure</a><ul>
<li><a class="reference internal" href="#introduction">2.1. Introduction</a></li>
<li><a class="reference internal" href="#definitions">2.2. Definitions</a></li>
<li><a class="reference internal" href="#requirements">2.3. Requirements</a></li>
<li><a class="reference internal" href="#interface">2.4. Interface</a><ul>
<li><a class="reference internal" href="#external-types">2.4.1. External types</a></li>
<li><a class="reference internal" href="#external-functions">2.4.2. External functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation">2.5. Implementation</a><ul>
<li><a class="reference internal" href="#splay-tree">2.5.1. Splay tree</a></li>
<li><a class="reference internal" href="#low-memory-behaviour">2.5.2. Low memory behaviour</a></li>
<li><a class="reference internal" href="#the-cbs-block">2.5.3. The CBS block</a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing">2.6. Testing</a></li>
<li><a class="reference internal" href="#notes-for-future-development">2.7. Notes for future development</a></li>
<li><a class="reference internal" href="#risks">2.8. Risks</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="abq.html"
                        title="previous chapter">1. Queue design</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="config.html"
                        title="next chapter">3. MPS Configuration</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="config.html" title="3. MPS Configuration"
             >next</a> |</li>
        <li class="right" >
          <a href="abq.html" title="1. Queue design"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>