

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>10. Ring data structure &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Design" href="index.html" />
    <link rel="next" title="11. Signatures in the MPS" href="sig.html" />
    <link rel="prev" title="9. Ranges" href="range.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="sig.html" title="11. Signatures in the MPS"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="range.html" title="9. Ranges"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="ring-data-structure">
<span id="design-ring"></span><span id="index-0"></span><h1>10. Ring data structure<a class="headerlink" href="#ring-data-structure" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.ring"></span><h2>10.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.ring.source"></span><a class="mpstag reference internal" href="#design.mps.ring.source">.source:</a> rings are derived from the earlier use of Deques. See
design.mps.deque.</p>
</div>
<div class="section" id="description">
<h2>10.2. Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<dl class="type">
<dt id="Ring">
RingStruct *<tt class="descname">Ring</tt><a class="headerlink" href="#Ring" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.ring.def.ring"></span><a class="mpstag reference internal" href="#design.mps.ring.def.ring">.def.ring:</a> Rings are circular doubly-linked lists of ring &#8220;nodes&#8221;.
The nodes are fields of structures which are the &#8220;elements&#8221; of the
ring.</p>
<p>Ring node structures (<tt class="xref c c-type docutils literal"><span class="pre">RingStruct</span></tt>) are inlined in the structures on
the ring, like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">FooStruct</span> <span class="o">*</span><span class="n">Foo</span><span class="p">;</span>     <span class="cm">/* the element type */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">FooStruct</span> <span class="p">{</span>         <span class="cm">/* the element structure */</span>
  <span class="kt">int</span> <span class="n">baz</span><span class="p">,</span> <span class="n">bim</span><span class="p">;</span>
  <span class="n">RingStruct</span> <span class="n">ring</span><span class="p">;</span>                 <span class="cm">/* the ring node */</span>
  <span class="kt">float</span> <span class="n">bip</span><span class="p">,</span> <span class="n">bop</span><span class="p">;</span>
<span class="p">}</span> <span class="n">FooStruct</span><span class="p">;</span>
</pre></div>
</div>
<p>This arrangement means that they do not need to be managed separately.
This is especially useful in avoiding re-entrancy and bootstrapping
problems in the memory manager. Rings also provide flexible insertion
and deletion because the entire ring can be found from any node.</p>
<p>In the MPS, rings are used to connect a &#8220;parent&#8221; structure (such as a
<a class="reference internal" href="arena.html#Arena" title="Arena"><tt class="xref c c-type docutils literal"><span class="pre">Arena</span></tt></a>) to a number of &#8220;child&#8221; structures (such as <tt class="xref c c-type docutils literal"><span class="pre">Pool</span></tt>), as
shown in <a class="reference internal" href="#design.mps.ring.fig.ring">.fig.ring</a>. Note the slight abuse of naming convention, in
that <tt class="docutils literal"><span class="pre">barRing</span></tt> is not called <tt class="docutils literal"><span class="pre">barRingStruct</span></tt>.</p>
<p><span class="target" id="design.mps.ring.fig.ring"></span><a class="mpstag reference internal" href="#design.mps.ring.fig.ring">.fig.ring:</a> A ring of <tt class="docutils literal"><span class="pre">Bar</span></tt> objects owned by a <tt class="docutils literal"><span class="pre">Foo</span></tt> object.</p>
<p>[missing figure]</p>
<p><span class="target" id="design.mps.ring.fig.empty"></span><a class="mpstag reference internal" href="#design.mps.ring.fig.empty">.fig.empty:</a> An empty ring of <tt class="docutils literal"><span class="pre">Bar</span></tt> objects owned by a <tt class="docutils literal"><span class="pre">Foo</span></tt>
object.</p>
<p>[missing figure]</p>
<p><span class="target" id="design.mps.ring.def.singleton"></span><a class="mpstag reference internal" href="#design.mps.ring.def.singleton">.def.singleton:</a> A &#8220;singleton&#8221; ring is a ring containing one node,
whose previous and next nodes are itself (see <a class="reference internal" href="#design.mps.ring.fig.single">.fig.single</a>).</p>
<p><span class="target" id="design.mps.ring.fig.single"></span><a class="mpstag reference internal" href="#design.mps.ring.fig.single">.fig.single:</a> A singleton <tt class="docutils literal"><span class="pre">Bar</span></tt> object not on any ring.</p>
<p>[missing figure]</p>
<p><span class="target" id="design.mps.ring.fig.elt"></span><a class="mpstag reference internal" href="#design.mps.ring.fig.elt">.fig.elt:</a> How <a class="reference internal" href="#RING_ELT" title="RING_ELT"><tt class="xref c c-func docutils literal"><span class="pre">RING_ELT()</span></tt></a> gets a parent pointer from a node pointer.</p>
<p>[missing figure]</p>
</div>
<div class="section" id="init-finish">
<h2>10.3. Init / Finish<a class="headerlink" href="#init-finish" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="RingInit">
void <tt class="descname">RingInit</tt><big>(</big><a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;ring</em><big>)</big><a class="headerlink" href="#RingInit" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.ring.init"></span><a class="mpstag reference internal" href="#design.mps.ring.init">.init:</a> Rings are initialized with the <a class="reference internal" href="#RingInit" title="RingInit"><tt class="xref c c-func docutils literal"><span class="pre">RingInit()</span></tt></a> function. They
are initialized to be a singleton ring (<a class="reference internal" href="#design.mps.ring.def.singleton">.def.singleton</a>).</p>
<dl class="function">
<dt id="RingFinish">
void <tt class="descname">RingFinish</tt><big>(</big><a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;ring</em><big>)</big><a class="headerlink" href="#RingFinish" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.ring.finish"></span><a class="mpstag reference internal" href="#design.mps.ring.finish">.finish:</a> Rings are finished with the <a class="reference internal" href="#RingFinish" title="RingFinish"><tt class="xref c c-func docutils literal"><span class="pre">RingFinish()</span></tt></a> function. A
ring must be a singleton ring before it can be finished (it is an
error to attempt to finish a non-singleton ring).</p>
</div>
<div class="section" id="iteration">
<h2>10.4. Iteration<a class="headerlink" href="#iteration" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="RING_FOR">
<tt class="descname">RING_FOR</tt><big>(</big><a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;node</em>, <a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;ring</em>, <a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;next</em><big>)</big><a class="headerlink" href="#RING_FOR" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.ring.for"></span><a class="mpstag reference internal" href="#design.mps.ring.for">.for:</a> A macro is used for iterating over the elements in a ring.
This macro is called <a class="reference internal" href="#RING_FOR" title="RING_FOR"><tt class="xref c c-func docutils literal"><span class="pre">RING_FOR()</span></tt></a>. <a class="reference internal" href="#RING_FOR" title="RING_FOR"><tt class="xref c c-func docutils literal"><span class="pre">RING_FOR()</span></tt></a> takes three arguments.
The first is an iteration variable: <tt class="docutils literal"><span class="pre">node</span></tt>. The second is the
&#8220;parent&#8221; element in the ring: <tt class="docutils literal"><span class="pre">ring</span></tt>. The third is a variable used
by the iterator for working state (it holds a pointer to the next
node): <tt class="docutils literal"><span class="pre">next</span></tt>. All arguments must be of type <a class="reference internal" href="#Ring" title="Ring"><tt class="xref c c-type docutils literal"><span class="pre">Ring</span></tt></a>. The <tt class="docutils literal"><span class="pre">node</span></tt>
and <tt class="docutils literal"><span class="pre">next</span></tt> variables must be declared and in scope already. All
elements except for the &#8220;parent&#8221; element are iterated over. The macro
expands to a <tt class="docutils literal"><span class="pre">for</span></tt> statement. During execution of the loop, the
<tt class="docutils literal"><span class="pre">node</span></tt> variable (the first argument to the macro) will be the value
of successive elements in the Ring (at the beginning of the statement
in the body of the loop).</p>
<p><span class="target" id="design.mps.ring.for.error"></span><a class="mpstag reference internal" href="#design.mps.ring.for.error">.for.error:</a> It is an error (possibly unchecked) for the <tt class="docutils literal"><span class="pre">node</span></tt>
and <tt class="docutils literal"><span class="pre">next</span></tt> variables to be modified except implicitly by using this
iterator.</p>
<p><span class="target" id="design.mps.ring.for.safe"></span><a class="mpstag reference internal" href="#design.mps.ring.for.safe">.for.safe:</a> It is safe to delete the current node during the
iteration.</p>
<p><span class="target" id="design.mps.ring.for.ex"></span><a class="mpstag reference internal" href="#design.mps.ring.for.ex">.for.ex:</a> An example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">Ring</span> <span class="n">node</span><span class="p">,</span> <span class="n">nextNode</span><span class="p">;</span>
<span class="n">RING_FOR</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">foo</span><span class="o">-&gt;</span><span class="n">barRing</span><span class="p">,</span> <span class="n">nextNode</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Bar</span> <span class="n">bar</span> <span class="o">=</span> <span class="n">RING_ELT</span><span class="p">(</span><span class="n">Bar</span><span class="p">,</span> <span class="n">FooRing</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
  <span class="n">frob</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.ring.for.ex.elt"></span><a class="mpstag reference internal" href="#design.mps.ring.for.ex.elt">.for.ex.elt:</a> Notice the idiomatic use of <a class="reference internal" href="#RING_ELT" title="RING_ELT"><tt class="xref c c-func docutils literal"><span class="pre">RING_ELT()</span></tt></a> which is
almost universal when using <a class="reference internal" href="#RING_FOR" title="RING_FOR"><tt class="xref c c-func docutils literal"><span class="pre">RING_FOR()</span></tt></a>.</p>
</div>
<div class="section" id="subclass">
<h2>10.5. Subclass<a class="headerlink" href="#subclass" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="RING_ELT">
<tt class="descname">RING_ELT</tt><big>(</big>type, field, <a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;node</em><big>)</big><a class="headerlink" href="#RING_ELT" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.ring.elt"></span><a class="mpstag reference internal" href="#design.mps.ring.elt">.elt:</a> <a class="reference internal" href="#RING_ELT" title="RING_ELT"><tt class="xref c c-func docutils literal"><span class="pre">RING_ELT()</span></tt></a> is a macro that converts a pointer to a ring
structure into a pointer to the enclosing parent structure.
<a class="reference internal" href="#RING_ELT" title="RING_ELT"><tt class="xref c c-func docutils literal"><span class="pre">RING_ELT()</span></tt></a> has three arguments which are, in order: <tt class="docutils literal"><span class="pre">type</span></tt>, the
type of a pointer to the enclosing structure, <tt class="docutils literal"><span class="pre">field</span></tt>, the name of
the ring structure field within it, <tt class="docutils literal"><span class="pre">ring</span></tt>, the ring node. The
result is a pointer to the enclosing structure.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference internal" href="#RING_ELT" title="RING_ELT"><tt class="xref c c-func docutils literal"><span class="pre">RING_ELT()</span></tt></a> does not work for arrays of rings.</p>
</div>
</div>
<div class="section" id="append-remove">
<h2>10.6. Append / Remove<a class="headerlink" href="#append-remove" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="RingAppend">
void <tt class="descname">RingAppend</tt><big>(</big><a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;ring</em>, <a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;new</em><big>)</big><a class="headerlink" href="#RingAppend" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.ring.append"></span><a class="mpstag reference internal" href="#design.mps.ring.append">.append:</a> <a class="reference internal" href="#RingAppend" title="RingAppend"><tt class="xref c c-func docutils literal"><span class="pre">RingAppend()</span></tt></a> appends a singleton ring to a ring (such
that the newly added element will be last in the iteration sequence).</p>
<dl class="function">
<dt id="(RingInsert)">
void <tt class="descname">(RingInsert)</tt><big>(</big><a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;ring</em>, <a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;new</em><big>)</big><a class="headerlink" href="#(RingInsert)" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.ring.insert"></span><a class="mpstag reference internal" href="#design.mps.ring.insert">.insert:</a> <tt class="xref c c-func docutils literal"><span class="pre">RingInsert()</span></tt> adds a singleton rung to a ring (such that
the newly added element will be first in the iteration sequence).</p>
<dl class="function">
<dt id="(RingRemove)">
void <tt class="descname">(RingRemove)</tt><big>(</big><a class="reference internal" href="#Ring" title="Ring">Ring</a><em>&nbsp;old</em><big>)</big><a class="headerlink" href="#(RingRemove)" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.ring.remove"></span><a class="mpstag reference internal" href="#design.mps.ring.remove">.remove:</a> <tt class="xref c c-func docutils literal"><span class="pre">RingRemove()</span></tt> removes an element from a ring. The newly
removed element becomes a singleton ring. It is an error for the
element to already be a singleton.</p>
<p><span class="target" id="design.mps.ring.improve.join"></span><a class="mpstag reference internal" href="#design.mps.ring.improve.join">.improve.join:</a> It would be possible to add a <tt class="xref c c-func docutils literal"><span class="pre">RingJoin()</span></tt> operation
that joined two rings. This is not done as it is not required.</p>
</div>
<div class="section" id="naming">
<h2>10.7. Naming<a class="headerlink" href="#naming" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.ring.naming"></span><a class="mpstag reference internal" href="#design.mps.ring.naming">.naming:</a> By convention, when one structure <tt class="docutils literal"><span class="pre">Foo</span></tt> contains one
ring of <tt class="docutils literal"><span class="pre">Bar</span></tt> structures, the field in <tt class="docutils literal"><span class="pre">Foo</span></tt> is usually known as
<tt class="docutils literal"><span class="pre">barRing</span></tt>, and the field in <tt class="docutils literal"><span class="pre">Bar</span></tt> is known as <tt class="docutils literal"><span class="pre">fooRing</span></tt>. If the
<tt class="docutils literal"><span class="pre">Foo</span></tt> structure contains more than one ring of <tt class="docutils literal"><span class="pre">Bar</span></tt> structures,
then they will have names such as <tt class="docutils literal"><span class="pre">spongRing</span></tt> and <tt class="docutils literal"><span class="pre">frobRing</span></tt>.</p>
</div>
<div class="section" id="deques">
<h2>10.8. Deques<a class="headerlink" href="#deques" title="Permalink to this headline">¶</a></h2>
<p>This section documents where rings differ significantly from deques.</p>
<p><span class="target" id="design.mps.ring.head"></span><a class="mpstag reference internal" href="#design.mps.ring.head">.head:</a> Deques used a distinguished head structure for the head of
the ring. Rings still have a separate head structure, but it is not
distinguished by type.</p>
</div>
<div class="section" id="defects">
<h2>10.9. Defects<a class="headerlink" href="#defects" title="Permalink to this headline">¶</a></h2>
<p>This section documents known defects with the current design.</p>
<p><span class="target" id="design.mps.ring.app_for.misuse"></span><a class="mpstag reference internal" href="#design.mps.ring.app_for.misuse">.app_for.misuse:</a> It is easy to pass <a class="reference internal" href="#RingAppend" title="RingAppend"><tt class="xref c c-func docutils literal"><span class="pre">RingAppend()</span></tt></a> and
<a class="reference internal" href="#RING_FOR" title="RING_FOR"><tt class="xref c c-func docutils literal"><span class="pre">RING_FOR()</span></tt></a> the arguments in the wrong order as all the arguments
have the same type. see <a class="reference internal" href="#design.mps.ring.head">.head</a>.</p>
<p><span class="target" id="design.mps.ring.check.improve"></span><a class="mpstag reference internal" href="#design.mps.ring.check.improve">.check.improve:</a> There is no method for performing a full integrity
check. This could be added.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">10. Ring data structure</a><ul>
<li><a class="reference internal" href="#introduction">10.1. Introduction</a></li>
<li><a class="reference internal" href="#description">10.2. Description</a></li>
<li><a class="reference internal" href="#init-finish">10.3. Init / Finish</a></li>
<li><a class="reference internal" href="#iteration">10.4. Iteration</a></li>
<li><a class="reference internal" href="#subclass">10.5. Subclass</a></li>
<li><a class="reference internal" href="#append-remove">10.6. Append / Remove</a></li>
<li><a class="reference internal" href="#naming">10.7. Naming</a></li>
<li><a class="reference internal" href="#deques">10.8. Deques</a></li>
<li><a class="reference internal" href="#defects">10.9. Defects</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="range.html"
                        title="previous chapter">9. Ranges</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="sig.html"
                        title="next chapter">11. Signatures in the MPS</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="sig.html" title="11. Signatures in the MPS"
             >next</a> |</li>
        <li class="right" >
          <a href="range.html" title="9. Ranges"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>