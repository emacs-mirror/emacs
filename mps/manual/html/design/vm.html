

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>48. Virtual mapping &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Old design" href="old.html" />
    <link rel="next" title="49. ANSI fake VM" href="vman.html" />
    <link rel="prev" title="47. Software versions" href="version.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="vman.html" title="49. ANSI fake VM"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="version.html" title="47. Software versions"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" accesskey="U">Old design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <span class="target" id="design-vm"></span><div class="section" id="virtual-mapping">
<span id="index-0"></span><h1>48. Virtual mapping<a class="headerlink" href="#virtual-mapping" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.vm"></span><h2>48.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.vm.intro"></span><a class="mpstag reference internal" href="#design.mps.vm.intro">.intro:</a> This the design of the VM interface. The VM interface
provides a simple, low-level, operating-system independent interface
to address-space. Each call to <a class="reference internal" href="#VMCreate" title="VMCreate"><tt class="xref c c-func docutils literal"><span class="pre">VMCreate()</span></tt></a> reserves (from the
operating-system) a single contiguous range of addresses, and returns
a VMStruct thereafter used to manage this address-space. The VM
interface has separate implementations for each platform that supports
it (at least conceptually, in practice some of them may be the same).
The VM module provides a mechanism to reserve large (relative to the
amount of RAM) amounts of address space, and functions to map (back
with RAM) and unmap portions of this address space.</p>
<p><span class="target" id="design.mps.vm.motivation"></span><a class="mpstag reference internal" href="#design.mps.vm.motivation">.motivation:</a> The VM is used by the VM Arena Class. It provides the
basic substrate to provide sparse address maps. Sparse address maps
have at least two uses: to encode information into the address of an
object which is used in tracing (the Zone Test) to speed things up; to
avoid fragmentation at the segment level and above (since the amount
of address space reserved is large compared to the RAM, the hope is
that there will also be enough address space somewhere to fit any
particular segment in).</p>
</div>
<div class="section" id="definitions">
<h2>48.2. Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.vm.def.reserve"></span><a class="mpstag reference internal" href="#design.mps.vm.def.reserve">.def.reserve:</a> The &#8220;reserve&#8221; operation: Exclusively reserve a
portion of the virtual address space without arranging RAM or backing
store for the virtual addresses. The intention is that no other
component in the process will make use of the reserved virtual
addresses, but in practice this may entail assuming a certain amount
of cooperation. When reserving address space, the requester simply
asks for a particular size, not a particular range of virtual
addresses. Accessing (read/write/execute) reserved addresses is
illegal unless those addresses have been mapped.</p>
<p><span class="target" id="design.mps.vm.def.map"></span><a class="mpstag reference internal" href="#design.mps.vm.def.map">.def.map:</a> The &#8220;map&#8221; operation: Arrange that a specified portion of
the virtual address space is mapped from the swap, effectively
allocating RAM and/or swap space for a particular range of addresses.
If successful, accessing the addresses is now legal. Only reserved
addresses should be mapped.</p>
<p><span class="target" id="design.mps.vm.def.unmap"></span><a class="mpstag reference internal" href="#design.mps.vm.def.unmap">.def.unmap:</a> The &#8220;unmap&#8221; operation: The inverse of the map
operation. Arrange that a specified portion of the virtual address
space is no longer mapped, effectively freeing up the RAM and swap
space that was in use. Accessing the addresses is now illegal. The
addresses return to the reserved state.</p>
<p><span class="target" id="design.mps.vm.def.vm"></span><a class="mpstag reference internal" href="#design.mps.vm.def.vm">.def.vm:</a> &#8220;VM&#8221; stands for Virtual Memory. Various meanings: A
processor architecture&#8217;s virtual space and structure; The generic idea
/ interface / implementation of the MPS VM module; The C structure
(struct VMStruct) used to encapsulate the functionality of the MPS VM
module; An instance of such a structure.</p>
<p><span class="target" id="design.mps.vm.def.vm.mps"></span><a class="mpstag reference internal" href="#design.mps.vm.def.vm.mps">.def.vm.mps:</a> In the MPS, a &#8220;VM&#8221; is a <tt class="xref c c-type docutils literal"><span class="pre">VMStruct</span></tt>, providing access
to the single contiguous range of address-space that was reserved
(from the operating-system) when <a class="reference internal" href="#VMCreate" title="VMCreate"><tt class="xref c c-func docutils literal"><span class="pre">VMCreate()</span></tt></a> was called.</p>
</div>
<div class="section" id="interface">
<h2>48.3. Interface<a class="headerlink" href="#interface" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="VMCreate">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">VMCreate</tt><big>(</big>VM<em>&nbsp;*VMReturn</em>, <a class="reference internal" href="type.html#Size" title="Size">Size</a><em>&nbsp;size</em><big>)</big><a class="headerlink" href="#VMCreate" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.vm.if.create"></span><a class="mpstag reference internal" href="#design.mps.vm.if.create">.if.create:</a> <a class="reference internal" href="#VMCreate" title="VMCreate"><tt class="xref c c-func docutils literal"><span class="pre">VMCreate()</span></tt></a> is responsible both for allocating a
<tt class="xref c c-type docutils literal"><span class="pre">VMStruct</span></tt> and for reserving an amount of virtual address space. A
VM is created and a pointer to it is returned in the return parameter
<tt class="docutils literal"><span class="pre">VMReturn</span></tt>. This VM has at least size bytes of virtual memory
reserved. If there&#8217;s not enough space to allocate the VM,
<tt class="docutils literal"><span class="pre">ResMEMORY</span></tt> is returned. If there&#8217;s not enough address space to
reserve a block of the given size, <tt class="docutils literal"><span class="pre">ResRESOURCE</span></tt> is returned. The
reserved virtual memory can be mapped and unmapped using <tt class="xref c c-func docutils literal"><span class="pre">VMMap()</span></tt>
and <tt class="xref c c-func docutils literal"><span class="pre">VMUnmap()</span></tt>.</p>
<dl class="function">
<dt id="VMDestroy">
void <tt class="descname">VMDestroy</tt><big>(</big>VM<em>&nbsp;vm</em><big>)</big><a class="headerlink" href="#VMDestroy" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.vm.if.destroy"></span><a class="mpstag reference internal" href="#design.mps.vm.if.destroy">.if.destroy:</a> A VM is destroyed by calling <a class="reference internal" href="#VMDestroy" title="VMDestroy"><tt class="xref c c-func docutils literal"><span class="pre">VMDestroy()</span></tt></a>. Any
address space that was mapped through this VM is unmapped.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">Lots of interfaces are missing here.</p>
</div>
</div>
<div class="section" id="notes">
<h2>48.4. Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.vm.testing"></span><a class="mpstag reference internal" href="#design.mps.vm.testing">.testing:</a> It is important to test that a VM implementation will
work in extreme cases.</p>
<p><span class="target" id="design.mps.vm.testing.large"></span><a class="mpstag reference internal" href="#design.mps.vm.testing.large">.testing.large:</a> It must be able to reserve a large address space.
Clients will want multi-GB spaces, more than that OSs will allow. If
they ask for too much, <a class="reference internal" href="../topic/arena.html#mps_arena_create" title="mps_arena_create"><tt class="xref c c-func docutils literal"><span class="pre">mps_arena_create()</span></tt></a> (and hence
<a class="reference internal" href="#VMCreate" title="VMCreate"><tt class="xref c c-func docutils literal"><span class="pre">VMCreate()</span></tt></a>) must fail in a predictable way.</p>
<p><span class="target" id="design.mps.vm.testing.larger"></span><a class="mpstag reference internal" href="#design.mps.vm.testing.larger">.testing.larger:</a> It must be possible to allocate in a large space;
sometimes commiting will fail, because there&#8217;s not enough space to
replace the &#8220;reserve&#8221; mapping. See <a class="reference external" href="https://info.ravenbrook.com/project/mps/import/2001-11-05/mmprevol/request/epcore/160201">request.epcore.160201</a> for details.</p>
<p><span class="target" id="design.mps.vm.testing.lots"></span><a class="mpstag reference internal" href="#design.mps.vm.testing.lots">.testing.lots:</a> It must be possible to have lots of mappings. The OS
must either combine adjacent mappings or have lots of space in the
kernel tables. See <a class="reference external" href="https://info.ravenbrook.com/project/mps/import/2001-11-05/mmprevol/request/epcore/160117">request.epcore.160117</a> for ideas on how to test
this.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">48. Virtual mapping</a><ul>
<li><a class="reference internal" href="#introduction">48.1. Introduction</a></li>
<li><a class="reference internal" href="#definitions">48.2. Definitions</a></li>
<li><a class="reference internal" href="#interface">48.3. Interface</a></li>
<li><a class="reference internal" href="#notes">48.4. Notes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="version.html"
                        title="previous chapter">47. Software versions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="vman.html"
                        title="next chapter">49. ANSI fake VM</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="vman.html" title="49. ANSI fake VM"
             >next</a> |</li>
        <li class="right" >
          <a href="version.html" title="47. Software versions"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" >Old design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>