

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>24. LO pool class &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Old design" href="old.html" />
    <link rel="next" title="25. MFS pool class" href="poolmfs.html" />
    <link rel="prev" title="23. AWL pool class" href="poolawl.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="poolmfs.html" title="25. MFS pool class"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="poolawl.html" title="23. AWL pool class"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" accesskey="U">Old design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <span class="target" id="design-poollo"></span><div class="section" id="lo-pool-class">
<span id="index-0"></span><h1>24. LO pool class<a class="headerlink" href="#lo-pool-class" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.poollo"></span><h2>24.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.poollo.readership"></span><a class="mpstag reference internal" href="#design.mps.poollo.readership">.readership:</a> Any MPS developer.</p>
<p><span class="target" id="design.mps.poollo.intro"></span><a class="mpstag reference internal" href="#design.mps.poollo.intro">.intro:</a> The LO (Leaf Object) pool class is a pool class developed
for DylanWorks. It is designed to manage objects that have no
references (leaf objects) such as strings, bit tables, etc. It is a
garbage collected pool (in that objects allocated in the pool are
automatically reclaimed when they are discovered to be unreachable.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">Need to sort out issue of alignment. Currently lo grabs alignment
from format, almost certainly &#8220;ought&#8221; to use the greater of the
format alignment and the <tt class="xref c c-macro docutils literal"><span class="pre">MPS_ALIGN</span></tt> value. David Jones,
1997-07-02.</p>
</div>
</div>
<div class="section" id="definitions">
<h2>24.2. Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.poollo.def.leaf"></span><a class="mpstag reference internal" href="#design.mps.poollo.def.leaf">.def.leaf:</a> A &#8220;leaf&#8221; object is an object that contains no
references, or an object all of whose references refer to roots. That
is, any references that the object has must refer to a priori alive
objects that are guaranteed not to move, hence the references do not
need fixing.</p>
<p><span class="target" id="design.mps.poollo.def.grain"></span><a class="mpstag reference internal" href="#design.mps.poollo.def.grain">.def.grain:</a> A grain (of some alignment) is a contiguous aligned
area of memory of the smallest size possible (which is the same size
as the alignment).</p>
</div>
<div class="section" id="requirements">
<h2>24.3. Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.poollo.req.source"></span><a class="mpstag reference internal" href="#design.mps.poollo.req.source">.req.source:</a> See req.dylan.fun.obj.alloc and
req.dylan.prot.ffi.access.</p>
<p><span class="target" id="design.mps.poollo.req.leaf"></span><a class="mpstag reference internal" href="#design.mps.poollo.req.leaf">.req.leaf:</a> The pool must manage formatted leaf objects (see
<a class="reference internal" href="#design.mps.poollo.def.leaf">.def.leaf</a> above for a definition). This is intended to encompass
Dylan and C leaf objects. Dylan leaf objects have a reference to their
wrapper, but are still leaf objects (in the sense of <a class="reference internal" href="#design.mps.poollo.def.leaf">.def.leaf</a>)
because the wrapper will be a root.</p>
<p><span class="target" id="design.mps.poollo.req.nofault"></span><a class="mpstag reference internal" href="#design.mps.poollo.req.nofault">.req.nofault:</a> The memory containing objects managed by the pool
must not be protected. The client must be allowed to access these
objects without using the MPS trampoline (the exception mechanism,
q.v.).</p>
</div>
<div class="section" id="overview">
<h2>24.4. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.poollo.overview"></span><a class="mpstag reference internal" href="#design.mps.poollo.overview">.overview:</a></p>
<p><span class="target" id="design.mps.poollo.overview.ms"></span><a class="mpstag reference internal" href="#design.mps.poollo.overview.ms">.overview.ms:</a> The LO Pool is a non-moving mark-and-sweep collector.</p>
<p><span class="target" id="design.mps.poollo.overview.ms.justify"></span><a class="mpstag reference internal" href="#design.mps.poollo.overview.ms.justify">.overview.ms.justify:</a> Mark-and-sweep pools are simpler than moving
pools.</p>
<p><span class="target" id="design.mps.poollo.overview.alloc"></span><a class="mpstag reference internal" href="#design.mps.poollo.overview.alloc">.overview.alloc:</a> Objects are allocated in the pool using the
reserve/commit protocol on allocation points.</p>
<p><span class="target" id="design.mps.poollo.overview.format"></span><a class="mpstag reference internal" href="#design.mps.poollo.overview.format">.overview.format:</a> The pool is formatted. The format of the objects
in the pool is specified at instantiation time, using an format object
derived from a variant A format (using variant A is overkill, see
<a class="reference internal" href="#design.mps.poollo.if.init">.if.init</a> below) (see design.mps.format for excuse about calling the
variant &#8216;A&#8217;).</p>
</div>
<div class="section" id="interface">
<h2>24.5. Interface<a class="headerlink" href="#interface" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.poollo.if.init"></span><a class="mpstag reference internal" href="#design.mps.poollo.if.init">.if.init:</a></p>
<p><span class="target" id="design.mps.poollo.if.init.args"></span><a class="mpstag reference internal" href="#design.mps.poollo.if.init.args">.if.init.args:</a> The init method for this class takes one extra
parameter in the vararg parameter list.</p>
<p><span class="target" id="design.mps.poollo.if.init.format"></span><a class="mpstag reference internal" href="#design.mps.poollo.if.init.format">.if.init.format:</a> The extra parameter should be an object of type
Format and should describe the format of the objects that are to be
allocated in the pool.</p>
<p><span class="target" id="design.mps.poollo.if.init.format.use"></span><a class="mpstag reference internal" href="#design.mps.poollo.if.init.format.use">.if.init.format.use:</a> The pool uses the skip and alignment slots of
the format. The skip method is used to determine the length of objects
(during reclaim). The alignment field is used to determine the
granularity at which memory should be managed.</p>
<p><span class="target" id="design.mps.poollo.if.init.format.a"></span><a class="mpstag reference internal" href="#design.mps.poollo.if.init.format.a">.if.init.format.a:</a> Currently only format variant A is supported
though clearly that is overkill as only skip and alignment are used.</p>
</div>
<div class="section" id="data-structures">
<h2>24.6. Data structures<a class="headerlink" href="#data-structures" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.poollo.sig"></span><a class="mpstag reference internal" href="#design.mps.poollo.sig">.sig:</a> The signature for the LO Pool Class is 0x51970b07
(SIGLOPOoL).</p>
<p><span class="target" id="design.mps.poollo.poolstruct"></span><a class="mpstag reference internal" href="#design.mps.poollo.poolstruct">.poolstruct:</a> The class specific pool structure is:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">LOStruct</span> <span class="p">{</span>
  <span class="n">PoolStruct</span> <span class="n">poolStruct</span><span class="p">;</span>        <span class="cm">/* generic pool structure */</span>
  <span class="n">Format</span> <span class="n">format</span><span class="p">;</span>                <span class="cm">/* format for allocated objects */</span>
  <span class="n">Shift</span> <span class="n">alignShift</span><span class="p">;</span>
  <span class="n">Sig</span> <span class="n">sig</span><span class="p">;</span>                      <span class="cm">/* impl.h.misc.sig */</span>
<span class="p">}</span> <span class="n">LOStruct</span><span class="p">;</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.poollo.poolstruct.format"></span><a class="mpstag reference internal" href="#design.mps.poollo.poolstruct.format">.poolstruct.format:</a> This is the format of the objects that are
allocated in the pool.</p>
<p><span class="target" id="design.mps.poollo.poolstruct.alignShift"></span><a class="mpstag reference internal" href="#design.mps.poollo.poolstruct.alignShift">.poolstruct.alignShift:</a> This is shift used in alignment
computations. It is <tt class="docutils literal"><span class="pre">SizeLog2(pool-&gt;alignment).</span></tt> It can be used on
the right of a shift operator (<tt class="docutils literal"><span class="pre">&lt;&lt;</span></tt> or <tt class="docutils literal"><span class="pre">&gt;&gt;</span></tt>) to convert between a
number of bytes and a number of grains.</p>
<p><span class="target" id="design.mps.poollo.loseg"></span><a class="mpstag reference internal" href="#design.mps.poollo.loseg">.loseg:</a> Every segment is an instance of segment class <tt class="xref c c-type docutils literal"><span class="pre">LOSegClass</span></tt>, a
subclass of <tt class="xref c c-type docutils literal"><span class="pre">GCSegClass</span></tt>, and is an object of type <tt class="xref c c-type docutils literal"><span class="pre">LOSegStruct</span></tt>.</p>
<p><span class="target" id="design.mps.poollo.loseg.purpose"></span><a class="mpstag reference internal" href="#design.mps.poollo.loseg.purpose">.loseg.purpose:</a> The purpose of the <tt class="docutils literal"><span class="pre">LOSeg</span></tt> structure is to
associate the bit tables used for recording allocation and mark
information with the segment.</p>
<p><span class="target" id="design.mps.poollo.loseg.decl"></span><a class="mpstag reference internal" href="#design.mps.poollo.loseg.decl">.loseg.decl:</a> The declaration of the structure is as follows:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">LOSegStruct</span> <span class="p">{</span>
  <span class="n">GCSegStruct</span> <span class="n">gcSegStruct</span><span class="p">;</span>  <span class="cm">/* superclass fields must come first */</span>
  <span class="n">LO</span> <span class="n">lo</span><span class="p">;</span>                    <span class="cm">/* owning LO */</span>
  <span class="n">BT</span> <span class="n">mark</span><span class="p">;</span>                  <span class="cm">/* mark bit table */</span>
  <span class="n">BT</span> <span class="n">alloc</span><span class="p">;</span>                 <span class="cm">/* alloc bit table */</span>
  <span class="n">Count</span> <span class="n">free</span><span class="p">;</span>               <span class="cm">/* number of free grains */</span>
  <span class="n">Sig</span> <span class="n">sig</span><span class="p">;</span>                  <span class="cm">/* impl.h.misc.sig */</span>
<span class="p">}</span> <span class="n">LOSegStruct</span><span class="p">;</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.poollo.loseg.sig"></span><a class="mpstag reference internal" href="#design.mps.poollo.loseg.sig">.loseg.sig:</a> The signature for a loseg is 0x519705E9 (SIGLOSEG).</p>
<p><span class="target" id="design.mps.poollo.loseg.lo"></span><a class="mpstag reference internal" href="#design.mps.poollo.loseg.lo">.loseg.lo:</a> The lo field points to the LO structure that owns this
segment.</p>
<p><span class="target" id="design.mps.poollo.loseg.bit"></span><a class="mpstag reference internal" href="#design.mps.poollo.loseg.bit">.loseg.bit:</a> Bit Tables (see design.mps.bt) are used to record
allocation and mark information. This is relatively straightforward,
but might be inefficient in terms of space in some circumstances.</p>
<p><span class="target" id="design.mps.poollo.loseg.mark"></span><a class="mpstag reference internal" href="#design.mps.poollo.loseg.mark">.loseg.mark:</a> This is a Bit Table that is used to mark objects
during a trace. Each grain in the segment is associated with 1 bit in
this table. When <a class="reference internal" href="#LOFix" title="LOFix"><tt class="xref c c-func docutils literal"><span class="pre">LOFix()</span></tt></a> (see <a class="reference internal" href="#design.mps.poollo.fun.fix">.fun.fix</a> below) is called the
address is converted to a grain within the segment and the
corresponding bit in this table is set.</p>
<p><span class="target" id="design.mps.poollo.loseg.alloc"></span><a class="mpstag reference internal" href="#design.mps.poollo.loseg.alloc">.loseg.alloc:</a> This is a Bit Table that is used to record which
addresses are allocated. Addresses that are allocated and are not
buffered have their corresponding bit in this table set. If a bit in
this table is reset then either the address is free or is being
buffered.</p>
<p><span class="target" id="design.mps.poollo.loseg.diagram"></span><a class="mpstag reference internal" href="#design.mps.poollo.loseg.diagram">.loseg.diagram:</a> The following diagram is now obsolete. It&#8217;s also
not very interesting - but I&#8217;ve left the sources in case anyone ever
gets around to updating it. tony 1999-12-16</p>
<p>[missing diagram]</p>
</div>
<div class="section" id="functions">
<h2>24.7. Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="external">
<h3>24.7.1. External<a class="headerlink" href="#external" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="design.mps.poollo.fun.init"></span><a class="mpstag reference internal" href="#design.mps.poollo.fun.init">.fun.init:</a></p>
<p><span class="target" id="design.mps.poollo.fun.destroy"></span><a class="mpstag reference internal" href="#design.mps.poollo.fun.destroy">.fun.destroy:</a></p>
<p><span class="target" id="design.mps.poollo.fun.buffer-fill"></span><a class="mpstag reference internal" href="#design.mps.poollo.fun.buffer-fill">.fun.buffer-fill:</a></p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p class="last">Explain way in which buffers interact with the alloc table and how
it could be improved.</p>
</div>
<p><span class="target" id="design.mps.poollo.fun.buffer-empty"></span><a class="mpstag reference internal" href="#design.mps.poollo.fun.buffer-empty">.fun.buffer-empty:</a></p>
<p><span class="target" id="design.mps.poollo.fun.condemn"></span><a class="mpstag reference internal" href="#design.mps.poollo.fun.condemn">.fun.condemn:</a></p>
<dl class="function">
<dt id="LOFix">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">LOFix</tt><big>(</big>Pool<em>&nbsp;pool</em>, ScanState<em>&nbsp;ss</em>, <a class="reference internal" href="seg.html#Seg" title="Seg">Seg</a><em>&nbsp;seg</em>, <a class="reference internal" href="type.html#Ref" title="Ref">Ref</a><em>&nbsp;*refIO</em><big>)</big><a class="headerlink" href="#LOFix" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.poollo.fun.fix"></span><a class="mpstag reference internal" href="#design.mps.poollo.fun.fix">.fun.fix:</a> Fix treats references of most ranks much the same. There
is one mark table that records all marks. A reference of rank
<tt class="docutils literal"><span class="pre">RankAMBIG</span></tt> is first checked to see if it is aligned to the pool
alignment and discarded if not. The reference is converted to a grain
number within the segment (by subtracting the segments&#8217; base from the
reference and then dividing by the grain size). The bit (the one
corresponding to the grain number) is set in the mark table.
Exception, for a weak reference (rank is <tt class="docutils literal"><span class="pre">RankWEAK</span></tt>) the mark table
is checked and the reference is fixed to 0 if this address has not
been marked otherwise nothing happens. Note that there is no check
that the reference refers to a valid object boundary (which wouldn&#8217;t
be a valid check in the case of ambiguous references anyway).</p>
<dl class="function">
<dt id="LOReclaim">
void <tt class="descname">LOReclaim</tt><big>(</big>Pool<em>&nbsp;pool</em>, Trace<em>&nbsp;trace</em>, <a class="reference internal" href="seg.html#Seg" title="Seg">Seg</a><em>&nbsp;seg</em><big>)</big><a class="headerlink" href="#LOReclaim" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.poollo.fun.reclaim"></span><a class="mpstag reference internal" href="#design.mps.poollo.fun.reclaim">.fun.reclaim:</a> Derives the loseg from the seg, and calls
<a class="reference internal" href="#loSegReclaim" title="loSegReclaim"><tt class="xref c c-func docutils literal"><span class="pre">loSegReclaim()</span></tt></a> (see <a class="reference internal" href="#design.mps.poollo.fun.segreclaim">.fun.segreclaim</a> below).</p>
</div>
<div class="section" id="internal">
<h3>24.7.2. Internal<a class="headerlink" href="#internal" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="loSegReclaim">
void <tt class="descname">loSegReclaim</tt><big>(</big>LOSeg<em>&nbsp;loseg</em>, Trace<em>&nbsp;trace</em><big>)</big><a class="headerlink" href="#loSegReclaim" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><span class="target" id="design.mps.poollo.fun.segreclaim"></span><a class="mpstag reference internal" href="#design.mps.poollo.fun.segreclaim">.fun.segreclaim:</a> For all the contiguous allocated regions in the
segment it locates the boundaries of all the objects in that region by
repeatedly skipping (by calling <tt class="docutils literal"><span class="pre">format-&gt;skip</span></tt>) from the beginning
of the region (the beginning of the region is guaranteed to coincide
with the beginning of an object). For each object it examines the bit
in the mark bit table that corresponds to the beginning of the object.
If that bit is set then the object has been marked as a result of a
previous call to <a class="reference internal" href="#LOFix" title="LOFix"><tt class="xref c c-func docutils literal"><span class="pre">LOFix()</span></tt></a>, the object is preserved by doing
nothing. If that bit is not set then the object has not been marked
and should be reclaimed; the object is reclaimed by resetting the
appropriate range of bits in the segment&#8217;s free bit table.</p>
<div class="admonition-note admonition">
<p class="first admonition-title">Note</p>
<p>Special things happen for buffered segments.</p>
<p class="last">Explain how the marked variable is used to free segments.</p>
</div>
</div>
</div>
<div class="section" id="attachment">
<h2>24.8. Attachment<a class="headerlink" href="#attachment" title="Permalink to this headline">¶</a></h2>
<p>[missing attachment &#8220;LOGROUP.CWK&#8221;]</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">24. LO pool class</a><ul>
<li><a class="reference internal" href="#introduction">24.1. Introduction</a></li>
<li><a class="reference internal" href="#definitions">24.2. Definitions</a></li>
<li><a class="reference internal" href="#requirements">24.3. Requirements</a></li>
<li><a class="reference internal" href="#overview">24.4. Overview</a></li>
<li><a class="reference internal" href="#interface">24.5. Interface</a></li>
<li><a class="reference internal" href="#data-structures">24.6. Data structures</a></li>
<li><a class="reference internal" href="#functions">24.7. Functions</a><ul>
<li><a class="reference internal" href="#external">24.7.1. External</a></li>
<li><a class="reference internal" href="#internal">24.7.2. Internal</a></li>
</ul>
</li>
<li><a class="reference internal" href="#attachment">24.8. Attachment</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="poolawl.html"
                        title="previous chapter">23. AWL pool class</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="poolmfs.html"
                        title="next chapter">25. MFS pool class</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="poolmfs.html" title="25. MFS pool class"
             >next</a> |</li>
        <li class="right" >
          <a href="poolawl.html" title="23. AWL pool class"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" >Old design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>