

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>56. The WriteF function &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Old design" href="old.html" />
    <link rel="next" title="Introduction to memory management" href="../mmref/index.html" />
    <link rel="prev" title="55. VM for Solaris" href="vmso.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../mmref/index.html" title="Introduction to memory management"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="vmso.html" title="55. VM for Solaris"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" accesskey="U">Old design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="the-writef-function">
<span id="design-writef"></span><span id="index-0"></span><h1>56. The WriteF function<a class="headerlink" href="#the-writef-function" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<span id="design.mps.writef"></span><h2>56.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.writef.intro"></span><a class="mpstag reference internal" href="#design.mps.writef.intro">.intro:</a> This document describes the <a class="reference internal" href="#WriteF" title="WriteF"><tt class="xref c c-func docutils literal"><span class="pre">WriteF()</span></tt></a> function, which
allows formatted output in a manner similar to ANSI C <tt class="docutils literal"><span class="pre">printf</span></tt>, but
allows the MPM to operate in a freestanding environment (see
design.mps.exec-env).</p>
<p><span class="target" id="design.mps.writef.background"></span><a class="mpstag reference internal" href="#design.mps.writef.background">.background:</a> The documents design.mps.exec-env and design.mps.lib
describe the design of the library interface and the reason that it
exists.</p>
</div>
<div class="section" id="design">
<h2>56.2. Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="design.mps.writef.no-printf"></span><a class="mpstag reference internal" href="#design.mps.writef.no-printf">.no-printf:</a> There is no dependency on <tt class="xref c c-func docutils literal"><span class="pre">printf()</span></tt>. The MPM only
depends on <tt class="xref c c-func docutils literal"><span class="pre">fputc()</span></tt> and <tt class="xref c c-func docutils literal"><span class="pre">fputs()</span></tt>, via the Library Interface
(design.mps.lib). This makes it much easier to deploy the MPS in a
freestanding environment. This is achieved by implementing our own
internal output routines in mpm.c.</p>
<p>Our output requirements are few, so the code is short. The only output
function which should be used in the rest of the MPM is <a class="reference internal" href="#WriteF" title="WriteF"><tt class="xref c c-func docutils literal"><span class="pre">WriteF()</span></tt></a>,
which is similar to <tt class="xref c c-func docutils literal"><span class="pre">fprintf()</span></tt>:</p>
<dl class="function">
<dt id="WriteF">
<a class="reference internal" href="type.html#Res" title="Res">Res</a> <tt class="descname">WriteF</tt><big>(</big><a class="reference internal" href="../topic/plinth.html#mps_lib_FILE" title="mps_lib_FILE">mps_lib_FILE</a><em>&nbsp;*stream</em>, ...<big>)</big><a class="headerlink" href="#WriteF" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><a class="reference internal" href="#WriteF" title="WriteF"><tt class="xref c c-func docutils literal"><span class="pre">WriteF()</span></tt></a> expects a format string followed by zero or more items to
insert into the output, followed by another format string, more items,
and so on, and finally a <tt class="xref c c-macro docutils literal"><span class="pre">NULL</span></tt> format string. For example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">WriteF</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span>
       <span class="s">&quot;Hello: $A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
       <span class="s">&quot;Spong: $U ($S)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span>
       <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
<p>This makes <tt class="xref c c-func docutils literal"><span class="pre">Describe()</span></tt> methods much easier to write. For example, <tt class="xref c c-func docutils literal"><span class="pre">BufferDescribe()</span></tt> might contain the following code:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">WriteF</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span>
       <span class="s">&quot;Buffer $P ($U) {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">WriteFP</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">WriteFU</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
       <span class="s">&quot;  base $A  init $A  alloc $A  limit $A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
       <span class="p">(</span><span class="n">WriteFA</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="n">WriteFA</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">init</span><span class="p">,</span>
       <span class="p">(</span><span class="n">WriteFA</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">alloc</span><span class="p">,</span> <span class="p">(</span><span class="n">WriteFA</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span>
       <span class="s">&quot;  Pool $P</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>        <span class="p">(</span><span class="n">WriteFP</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span>
       <span class="s">&quot;  Seg $P</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>         <span class="p">(</span><span class="n">WriteFP</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">seg</span><span class="p">,</span>
       <span class="s">&quot;  rank $U</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>        <span class="p">(</span><span class="n">WriteFU</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">,</span>
       <span class="s">&quot;  alignment $W</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>   <span class="p">(</span><span class="n">WriteFW</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">alignment</span><span class="p">,</span>
       <span class="s">&quot;  grey $B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>        <span class="p">(</span><span class="n">WriteFB</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">grey</span><span class="p">,</span>
       <span class="s">&quot;  shieldMode $B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">WriteFB</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">shieldMode</span><span class="p">,</span>
       <span class="s">&quot;  p $P  i $U</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>     <span class="p">(</span><span class="n">WriteFP</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">WriteFU</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">,</span>
       <span class="s">&quot;} Buffer $P ($U)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">WriteFP</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="n">WriteFU</span><span class="p">)</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
       <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="target" id="design.mps.writef.types"></span><a class="mpstag reference internal" href="#design.mps.writef.types">.types:</a> For each format <tt class="docutils literal"><span class="pre">$X</span></tt> that <a class="reference internal" href="#WriteF" title="WriteF"><tt class="xref c c-func docutils literal"><span class="pre">WriteF()</span></tt></a> supports, there is a
type defined in impl.h.mpmtypes <tt class="xref c c-func docutils literal"><span class="pre">WriteFX()</span></tt> which is the promoted
version of that type. These are provided both to ensure promotion and
to avoid any confusion about what type should be used in a cast. It is
easy to check the casts against the formats to ensure that they
correspond.</p>
<p><span class="target" id="design.mps.writef.types.future"></span><a class="mpstag reference internal" href="#design.mps.writef.types.future">.types.future:</a> It is possibly that this type set or similar may be
used in future in some generalisation of varargs in the MPS.</p>
<p><span class="target" id="design.mps.writef.formats"></span><a class="mpstag reference internal" href="#design.mps.writef.formats">.formats:</a> The formats supported are as follows.</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="15%" />
<col width="24%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Code</th>
<th class="head">Bame</th>
<th class="head">Type</th>
<th class="head">Example rendering</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$A</span></tt></td>
<td>address</td>
<td><a class="reference internal" href="type.html#Addr" title="Addr"><tt class="xref c c-type docutils literal"><span class="pre">Addr</span></tt></a></td>
<td><tt class="docutils literal"><span class="pre">000000019EF60010</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">$P</span></tt></td>
<td>pointer</td>
<td><tt class="docutils literal"><span class="pre">void</span> <span class="pre">*</span></tt></td>
<td><tt class="docutils literal"><span class="pre">000000019EF60100</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$F</span></tt></td>
<td>function</td>
<td><tt class="docutils literal"><span class="pre">void</span> <span class="pre">*(*)()</span></tt></td>
<td><tt class="docutils literal"><span class="pre">0001D69E01000000</span></tt> (see <a class="reference internal" href="#f">.f</a>)</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">$S</span></tt></td>
<td>string</td>
<td><tt class="docutils literal"><span class="pre">char</span> <span class="pre">*</span></tt></td>
<td><tt class="docutils literal"><span class="pre">hello</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$C</span></tt></td>
<td>character</td>
<td><tt class="docutils literal"><span class="pre">char</span></tt></td>
<td><tt class="docutils literal"><span class="pre">x</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">$W</span></tt></td>
<td>word</td>
<td><a class="reference internal" href="type.html#ULongest" title="ULongest"><tt class="xref c c-type docutils literal"><span class="pre">ULongest</span></tt></a></td>
<td><tt class="docutils literal"><span class="pre">0000000000109AE0</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$U</span></tt></td>
<td>decimal</td>
<td><a class="reference internal" href="type.html#ULongest" title="ULongest"><tt class="xref c c-type docutils literal"><span class="pre">ULongest</span></tt></a></td>
<td><tt class="docutils literal"><span class="pre">42</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">$B</span></tt></td>
<td>binary</td>
<td><a class="reference internal" href="type.html#ULongest" title="ULongest"><tt class="xref c c-type docutils literal"><span class="pre">ULongest</span></tt></a></td>
<td><tt class="docutils literal"><span class="pre">00000000000000001011011110010001</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">$$</span></tt></td>
<td>dollar</td>
<td>&#8211;</td>
<td><tt class="docutils literal"><span class="pre">$</span></tt></td>
</tr>
</tbody>
</table>
<p>Note that <tt class="docutils literal"><span class="pre">WriteFC</span></tt> is an <tt class="docutils literal"><span class="pre">int</span></tt>, because that is the default
promotion of a <tt class="docutils literal"><span class="pre">char</span></tt> (see <a class="reference internal" href="#design.mps.writef.types">.types</a>).</p>
<p><span class="target" id="design.mps.writef.snazzy"></span><a class="mpstag reference internal" href="#design.mps.writef.snazzy">.snazzy:</a> We should resist the temptation to make <a class="reference internal" href="#WriteF" title="WriteF"><tt class="xref c c-func docutils literal"><span class="pre">WriteF()</span></tt></a> an
incredible snazzy output engine. We only need it for <tt class="xref c c-func docutils literal"><span class="pre">Describe()</span></tt>
methods and assertion messages. At the moment it&#8217;s a very simple bit
of code &#8211; let&#8217;s keep it that way.</p>
<p><span class="target" id="f">.f</span>: The <tt class="docutils literal"><span class="pre">F</span></tt> code is used for function pointers. ISO C forbids casting
function pointers to other types, so the bytes of their representation are
written sequentially, and may have a different endianness to other pointers.
Could be smarter, or even look up function names, but see <a class="reference internal" href="#design.mps.writef.snazzy">.snazzy</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">56. The WriteF function</a><ul>
<li><a class="reference internal" href="#introduction">56.1. Introduction</a></li>
<li><a class="reference internal" href="#design">56.2. Design</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="vmso.html"
                        title="previous chapter">55. VM for Solaris</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../mmref/index.html"
                        title="next chapter">Introduction to memory management</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../mmref/index.html" title="Introduction to memory management"
             >next</a> |</li>
        <li class="right" >
          <a href="vmso.html" title="55. VM for Solaris"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" >Old design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>