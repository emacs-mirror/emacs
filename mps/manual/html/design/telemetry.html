

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>17. Telemetry &mdash; Memory Pool System 1.111.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/mps.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.111.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="Memory Pool System 1.111.0 documentation" href="../index.html" />
    <link rel="up" title="Old design" href="old.html" />
    <link rel="next" title="18. Thread safety in the MPS" href="thread-safety.html" />
    <link rel="prev" title="16. Splay trees" href="splay.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="thread-safety.html" title="18. Thread safety in the MPS"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="splay.html" title="16. Splay trees"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" accesskey="U">Old design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <span class="target" id="design-telemetry"><span id="index-0"></span></span><div class="section" id="telemetry">
<h1>17. Telemetry<a class="headerlink" href="#telemetry" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Tag:</th><td class="field-body">design.mps.telemetry</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Gavin Matthews</td>
</tr>
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">1997-04-11</td>
</tr>
<tr class="field-even field"><th class="field-name">Status:</th><td class="field-body">incomplete design</td>
</tr>
<tr class="field-odd field"><th class="field-name">Revision:</th><td class="field-body">$Id: //info.ravenbrook.com/project/mps/master/design/telemetry.txt#1 $</td>
</tr>
<tr class="field-even field"><th class="field-name">Copyright:</th><td class="field-body">See <a class="reference internal" href="#copyright-and-license">Copyright and License</a>.</td>
</tr>
</tbody>
</table>
<div class="section" id="introduction">
<h2>17.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="intro">.intro</span>: This documents the design of the telemetry mechanism within
the MPS.</p>
<p><span class="target" id="readership">.readership</span>: This document is intended for any MPS developer.</p>
<p><span class="target" id="source">.source</span>: Various meetings and brainstorms, including
meeting.general.1997-03-04(0), mail.richard.1997-07-03.17-01(0),
mail.gavinm.1997-05-01.12-40(0).</p>
</div>
<div class="section" id="overview">
<h2>17.2. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="over">.over</span>: Telemetry permits the emission of events from the MPS. These
can be used to drive a graphical tool, or to debug, or whatever. The
system is flexible and robust, but doesn&#8217;t require heavy support from
the client.</p>
</div>
<div class="section" id="requirements">
<h2>17.3. Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="req-simple">.req.simple</span>: It must be possible to generate code both for the MPS
and any tool without using complicated build tools.</p>
<p><span class="target" id="req-open">.req.open</span>: We must not constrain the nature of events before we are
certain of what we want them to be.</p>
<p><span class="target" id="req-multi">.req.multi</span>: We must be able to send events to multiple streams.</p>
<p><span class="target" id="req-share">.req.share</span>: It must be possible to share event descriptions between
the MPS and any tool.</p>
<p><span class="target" id="req-version">.req.version</span>: It must be possible to version the set of events so
that any tool can detect whether it can understand the MPS.</p>
<p><span class="target" id="req-back">.req.back</span>: Tools should be able to understand older and newer
version of the MPS, so far as is appropriate.</p>
<p><span class="target" id="req-type">.req.type</span>: It must be possible to transmit a rich variety of types
to the tool, including doubles, and strings.</p>
<p><span class="target" id="req-port">.req.port</span>: It must be possible to transmit and receive events
between different platforms.</p>
<p><span class="target" id="req-control">.req.control</span>: It must be possible to control whether and what
events are transmitted at least at a coarse level.</p>
<p><span class="target" id="req-examine">.req.examine</span>: There should be a cheap means to examine the contents
of logs.</p>
<p><span class="target" id="req-pm">.req.pm</span>: The event mechanism should provide for post mortem to
detect what significant events led up to death.</p>
<p><span class="target" id="req-perf">.req.perf</span>: Events should not have a significant effect on
performance when unwanted.</p>
<p><span class="target" id="req-small">.req.small</span>: Telemetry streams should be small.</p>
<p><span class="target" id="req-avail">.req.avail</span>: Events should be available in all varieties, subject to
performance requirements.</p>
<p><span class="target" id="req-impl">.req.impl</span>: The plinth support for telemetry should be easy to write
and flexible.</p>
<p><span class="target" id="req-robust">.req.robust</span>: The telemetry protocol should be robust against some
forms of corruption, e.g. packet loss.</p>
<p><span class="target" id="req-intern">.req.intern</span>: It should be possible to support string-interning.</p>
</div>
<div class="section" id="architecture">
<h2>17.4. Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="arch">.arch</span>: Event annotations are scattered throughout the code, but
there is a central registration of event types and properties. Events
are written to a buffer via a specialist structure, and are optionally
written to the plinth. Events can take any number of parameters of a
range of types, indicated as a format both in the annotation and the
the registry.</p>
</div>
<div class="section" id="analysis">
<h2>17.5. Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="anal">.anal</span>: The proposed order of development, with summary of
requirements impact is as follows (★ for positive impact, ⇓ for
negative impact):</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="12%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">solution</th>
<th class="head">si</th>
<th class="head">op</th>
<th class="head">mu</th>
<th class="head">sh</th>
<th class="head">ve</th>
<th class="head">ty</th>
<th class="head">po</th>
<th class="head">co</th>
<th class="head">ex</th>
<th class="head">pm</th>
<th class="head">pe</th>
<th class="head">sm</th>
<th class="head">av</th>
<th class="head">im</th>
<th class="head">ro</th>
<th class="head">in</th>
<th class="head">ba</th>
<th class="head">status</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference internal" href="#sol-format">.sol.format</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>merged</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#sol-struct">.sol.struct</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>⇓</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>merged</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#sol-string">.sol.string</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>merged</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#sol-relation">.sol.relation</a></td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>merged</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#sol-dumper">.sol.dumper</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>merged</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#sol-kind">.sol.kind</a></td>
<td>·</td>
<td>⇓</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>merged</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#sol-control">.sol.control</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>merged</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#sol-variety">.sol.variety</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>★</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>The following are not yet ordered:</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="3%" />
<col width="12%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">solution</th>
<th class="head">si</th>
<th class="head">op</th>
<th class="head">mu</th>
<th class="head">sh</th>
<th class="head">ve</th>
<th class="head">ty</th>
<th class="head">po</th>
<th class="head">co</th>
<th class="head">ex</th>
<th class="head">pm</th>
<th class="head">pe</th>
<th class="head">sm</th>
<th class="head">av</th>
<th class="head">im</th>
<th class="head">ro</th>
<th class="head">in</th>
<th class="head">ba</th>
<th class="head">status</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference internal" href="#sol-buffer">.sol.buffer</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>★</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>.</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#sol-traceback">.sol.traceback</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>.</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#sol-client">.sol.client</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>.</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#sol-head">.sol.head</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>.</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#sol-version">.sol.version</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#sol-exit">.sol.exit</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>.</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#sol-block">.sol.block</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>⇓</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#sol-code">.sol.code</a></td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#sol-msg">.sol.msg</a></td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>·</td>
<td>★</td>
<td>★</td>
<td>·</td>
<td>.</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><span class="target" id="file-format">.file-format</span>: One of the objectives of this plan is to minimise the
impact of the changes to the log file format. This is to be achieved
firstly by completing all necessary support before changes are
initiated, and secondly by performing all changes at the same time.</p>
</div>
<div class="section" id="ideas">
<h2>17.6. Ideas<a class="headerlink" href="#ideas" title="Permalink to this headline">¶</a></h2>
<p><span class="target" id="sol-format">.sol.format</span>: Event annotations indicate the types of their
arguments, for example, <tt class="docutils literal"><span class="pre">EVENT_WD</span></tt> for a <tt class="docutils literal"><span class="pre">Word</span></tt> and a <tt class="docutils literal"><span class="pre">double</span></tt>.
(<a class="reference internal" href="#req-type">.req.type</a>)</p>
<p><span class="target" id="sol-struct">.sol.struct</span>: Copy event data into a structure of the appropriate
type, for example, <tt class="docutils literal"><span class="pre">EventWDStruct</span></tt>. (<a class="reference internal" href="#req-type">.req.type</a>, <a class="reference internal" href="#req-perf">.req.perf</a>, but
not <a class="reference internal" href="#req-small">.req.small</a> because of padding)</p>
<p><span class="target" id="sol-string">.sol.string</span>: Permit at most one string per event, at the end, and
use the <tt class="docutils literal"><span class="pre">char[1]</span></tt> hack, and specialised code; deduce the string
length from the event length and also <tt class="docutils literal"><span class="pre">NUL</span></tt>-terminate (<a class="reference internal" href="#req-type">.req.type</a>,
<a class="reference internal" href="#req-intern">.req.intern</a>)</p>
<p><span class="target" id="sol-buffer">.sol.buffer</span>: Enter all events initially into internal buffers, and
conditionally send them to the message stream. (<a class="reference internal" href="#req-pm">.req.pm</a>,
<a class="reference internal" href="#req-control">.req.control</a>, <a class="reference internal" href="#req-perf">.req.perf</a>)</p>
<p><span class="target" id="sol-variety">.sol.variety</span>: In optimized varieties, have internal events (see
<a class="reference internal" href="#sol-buffer">.sol.buffer</a>) for a subset of events and no external events; in
normal varieties have all internal events, and the potential for
external events. (<a class="reference internal" href="#req-avail">.req.avail</a>, <a class="reference internal" href="#req-pm">.req.pm</a>, <a class="reference internal" href="#req-perf">.req.perf</a>)</p>
<p><span class="target" id="sol-kind">.sol.kind</span>: Divide events by some coarse type into around 6 groups,
probably related to frequency. (<a class="reference internal" href="#req-control">.req.control</a>, <a class="reference internal" href="#req-pm">.req.pm</a>, but not
<a class="reference internal" href="#req-open">.req.open</a>)</p>
<p><span class="target" id="sol-control">.sol.control</span>: Hold flags to determine which events are emitted
externally. (<a class="reference internal" href="#req-control">.req.control</a>, <a class="reference internal" href="#req-perf">.req.perf</a>)</p>
<p><span class="target" id="sol-dumper">.sol.dumper</span>: Write a simple tool to dump event logs as text.
(<a class="reference internal" href="#req-examine">.req.examine</a>)</p>
<p><span class="target" id="sol-msg">.sol.msg</span>: Redesign the plinth interface to send and receive
messages, based on any underlying IPC mechanism, for example, append
to file, TCP/IP, messages, shared memory. (<a class="reference internal" href="#req-robust">.req.robust</a>,
<a class="reference internal" href="#req-impl">.req.impl</a>, <a class="reference internal" href="#req-port">.req.port</a>, <a class="reference internal" href="#req-multi">.req.multi</a>)</p>
<p><span class="target" id="sol-block">.sol.block</span>: Buffer the events and send them as fixed size blocks,
commencing with a timestamp, and ending with padding. (<a class="reference internal" href="#req-robust">.req.robust</a>,
<a class="reference internal" href="#req-perf">.req.perf</a>, but not <a class="reference internal" href="#req-small">.req.small</a>)</p>
<p><span class="target" id="sol-code">.sol.code</span>: Commence each event with two bytes of event code, and
two bytes of length. (<a class="reference internal" href="#req-small">.req.small</a>, <a class="reference internal" href="#req-back">.req.back</a>)</p>
<p><span class="target" id="sol-head">.sol.head</span>: Commence each event stream with a platform-independent
header block giving information about the session, version (see
<a class="reference internal" href="#sol-version">.sol.version</a>), and file format; file format will be sufficient to
decode the (platform-dependent) rest of the file. (<a class="reference internal" href="#req-port">.req.port</a>)</p>
<p><span class="target" id="sol-exit">.sol.exit</span>: Provide a mechanism to flush events in the event of
graceful sudden death. (<a class="reference internal" href="#req-pm">.req.pm</a>)</p>
<p><span class="target" id="sol-version">.sol.version</span>: Maintain a three part version number for the file
comprising major (incremented when the format of the entire file
changes (other than platform differences)), median (incremented when
an existing event changes its form or semantics), and minor
(incremented when a new event type is added); tools should normally
fail when the median or major is unsupported. (<a class="reference internal" href="#req-version">.req.version</a>,
<a class="reference internal" href="#req-back">.req.back</a>)</p>
<p><span class="target" id="sol-relation">.sol.relation</span>: Event types will be defined in terms of a relation
specifying their name, code, optimised behaviour (see
<a class="reference internal" href="#sol-variety">.sol.variety</a>), kind (see <a class="reference internal" href="#sol-kind">.sol.kind</a>), and format (see
<a class="reference internal" href="#sol-format">.sol.format</a>); both the MPS and tool can use this by suitable
<tt class="docutils literal"><span class="pre">#define</span></tt> hacks. (<a class="reference internal" href="#req-simple">.req.simple</a>, <a class="reference internal" href="#req-share">.req.share</a>, <a class="reference internal" href="#req-examine">.req.examine</a>,
<a class="reference internal" href="#req-small">.req.small</a> (no format information in messages))</p>
<p><span class="target" id="sol-traceback">.sol.traceback</span>: Provide a mechanism to output recent events (see
<a class="reference internal" href="#sol-buffer">.sol.buffer</a>) as a form of backtrace when <tt class="docutils literal"><span class="pre">AVER</span></tt> statements fire
or from a debugger, or whatever. (<a class="reference internal" href="#req-pm">.req.pm</a>)</p>
<p><span class="target" id="sol-client">.sol.client</span>: Provide a mechanism for user events. (<a class="reference internal" href="#req-intern">.req.intern</a>)</p>
</div>
<div class="section" id="implementation">
<h2>17.7. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="annotation">
<h3>17.7.1. Annotation<a class="headerlink" href="#annotation" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="annot">.annot</span>: An event annotation is of the form:</p>
<p><tt class="docutils literal"><span class="pre">EVENT3(FooCreate,</span> <span class="pre">pointer,</span> <span class="pre">address,</span> <span class="pre">word)</span></tt></p>
<p><span class="target" id="annot-string">.annot.string</span>: If there is a string in the format, it must be the
last parameter (and hence there can be only one). There is currrently
a maximum string length, defined by <tt class="docutils literal"><span class="pre">EventMaxStringLength</span></tt> in
impl.h.eventcom.</p>
<p><span class="target" id="annot-type">.annot.type</span>: The event type should be given as the first parameter
to the event macro, as registered in impl.h.eventdef.</p>
<p><span class="target" id="annot-param">.annot.param</span>: The parameters of the event should be given as the
remaining parameters of the event macro, in order as indicated in the
event parameters definition in impl.h.eventdef.</p>
</div>
<div class="section" id="registration">
<h3>17.7.2. Registration<a class="headerlink" href="#registration" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="reg">.reg</span>: All event types and parameters should be registered in
impl.h.eventdef, in the form of a higher-order list macros.</p>
<p><span class="target" id="reg-just">.reg.just</span>: This use of a higher-order macros enables great
flexibility in the use of this file.</p>
<p><span class="target" id="reg-rel">.reg.rel</span>: The event type registration is of the form:</p>
<p><tt class="docutils literal"><span class="pre">EVENT(X,</span> <span class="pre">FooCreate,</span> <span class="pre">0x1234,</span> <span class="pre">TRUE,</span> <span class="pre">Arena)</span></tt></p>
<p><span class="target" id="reg-type">.reg.type</span>: The first parameter of the relation is the event type.
This needs no prefix, and should correspond to that used in the
annotation.</p>
<p><span class="target" id="reg-code">.reg.code</span>: The second parameter is the event code, a 16-bit value
used to represent this event type. Codes should not be re-used for new
event types, to allow interpretation of event log files of all ages.</p>
<p><span class="target" id="reg-always">.reg.always</span>: The third parameter is a boolean value indicating
whether this event type should be implemented in all varieties. See
<a class="reference internal" href="#control-buffer">.control.buffer</a>. Unless your event is on the critical path
(typically per reference or per object), you will want this to be
<tt class="docutils literal"><span class="pre">TRUE</span></tt>.</p>
<p><span class="target" id="reg-kind">.reg.kind</span>: The fourth parameter is a kind keyword indicating what
category this event falls into. See <a class="reference internal" href="#id1">.control</a>. The possible values
are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">Arena</span></tt> &#8211; per space or arena or global</li>
<li><tt class="docutils literal"><span class="pre">Pool</span></tt> &#8211; pool-related</li>
<li><tt class="docutils literal"><span class="pre">Trace</span></tt> &#8211; per trace or scan</li>
<li><tt class="docutils literal"><span class="pre">Seg</span></tt> &#8211; per segment</li>
<li><tt class="docutils literal"><span class="pre">Ref</span></tt> &#8211; per reference or fix</li>
<li><tt class="docutils literal"><span class="pre">Object</span></tt> &#8211; per object or allocation</li>
<li><tt class="docutils literal"><span class="pre">User</span></tt> &#8211; invoked by the user through the MPS interface</li>
</ul>
<p>This list can be seen in impl.h.eventcom.</p>
<p><span class="target" id="reg-doc">.reg.doc</span>: Add a docstring column. [RB 2012-09-03]</p>
<p><span class="target" id="reg-params">.reg.params</span>: The event parameters registration is of the form:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define EVENT_FooCreate_PARAMS(PARAM, X) \</span>
<span class="cp">  PARAM(X,  0, P, firstParamPointer) \</span>
<span class="cp">  PARAM(X,  1, U, secondParamUnsigned)</span>
</pre></div>
</div>
<p><span class="target" id="reg-param-index">.reg.param.index</span>: The first column is the index, and must start at
zero and increase by one for each row.</p>
<p><span class="target" id="reg-param-sort">.reg.param.sort</span>: The second column is the parameter &#8220;sort&#8221;, which,
when appended to <tt class="docutils literal"><span class="pre">EventF</span></tt>, yields a type for the parameter. It is a
letter from the following list:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">P</span></tt> &#8211; <tt class="docutils literal"><span class="pre">void</span> <span class="pre">*</span></tt></li>
<li><tt class="docutils literal"><span class="pre">A</span></tt> &#8211; <tt class="docutils literal"><span class="pre">Addr</span></tt></li>
<li><tt class="docutils literal"><span class="pre">W</span></tt> &#8211; <tt class="docutils literal"><span class="pre">Word</span></tt></li>
<li><tt class="docutils literal"><span class="pre">U</span></tt> &#8211; <tt class="docutils literal"><span class="pre">unsigned</span> <span class="pre">int</span></tt></li>
<li><tt class="docutils literal"><span class="pre">S</span></tt> &#8211; <tt class="docutils literal"><span class="pre">char</span> <span class="pre">*</span></tt></li>
<li><tt class="docutils literal"><span class="pre">D</span></tt> &#8211; <tt class="docutils literal"><span class="pre">double</span></tt></li>
<li><tt class="docutils literal"><span class="pre">B</span></tt> &#8211; <tt class="docutils literal"><span class="pre">Bool</span></tt></li>
</ul>
<p>The corresponding event parameter must be assignment compatible with
the type.</p>
<p><span class="target" id="param-types">.param.types</span>: When an event has parameters whose type is not in the
above list, use the following guidelines: All <tt class="docutils literal"><span class="pre">C</span></tt> pointer types not
representing strings use <tt class="docutils literal"><span class="pre">P</span></tt>; <tt class="docutils literal"><span class="pre">Size</span></tt>, <tt class="docutils literal"><span class="pre">Count</span></tt>, <tt class="docutils literal"><span class="pre">Index</span></tt> use
<tt class="docutils literal"><span class="pre">W</span></tt>; others should be obvious.</p>
<p><span class="target" id="reg-param-name">.reg.param.name</span>: The third column is the parameter name. It should
be a valid C identifier and is used for debugging display and human
readable output.</p>
<p><span class="target" id="reg-param-doc">.reg.param.doc</span>: Add a docstring column. [RB 2012-09-03]</p>
<p><span class="target" id="reg-dup">.reg.dup</span>: It is permissible for the one event type to be used for
more than one annotation. There are generally two reasons for this:</p>
<ul class="simple">
<li>Variable control flow for successful function completion;</li>
<li>Platform/Otherwise-dependent implementations of a function.</li>
</ul>
<p>Note that all annotations for one event type must have the same format
(as implied by <a class="reference internal" href="#sol-format">.sol.format</a>).</p>
</div>
<div class="section" id="control">
<h3>17.7.3. Control<a class="headerlink" href="#control" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="id1">.control</span>: There are two types of event control, buffer and output.</p>
<p><span class="target" id="control-buffer">.control.buffer</span>: Buffer control affects whether particular events
implemented at all, and is controlled statically by variety using the
always value (see <a class="reference internal" href="#reg-always">.reg.always</a>) for the event type. The hot variety
does compiles out annotations with <tt class="docutils literal"><span class="pre">always=FALSE</span></tt>. The cool variety
does not, so always buffers a complete set of events.</p>
<p><span class="target" id="control-output">.control.output</span>: Output control affects whether events written to
the internal buffer are output via the plinth. This is set on a
per-kind basis (see <a class="reference internal" href="#reg-kind">.reg.kind</a>), using a control bit table stored in
EventKindControl. By default, all event kinds are off. You may switch
some kinds on using a debugger.</p>
<p>For example, to enable <tt class="docutils literal"><span class="pre">Pool</span></tt> events using gdb (see impl.h.eventcom for
numeric codes):</p>
<div class="highlight-c"><pre>$ gdb ./xci3gc/cool/amcss
(gdb) break GlobalsInit
(gdb) run
...
(gdb) print EventKindControl |= 2
$2 = 2
(gdb) continue
...
(gdb) quit
$ mpseventcnv -v | sort | head
0000178EA03ACF6D PoolInit                9C1E0    9C000 0005E040
0000178EA03C2825 PoolInitMFS             9C0D8    9C000     1000        C
0000178EA03C2C27 PoolInitMFS             9C14C    9C000     1000       44
0000178EA03C332C PoolInitMV              9C080    9C000     1000       20    10000
0000178EA03F4DB4 BufferInit             2FE2C4   2FE1B0        0
0000178EA03F4EC8 BufferInitSeg          2FE2C4   2FE1B0        0
0000178EA03F57DA AMCGenCreate           2FE1B0   2FE288
0000178EA03F67B5 BufferInit             2FE374   2FE1B0        0
0000178EA03F6827 BufferInitSeg          2FE374   2FE1B0        0
0000178EA03F6B72 AMCGenCreate           2FE1B0   2FE338</pre>
</div>
<p><span class="target" id="control-env">.control.env</span>: The initial value of <tt class="docutils literal"><span class="pre">EventKindControl</span></tt> is read
from the C environment when the ANSI Plinth is used, and so event
output can be controlled like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">MPS_TELEMETRY_CONTROL</span><span class="o">=</span><span class="mi">127</span> <span class="n">amcss</span>
</pre></div>
</div>
<p>or like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">MPS_TELEMETRY_CONTROL</span><span class="o">=</span><span class="s">&quot;Pool Arena&quot;</span> <span class="n">amcss</span>
</pre></div>
</div>
<p>where the variable is set to a space-separated list of names defined by <tt class="docutils literal"><span class="pre">EventKindENUM</span></tt>.</p>
<p><span class="target" id="control-just">.control.just</span>: These controls are coarse, but very cheap.</p>
<p><span class="target" id="control-external">.control.external</span>: The MPS interface function
<tt class="docutils literal"><span class="pre">mps_telemetry_control</span></tt> can be used to change <tt class="docutils literal"><span class="pre">EventKindControl</span></tt>.</p>
<p><span class="target" id="control-tool">.control.tool</span>: The tools will be able to control
<tt class="docutils literal"><span class="pre">EventKindControl</span></tt>.</p>
</div>
<div class="section" id="debugging">
<h3>17.7.4. Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="debug-buffer">.debug.buffer</span>: Each event kind is logged in a separate buffer,
<tt class="docutils literal"><span class="pre">EventBuffer[kind]</span></tt>.</p>
<p><span class="target" id="debug-buffer-reverse">.debug.buffer.reverse</span>: The events are logged in reverse order from
the top of the buffer, with the last logged event at
<tt class="docutils literal"><span class="pre">EventLast[kind]</span></tt>. This allows recovery of the list of recent events
using the <tt class="docutils literal"><span class="pre">event-&gt;any.size</span></tt> field.</p>
<p><span class="target" id="debug-dump">.debug.dump</span>: The contents of all buffers can be dumped with the
<tt class="docutils literal"><span class="pre">EventDump</span></tt> function from a debugger, for example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">gdb</span><span class="o">&gt;</span> <span class="n">print</span> <span class="n">EventDump</span><span class="p">(</span><span class="n">mps_lib_get_stdout</span><span class="p">())</span>
</pre></div>
</div>
<p><span class="target" id="debug-describe">.debug.describe</span>: Individual events can be described with the
EventDescribe function, for example:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">gdb</span><span class="o">&gt;</span> <span class="n">print</span> <span class="n">EventDescribe</span><span class="p">(</span><span class="n">EventLast</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mps_lib_get_stdout</span><span class="p">())</span>
</pre></div>
</div>
<p><span class="target" id="debug-core">.debug.core</span>: The event buffers are preserved in core dumps and can
be used to work out what the MPS was doing before a crash. Since the
kinds correspond to frequencies, ancient events may still be available
in some buffers, even if they have been flushed to the output stream.
Some digging may be required.</p>
</div>
<div class="section" id="dumper-tool">
<h3>17.7.5. Dumper tool<a class="headerlink" href="#dumper-tool" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="dumper">.dumper</span>: A primitive dumper tool is available in impl.c.eventcnv.
For details, see guide.mps.telemetry.</p>
</div>
<div class="section" id="allocation-replayer-tool">
<h3>17.7.6. Allocation replayer tool<a class="headerlink" href="#allocation-replayer-tool" title="Permalink to this headline">¶</a></h3>
<p><span class="target" id="replayer">.replayer</span>: A tool for replaying an allocation sequence from a log
is available in impl.c.replay. For details, see
design.mps.telemetry.replayer.</p>
</div>
</div>
<div class="section" id="document-history">
<h2>17.8. Document History<a class="headerlink" href="#document-history" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>1997-04-11 Gavin Matthews. Incomplete design.</li>
<li>1997-07-07 Gavin Matthews. Rewritten after discussion in Pool Hall.</li>
<li>2002-06-07 <a class="reference external" href="http://www.ravenbrook.com/consultants/rb/">RB</a> Converted from MMInfo database design document.</li>
<li>2012-09-03 <a class="reference external" href="http://www.ravenbrook.com/consultants/rb/">RB</a> Removed basic untruths and added some discussion of
debugging, though this starts to resemble a manual rather than a
design document, and needs to be reworked.</li>
<li>2013-05-22 <a class="reference external" href="http://www.ravenbrook.com/consultants/gdr/">GDR</a> Converted to reStructuredText.</li>
</ul>
</div>
<div class="section" id="copyright-and-license">
<h2>17.9. Copyright and License<a class="headerlink" href="#copyright-and-license" title="Permalink to this headline">¶</a></h2>
<p>Copyright © 2013 Ravenbrook Limited. All rights reserved.
&lt;<a class="reference external" href="http://www.ravenbrook.com/">http://www.ravenbrook.com/</a>&gt;. This is an open source license. Contact
Ravenbrook for commercial licensing options.</p>
<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:</p>
<ol class="arabic simple">
<li>Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.</li>
<li>Redistributions in any form must be accompanied by information on how
to obtain complete source code for this software and any
accompanying software that uses this software.  The source code must
either be included in the distribution or be available for no more than
the cost of distribution plus a nominal fee, and must be freely
redistributable under reasonable conditions.  For an executable file,
complete source code means the source code for all modules it contains.
It does not include source code for modules or files that typically
accompany the major components of the operating system on which the
executable file runs.</li>
</ol>
<p><strong>This software is provided by the copyright holders and contributors
&#8220;as is&#8221; and any express or implied warranties, including, but not
limited to, the implied warranties of merchantability, fitness for a
particular purpose, or non-infringement, are disclaimed.  In no event
shall the copyright holders and contributors be liable for any direct,
indirect, incidental, special, exemplary, or consequential damages
(including, but not limited to, procurement of substitute goods or
services; loss of use, data, or profits; or business interruption)
however caused and on any theory of liability, whether in contract,
strict liability, or tort (including negligence or otherwise) arising in
any way out of the use of this software, even if advised of the
possibility of such damage.</strong></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">17. Telemetry</a><ul>
<li><a class="reference internal" href="#introduction">17.1. Introduction</a></li>
<li><a class="reference internal" href="#overview">17.2. Overview</a></li>
<li><a class="reference internal" href="#requirements">17.3. Requirements</a></li>
<li><a class="reference internal" href="#architecture">17.4. Architecture</a></li>
<li><a class="reference internal" href="#analysis">17.5. Analysis</a></li>
<li><a class="reference internal" href="#ideas">17.6. Ideas</a></li>
<li><a class="reference internal" href="#implementation">17.7. Implementation</a><ul>
<li><a class="reference internal" href="#annotation">17.7.1. Annotation</a></li>
<li><a class="reference internal" href="#registration">17.7.2. Registration</a></li>
<li><a class="reference internal" href="#control">17.7.3. Control</a></li>
<li><a class="reference internal" href="#debugging">17.7.4. Debugging</a></li>
<li><a class="reference internal" href="#dumper-tool">17.7.5. Dumper tool</a></li>
<li><a class="reference internal" href="#allocation-replayer-tool">17.7.6. Allocation replayer tool</a></li>
</ul>
</li>
<li><a class="reference internal" href="#document-history">17.8. Document History</a></li>
<li><a class="reference internal" href="#copyright-and-license">17.9. Copyright and License</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="splay.html"
                        title="previous chapter">16. Splay trees</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="thread-safety.html"
                        title="next chapter">18. Thread safety in the MPS</a></p><h4>Downloads</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/release/1.111.0/">MPS Kit release 1.111.0</a><br>
<a href="http://www.ravenbrook.com/project/mps/release/">All MPS Kit releases</a>
</p>

<h4>Issues</h4>

<p class="topless">
<a href="http://www.ravenbrook.com/project/mps/issue/?action=list&amp;view=status%3dopen&amp;display=Job:Priority:Title&amp;sort=Priority">Known issues</a><br>
<a href="http://www.ravenbrook.com/project/mps/issue/?action=fixed&release_fixed=1.111.0">Issues fixed in release 1.111.0</a>
</p><h4>Contact us</h4>

<p class="topless"><a href="mailto:mps-questions@ravenbrook.com">mps-questions@ravenbrook.com</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="thread-safety.html" title="18. Thread safety in the MPS"
             >next</a> |</li>
        <li class="right" >
          <a href="splay.html" title="16. Splay trees"
             >previous</a> |</li>
        <li><a href="../index.html">Memory Pool System 1.111.0 documentation</a> &raquo;</li>
          <li><a href="old.html" >Old design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2013, Ravenbrook Limited.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>