<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <title>MPS Wiki: Garbage Collection</title>
  <style type = "text/css">
    <!--
    div.banner {text-align:center}
    dt {font-weight:bold}
    
    -->
  </style>
</head>

<body>

<div class="banner">

<p>
<a href="/">Ravenbrook</a>
/ <a href="/project/">Projects</a>
/ <a href="/project/mps/">Memory Pool System</a>
/ <a href="/project/mps/master/">Master Product Sources</a>
/ <a href="/project/mps/master/manual/">Manuals</a>
/ <a href="/project/mps/master/manual/wiki/">Wiki</a>
</p>

<p><i><a href="/project/mps/">Memory Pool System Project</a></i></p>

<hr />

<h1>MPS Wiki: Garbage Collection</h1>

<address>
<a href="mailto:rhsk@ravenbrook.com">Richard Kistruck</a>,
<a href="http://www.ravenbrook.com/">Ravenbrook Limited</a>,
2006-06-02
</address>

</div>

<p> This wiki article contains incomplete and informal notes about the MPS, the precursor to more formal documentation.  Not confidential.  Readership: MPS users and developers.  </p>

<p>Notes on getting started with GC -- Garbage Collection.</p>

<h2>Introduction</h2>

<p>The essential MPS concepts for GC are:</p>
<ul>
  <li> Format -- lets the MPS ask the client a question about an object;</li>
  <li> Root -- tell the MPS which things (eg. stack, globals) are always alive.</li>
</ul>

<h2><a id="Formats">Formats</a></h2>

<p>The client can choose how to format its objects, but the MPS will
sometimes need to ask the client some questions about an object, such
as:</p>
<ul>
  <li> how big is it? (so that if it is dead the MPS collects only that
       object)</li>
  <li> what pointers does it contain? (so the MPS can mark referred-to
       objects as still alive)</li>
</ul>

<p>For each type of question, the client must provide a function that gives
the answer.  These functions collected together are called a "format"
(mps_fmt_t).  Usually the client developer writes these functions,
collects them into a format, and passes this format to the MPS as an
argument to mps_pool_create().</p>

<p>A client's format code is 'special'.  It is called at special times (eg.
when handling an interrupt), and is quite restricted in what it is
allowed to do.  Format code is often on the critial path for memory
management operations.  The full requirement for a format is
complicated; see pool class documentation in the Reference Manual.  But
here's a simplified overview:</p>

<p>No format is required for an object in a non-scanned, non-collectable
pool -- the MPS never needs to know the internal details of objects in
these pools.</p>

<p>For collectable and/or scannable pools, the client's format code
generally needs to support three types of object:</p>
<ol>
  <li> the client's own initialized objects;</li>
  <li> on behalf of the MPS, a "forwarding object";</li>
  <li> on behalf of the MPS, a "padding object".</li>
</ol>

<p>A forwarding object is a placeholder that the MPS uses when it has moved
the object that used to be there.  ('Normal' client code never sees
these forwarding objects; only client format code does).</p>

<p>A padding object is a 'dummy' object that the MPS uses when there is not
enough room (eg. at the end of a memory page) to put a real client
object.</p>

<p>The client must be able to distinguish between these three types 
of object.  To guarantee this, client code MUST initialize
memory returned by the MPS (by mps_alloc() or mps_reserve()) BEFORE it
makes any other call into the MPS from that thread (including the call to
mps_commit).  Here, "initialize" means at least enough initialization
that the client's format code handles the object correctly, including
whether it is a client object, a forwarding object, or a padding object.
[See also protocol.mps.format.rel.ap.  RHSK 2006-06-02]</p>

<h3><a id="format-methods">The most important format methods are:</a></h3>

<p>To support collectable client objects:</p>
<ul>
  <li> Skip (see <a href="../reference/index.html#mps_fmt_skip_t">mps_fmt_skip_t</a>):
         tell the MPS how big this object is.</li>
</ul>

<p>To support movable client objects:</p>
<ul>
  <li> Scan (see <a href="../reference/index.html#mps_fmt_scan_t">mps_fmt_scan_t</a>): 
         tell the MPS what other objects this object
         refers to;</li>
  <li> Copy (see <a href="../reference/index.html#mps_fmt_copy_t">mps_fmt_copy_t</a>):
         copy an object to a new location.</li>
</ul>

<p>To support forwarding objects (once a movable client object has been moved):</p>
<ul>
  <li> Fwd (see <a href="../reference/index.html#mps_fmt_fwd_t">mps_fmt_fwd_t</a>):
         create a forwarding object here, please;</li>
  <li> IsFwd (see <a href="../reference/index.html#mps_fmt_isfwd_t">mps_fmt_isfwd_t</a>):
         is this a forwarding object, and where 
         did it move to?</li>
</ul>

<p>To support padding objects:</p>
<ul>
  <li> Pad (see <a href="../reference/index.html#mps_fmt_pad_t">mps_fmt_pad_t</a>):
         create a padding object here, please.</li>
</ul>

<h2><a id="section-B" name="section-B">B. Document History</a></h2>

<pre>
  2006-06-02  RHSK  Created.
  2006-06-02  RHSK  Introduction to MPS Formats
</pre>


<h2><a id="section-C" name="section-C">C. Copyright and License</a></h2>

<p> This document is copyright &copy; 2006 <a href="http://www.ravenbrook.com/">Ravenbrook Limited</a>.  All rights reserved.  This is an open source license.  Contact Ravenbrook for commercial licensing options. </p>

<p> Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: </p>

<ol>

<li> Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. </li>

<li> Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. </li>

<li> Redistributions in any form must be accompanied by information on how to obtain complete source code for the this software and any accompanying software that uses this software.  The source code must either be included in the distribution or be available for no more than the cost of distribution plus a nominal fee, and must be freely redistributable under reasonable conditions.  For an executable file, complete source code means the source code for all modules it contains. It does not include source code for modules or files that typically accompany the major components of the operating system on which the executable file runs. </li>

</ol>

<p> <strong> This software is provided by the copyright holders and contributors "as is" and any express or implied warranties, including, but not limited to, the implied warranties of merchantability, fitness for a particular purpose, or non-infringement, are disclaimed.  In no event shall the copyright holders and contributors be liable for any direct, indirect, incidental, special, exemplary, or consequential damages (including, but not limited to, procurement of substitute goods or services; loss of use, data, or profits; or business interruption) however caused and on any theory of liability, whether in contract, strict liability, or tort (including negligence or otherwise) arising in any way out of the use of this software, even if advised of the possibility of such damage. </strong> </p>


<hr />

<div class="banner">

<p><code>$Id$</code></p>

<p>
<a href="/">Ravenbrook</a>
/ <a href="/project/">Projects</a>
/ <a href="/project/mps/">Memory Pool System</a>
/ <a href="/project/mps/master/">Master Product Sources</a>
/ <a href="/project/mps/master/manual/">Manuals</a>
/ <a href="/project/mps/master/manual/wiki/">Wiki</a>
</p>

</div>

</body>

</html>
