#!/usr/local/bin/bash
#
# Build and test MM/EP-core at tip of branch MMdevel_sw_eq
# 
# $HopeName$
#

script="`basename $0`"
platform=$1

msg () {
  echo "$script $platform: $*" 1>&2
}

die () {
  msg "$@"
  exit 1
}

test -d $HOME/Builds || mkdir $HOME/Builds ||
  die "Unable to create Builds directory"

cd $HOME/Builds &&
rm -rf MMdevel_sw_eq &&
mkdir MMdevel_sw_eq &&
cd MMdevel_sw_eq ||
  die "Unable to get to Builds/MMdevel_sw_eq directory"

hope co -compound MMsrc -branch MMdevel_sw_eq -recursive \
  -writable-files quit -missing-dir create -extra-files skip ||
  die "Unable to check out MMsrc(MMdevel_sw_eq) from HOPE"


## Build a library
function build-lib {
  for variety in dp ro
  do
    date
    gnumake -r -f ${platform}.gmk VARIETY=$variety $1 ||
      die "Unable to build library $1 of MMdevel_sw_eq"
  done
}

## Build and run a test
function do-test {
  for variety in dp ro
  do
    date
    gnumake -r -f ${platform}.gmk VARIETY=$variety $1 ||
      die "Unable to build test $variety/$1 of MMdevel_sw_eq"
    ./$platform/$variety/$1 ||
      die "Failed test $variety/$1 of MMdevel_sw_eq"
    rm mpsio.log
  done
}


cd src

### SW builds have different compilation options, so they ought to be
### done separately.  Do them first.

build-lib mmsw.a

do-test mpmss
# no tests for epdl

### Then clean up and do the others.

gnumake -r -f $platform.gmk clean ||
  die "Unable to clean up MMdevel_sw_eq"

for test in lockcov locv mpsicv poolncv qs
            ## Don't run amcss, because we don't need it on this branch
            ## Don't run dwstress, because we don't need it on this branch
            ## Don't run protcv, because we don't need it on this branch
            ## Don't run weakcv, because we don't need it on this branch
do
  do-test $test
done

# If the tests succeeded, delete the junk
cd $HOME/Builds &&
rm -rf MMdevel_sw_eq
