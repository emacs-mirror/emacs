<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>

<title>MPS Format Protocol</title>

</head>

<body bgcolor="#FFFFFF" text="#000000" link="#000099" vlink="#660066" alink="#FF0000">

<div align="center">

<h1>MPS Format Protocol</h1>

<p>draft</p>

<address>
<a href="mailto:nb@ravenbrook.com">Nick Barnes</a>,
<a href="http://www.ravenbrook.com/">Ravenbrook Limited</a>,
2001-11-14
</address>

</div>

<h2><a id="section-Contents" name="section-Contents">Contents</a></h2>


<ul>

<li><a href="#section-1">1. Introduction</a></li>

<li><a href="#section-2">2. Overview</a></li>

<li>
  <a href="#section-3">3. Usage</a>

  <ul>

  <li><a href="#section-3.1">3.1. Sequence</a></li>

  <li><a href="#section-3.2">3.2. Creating and Destroying Formats</a></li>

  <li><a href="#section-3.3">3.3. Variants</a></li>

  </ul>

</li>

<li><a href="#section-4">4. The Fields</a></li>

<li><a href="#section-5">5. Restrictions</a></li>

<li><a href="#section-A">A. References</a></li>

<li><a href="#section-B">B. Document history</a></li>

</ul>

<h2><a id="section-1" name="section-1">1. Introduction</a></h2>

<p>This document describes the MPS format protocol.  The protocol
provides a framework for communication between a client application
and the MPS regarding the details of client object formats.  The
protocol gives the client application a high degree of freedom in how
the client objects are represented in memory, the primary concerns
being the location of references in an object and the representation
of references.</p>

<h2><a id="section-2" name="section-2">2. Overview</a></h2>

<p>The need for some means of describing client objects comes from
tracing.  When a client object is scanned, all the references in the
object are scanned (the MPS provides a function that scans a single
reference).  Additionally, as part of a tracing process, the MPS may
move objects; this movement entails adjusting all the references to
each moved object.  This adjustment takes place when each reference is
scanned.</p>

<p>In general, only the client application can say which fields in an
object are references, and only the client application knows how
references are represented in that object.  The format protocol
provides a means by which this information can be communicated to the
MPS.</p>

<p>The layout of client objects is described by a <em>format</em>.  In
the MPS C interface, a format is represented by an object of type
<code class="source">mps_fmt_t</code> (an opaque type).</p>

<p>A format is a collection of methods and other (usually scalar)
values which together describe programatically the layout of client
objects.  Details are given below.  Some typical methods might be
to:</p>

<ul>

  <li> calculate an object's length. </li>

  <li> locate all the references in an object. </li>

  <li> adjust the value of each reference in an object. </li>

  <li> make a copy of an object. </li>

  <li> delete an object and replace it with a "broken heart".  The
  client application must set up a broken heart so that it can be
  distinguished from ordinary client objects and contains a
  reference to an object </li>

</ul>

<p>Formats are used only by certain pool classes.  Typically a pool
class that is collected or scanned will use a format.</p>

<p>Different pool classes will use formats in different ways.  For
example, a copying garbage-collected pool may need methods to: </p>

<ul>

  <li> calculate the length of an object. </li>

  <li> copy an object. </li>

  <li> scan an object.</li>

  <li> replace an object with a broken heart. </li>

</ul>

<p>A non-moving mark-and-sweep pool, on the other hand, may only
need methods to calculate the length of an object and to scan an
object.</p>

<p>To accommodate this variance in pool classes' needs, it is possible
to construct formats from different collections of methods and values.
A specific collection of methods and values is called a <em>format
variant</em>.  A format is constructed from a format variant.  A
format variant is a transparent type; in the C interface, a format
variant is an object of a particular structure type.  The client
application must allocate store for, initialize, and destroy the
format variant.  See <a href="#section-3.3">section 3.3,
"Variants"</a>, below, for more details.</p>

<h2><a id="section-3" name="section-3">3. Usage</a></h2>

<h3><a id="section-3.1" name="section-3.1">3.1. Sequence</a></h3>

<p>If a pool class needs a format (in order to create a pool) then you
must create a format using one of the creation methods, each of which
creates a format from a specific variant.  The methods and values in a
variant must be defined by the client application, prior to the
creation of a variant.  The format must not be destroyed until all
pools using that format have been destroyed; if the format is
destroyed too early, undefined behavior will result.</p>

<p>Here's a linear "diagram" of format usage: Time increases down
the page.  Ellipses represent time lapses.</p>

<ul>

 <li> Create methods required for the variant, such as scan, skip, copy.  Typically these will be created statically (for example, compiled C code). </li>

 <li> Create other values required for the variant.  Typically these will be created statically. </li>

 <li> ... </li>

 <li> Create a variant </li>

 <li> Initialize the variant with the methods and values defined earlier. </li>

 <li> ... </li>

 <li> Create a format from the variant. </li>

 <li> Create a pool that uses the format (after this point the methods that you defined may get called by the MPS at any time). </li>

 <li> ... </li>

 <li> Use the pool (the methods you defined are called by the MPS). </li>

 <li> ... </li>

 <li> Destroy the pool. </li>

 <li> Destroy the format. </li>

</ul>


<h3><a id="section-3.2" name="section-3.2">3.2. Creating and Destroying Formats</a></h3>

<p>An object of type <code class="source">mps_fmt_t</code> can be
created using any one of a number of create methods.  Each create
method's name begins with <code class="source">mps_fmt_create_</code>.
Each create method corresponds to a certain collection of different
methods and values.</p>

<p>An object of type <code class="source">mps_fmt_t</code> can be
destroyed using <code class="source">mps_fmt_destroy</code>.  This
works regardless of how the object format was created.</p>

<p>The lifetime of an object format is determined by what use the
object format is put to.  Where the object format is the argument to a
pool class's create method, then typically the lifetime of the object
format must be at least the lifetime of the corresponding pool -- that
is, the format must be created before the pool is created and
destroyed after the pool is destroyed.</p>


<h3><a id="section-3.3" name="section-3.3">3.3. Variants</a></h3>

<table border="1" cellspacing="0" cellpadding="5">

<tr valign="top">

  <th>Name</th>

  <th>Notes</th>

  <th>Type</th>

</tr>

<tr valign="top">

  <td><a id="variant-A" name="variant-A">A</a> and <a id="variant-B" name="variant-B">B</a></td>

  <td> Similar to each other; both suited for a pool with copying
  garbage collection and allocation points.  They differ in that
  variant B has an extra method, <a href="#field-mps_class"><code
  class="source">mps_class</code></a>, for determining the class of an
  object. Both of these variants are now deprecated.</td>

  <td><code class="source">mps_fmt_A_s</code> and <code class="source">mps_fmt_B_s</code> respectively.</td>

</tr>

<tr valign="top">

  <td><a id="variant-auto_header" name="variant-auto_header">auto_header</a></td>

  <td>Suited for automatic memory management for objects with headers.</td>

  <td><code>mps_fmt_auto_header_s</code></td>

</table>

<p>Other variants may be implemented later.</p>


<h2><a id="section-4" name="section-4">4. The Fields</a></h2>

<p>The MPS calls the methods in a format when it needs to perform an
operation on an object.  Note that methods usually take and return
client pointers, because that is how the client application usually
deals with its objects.  Only when that doesn't make sense, does the
MPS deal with base pointers (allocation is the main instance of this).
See the documentation for the type of each method for details.</p>

<table border="1" cellspacing="0" cellpadding="5">

<tr valign="top">

  <th>Field name</th>

  <th>Type name</th>

  <th>Type</th>

  <th>Notes</th>

</tr>

<tr valign="top">

  <td><a id="field-skip" name="field-skip"><code class="source">skip</code></a></td>

  <td><code class="source">mps_fmt_skip_t</code></td>

  <td><code class="source">mps_addr_t (*) (mps_addr_t)</code></td>

  <td><p>The <code class="source">skip</code> method should skip a
  pointer over an object.  It takes a pointer to (the beginning of)
  the object and returns a pointer to the next object (that is, just
  after the end of this object, whether the next block in memory is
  allocated or not). </p></td>

</tr>

<tr valign="top">

  <td><a id="field-copy" name="field-copy"><code class="source">copy</code></td>

  <td><code class="source">mps_fmt_copy_t</code></td>

  <td><code class="source">void (*) (mps_addr_t, mps_addr_t)</code></td>

  <td><p>The <code class="source">copy</code> method should make a
  copy of the object in another location.  It takes pointers to the
  old and new locations.  Objects are usually copied byte by byte, but
  some uncommon object formats might contain relative pointers that
  have to be fixed up when the object is moved.</p>

  <p>If that is the case, a valid <code class="source">copy</code>
  method must be specified and the objects must be allocated in a pool
  that supports <code class="source">copy</code> methods (most pools
  will just ignore <code class="source">copy</code> methods).</p></td>

</tr>

<tr valign="top">

  <td><a id="field-pad" name="field-pad"><code class="source">pad</code></a></td>

  <td><code class="source">mps_fmt_pad_t</code></td>

  <td><code class="source">void (*) (mps_addr_t, size_t)</code></td>

  <td><p>The <code class="source">pad</code> method should create a
  dummy object.  It takes a pointer and a size, and fills in the block
  of memory with a dummy object.  The fake object should work just
  like a real one in all the other methods, but it shall contain no
  data.  This method is used by the MPS to fill in odd corners that
  need to be scannable.  The size is a multiple of the alignment set
  by the Align slot in the format, and might be equal to it.</p>

  <p>Note that the other methods, except <a href="#field-copy"><code
  class="source">copy</code></a> and <a href="#field-fwd"><code
  class="source">fwd</code></a>, might be called on a dummy
  object.</p></td>

</tr>

<tr valign="top">

  <td><a id="field-fwd" name="field-fwd"><code class="source">fwd</code></a></td>

  <td><code class="source">mps_fmt_fwd_t</code></td>

  <td><code class="source">void (*) (mps_addr_t, mps_addr_t)</code></td>

  <td><p>The <code class="source">fwd</code> method should replace an
  object with a forwarding marker.  It is used when the MPS has moved
  an object to a new location in memory.</p>

  <p> Fwd takes a pointer to the object (at its old location) and a
  forwarding address.  It must replace the object at the old location
  with a "broken heart" of the same size, in which is stored the
  forwarding address.  Since any object (except a dummy padding
  object) may be forwarded, the format must be able to create a
  broken heart of the same size as any object. </p>

  <p> Note that other format methods (except <a
  href="#field-copy"><code class="source">copy</code></a>) may be
  called on a broken heart.</p> </td>

</tr>

<tr valign="top">

  <td><a id="field-isfwd" name="field-isfwd"><code class="source">isfwd</code></a></td>

  <td><code class="source">mps_fmt_isfwd_t</code></td>

  <td><code class="source">mps_addr_t (*) (mps_addr_t)</code></td>

  <td><p>The <code class="source">isfwd</code> method lets MPS
  distinguish between a broken heart and a real object.  It takes a
  pointer to the object and returns either a pointer to the new
  location (if the object is a broken heart) or <code
  class="source">NULL</code>, if the object is not a broken heart.
  This new location is the same as the new location that was passed to
  <code class="source">fwd</code> when the broken heart was
  created.</p></td>

</tr>

<tr valign="top">

  <td><a id="field-scan" name="field-scan"><code class="source">scan</code></a></td>

  <td><code class="source">mps_fmt_scan_t</code></td>

  <td><code class="source">mps_res_t (*) (mps_ss_t, mps_addr_t,
  mps_addr_t)</code></td>

  <td><p>The scan method should locate all references in an object and
  telling the MPS where they are.  It takes a scan state and two
  pointers, and scans the objects between the pointers.  Note that
  scan methods are sometimes called on dummy objects (in which case they
  should do nothing) and broken hearts (they should fix the forwarding
  pointer).  For more information on scanning, see Scanning
  Protocol.</p></td>

</tr>

<tr valign="top">

  <td><a id="field-align" name="field-align"><code class="source">align</code></a></td>

  <td><code class="source">mps_align_t</code></td>

  <td>N/A</td>

  <td><p>This integer value defines the alignment of objects allocated
  with this format.  It should be large enough to satisfy the
  alignment requirements of any field in the objects, and it cannot be
  larger than the arena alignment.</p></td>

</tr>

<tr valign="top">

  <td><a id="field-mps_headerSize" name="field-mps_headerSize"><code class="source">mps_headerSize</code></a></td>

  <td><code class="source">size_t</code></td>

  <td>N/A</td>

  <td><p>(Variant <a href="#variant-auto_header">auto_header</a> only). This integer value is the size of the header, i.e., the
  offset of a client pointer from the base of the memory block.</p></td>

</tr>

<tr valign="top">

  <td><a id="field-mps_class" name="field-mps_class"><code class="source">mps_class</code></a></td>

  <td><code class="source">mps_fmt_class_t</code></td>

  <td><code class="source">mps_addr_t (*) (mps_addr_t)</code></td>

  <td><p>(Variant <a href="#variant-B">B</a> only). This method takes
  an object pointer and returns an address that the client associates
  with the class or type of an object.  This may be used for
  logging.</p></td>

</tr>

</table>


<h2><a id="section-5" name="section-5">5. Restrictions</a></h2>

<p>It is guaranteed that format methods have exclusive access to the
object for the duration of the call.  This guarantee may entail
suspending arbitrary threads.  The methods that manipulate the object
must not perform any sort of inter-thread locking or
communication.</p>

<p>Format methods may be called during an exception handler or a
signal handler.  For example, the MPS may protect the memory, in
which case the client program cannot see it.  This causes an
exception; the MPS handles the exception, finishes its work, and
removes the protection.  Therefore, the format code should be able
to be run at any time, including in parallel with the main
program. </p>

<p>Format methods must be reentrant.</p>

<p>Format methods can access the memory they've been asked to look
at and memory not managed by the MPS; they cannot in general access
other objects managed by the MPS (unless they are
unprotectable).</p>

<p>Format methods can't call library code, perform a non-local
exit, or do any MM operations (apart from fixing in <a
href="#field-scan"><code class="source">scan</code></a>
methods).</p>

<h2><a id="section-A" name="section-A">A. References</a></h2>

<h2><a id="section-B" name="section-B">B. Document History</a></h2>

<table>

 <tr valign="top">

  <td>1997-05-14 13:44:36 -04</td>

  <td>drj</td>

  <td>Created</td>

 </tr>

 <tr valign="top">

  <td>1997-05-14 to 2000-07-19</td>

  <td />

  <td>Developed at Harlequin</td>

 </tr>

 <tr valign="top">

  <td>2001-09-26</td>

  <td><a href="mailto:ndl@ravenbrook.com">NDL</a></td>

  <td>Converted from xml to html (second pass).</td>

 </tr>

<tr valign="top">

  <td>2001-11-14</td>

  <td><a href="mailto:nb@ravenbrook.com">NB</a></td>

  <td>Reformatted and adopted; added the two missing fields
  (mps_headerSize and mps_class).</td>

</tr>

</table>

<hr />

<p>

 <small>Copyright &copy; 2001 Ravenbrook Limited.  This document is provided "as is", without any express or implied warranty.  In no event will the authors be held liable for any damages arising from the use of this document.  You may not duplicate or reproduce this document in any form without the express permission of the copyright holder.</small>

</p>

<div align="center">

 <p>

  <code>$Id$</code>

 </p>

</div>

</body>

</html>

