<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">

 <html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
  <head>
   <title>MPS Assertion Protocol</title>
  </head>
  <body bgcolor='#FFFFFF' text='#000000' link='#000099' vlink='#660066' alink='#FF0000'>
   <div align='center'>
    <h1>MPS Assertion Protocol</h1>
    <p>incomplete</p>
    <address>lmb, 1997-05-01</address>
   </div>
   <h2>
    <a id='section-description' name='section-description'>Description</a>
   </h2>
   <p>The MPS is able to do a great deal of checking: of arguments, protocols, and the consistency of internal data structures.  The number and precise nature of the checks performed depends on the variety of the MPS library, and also on the current setting of some controls.  See [the documentation of varieties].  If such a check fails, an assertion handler is called.</p>
   <p>Assertion handlers are of type *mps_assert_t, declared in mps.h like this:</p>
   <p>
    typedef void (*mps_assert_t)(const char *, const char *, const char *,
    <br />
                                 unsigned line);
   </p>
   <p>A handler is called as handler(cond, id, file, line), where:</p>
   <p>
    - const char *cond is a textual representation of the check which has
    <br />
       failed
    <br />
    - const char *id is internal version information about the source file
   containing the check
    <br />
    - const char *file is the name of that source file
    <br />
    - unsigned int line is the line number of the check
   </p>
   <p>The MPS cannot safely proceed after a check has failed, so the assertion handler should not return to its caller.  It may terminate the program, for example, by calling abort() (standard.ansic section 7.10.4.1) or exit() (section 7.10.4.3), or it may use longjmp() to perform a non-local exit (section 7.6.2.1).  However, once an assertion handler has been called, the MPS may not be used again during the current run of the program.</p>
   <p>The default assertion handler is internal to the MPS.  This handler uses mps_lib_fputs() and mps_lib_fputc() to write a diagnostic message to mps_lib_stderr() and then calls mps_lib_abort().  However, you can write your own assertion handlers and install them using mps_assert_install().</p>
   <p>mps_assert_default is a function that takes no arguments and returns a pointer to the default assertion handler.  This function is intended to be used in conjunction with mps_assert_install.  Clients may also call the default assertion handler directly, in which case the first, second, and third arguments must be non-NULL pointers to zero-terminated strings.</p>
   <p>mps_assert_install is a function that takes a pointer to an assertion handler and installs it as the current assertion handler.  It returns a pointer to the previously installed assertion handler.</p>
   <p>Among the actions that might be taken by a client assertion handler are:</p>
   <p>
    - displaying the assertion in a dialog
    <br />
    - recording the assertion in a log
    <br />
    - writing client-specific diagnostics to a file
- starting a debugging session
   </p>
   <p>Authors of software that may be used in conjunction with other clients of the MPS (for example, components, plugins, or modules of a larger product) should consider the benefits of passing assertions on to the previously installed handler.  If this is not done, the behavior will depend upon the order in which different handlers are installed.</p>
   <p>The typical use of the functions described above is as follows:</p>
   <p>
    <pre>      mps_assert_t old_handler;
	void my_assertion_handler(const char *cond, 
				  const char *id,
				  const char *file,
				  unsigned int line)
        {
	  fatal_error_dialog("The Memory Pool System detected an inconsistency"
                             "in file %s at line %u: %s\n", file, line, cond);
          old_handler(cond, id, file, line);
          abort();
	  NOTREACHED;
	}
	/* install the handler: */
	old_handler = mps_assert_install(my_assertion_handler);
	/* ... use the MPS ... */
	/* restore the old handler */
	(void) mps_assert_install(old_handler);</pre>
   </p>
   <h2>
    <a id='section-A' name='section-A'>A. References</a>
   </h2>
   <h2>
    <a id='section-B' name='section-B'>B. Document History</a>
   </h2>
   <table>
    <tr valign='top'>
     <td>1997-05-01 19:25:45 +01</td>
     <td>lmb</td>
     <td>New document saved</td>
    </tr>
    <tr valign='top'>
     <td>1997-05-09 17:48:24 +01</td>
     <td>lmb</td>
     <td></td>
    </tr>
    <tr valign='top'>
     <td>1997-06-20 17:20:21 -04</td>
     <td>lmb</td>
     <td>Some minor edits.</td>
    </tr>
    <tr valign='top'>
     <td>1998-06-25 15:17:09 +00</td>
     <td>drj</td>
     <td>added .source</td>
    </tr>
    <tr valign='top'>
     <td>2000-05-22 16:06:45 +01</td>
     <td>pekka</td>
     <td>clean up</td>
    </tr>
    <tr valign='top'>
     <td>2001-09-26</td>
     <td>
      <a href='mailto:ndl@ravenbrook.com'>NDL</a>
     </td>
     <td>Converted from xml to html (second pass).</td>
    </tr>
   </table>
   <hr />
   <p>
    <small>Copyright &copy; 2001 Ravenbrook Limited.  This document is provided "as is", without any express or implied warranty.  In no event will the authors be held liable for any damages arising from the use of this document.  You may not duplicate or reproduce this document in any form without the express permission of the copyright holder.</small>
   </p>
   <div align='center'>
    <p>
     <code>$Id$</code>
    </p>
   </div>
  </body>
 </html>
