<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">

 <html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
  <head>
   <title>MPS C Interface Symbol mps_class_mv2</title>
  </head>
  <body bgcolor='#FFFFFF' text='#000000' link='#000099' vlink='#660066' alink='#FF0000'>
   <div align='center'>
    <h1>MPS C Interface Symbol mps_class_mv2</h1>
    <p>draft</p>
    <address>ptw, 1998-07-09</address>
   </div>
   <h2>
    <a id='section-name' name='section-name'>Name</a>
   </h2>
   <p>mps_class_mv2</p>
   <h2>
    <a id='section-summary' name='section-summary'>Summary</a>
   </h2>
   <p>mps_class_mv2 is a function that returns the MV2 pool class object.</p>
   <h2>
    <a id='section-associated-protocols' name='section-associated-protocols'>Associated Protocols</a>
   </h2>
   <p>Allocation point.</p>
   <h2>
    <a id='section-syntax' name='section-syntax'>Syntax</a>
   </h2>
   <p>mps_class_t mps_class_mv2(void);</p>
   <h2>
    <a id='section-type' name='section-type'>Type</a>
   </h2>
   <p>C function</p>
   <h2>
    <a id='section-arguments' name='section-arguments'>Arguments</a>
   </h2>
   <p>None.</p>
   <h2>
    <a id='section-returned-values' name='section-returned-values'>Returned Values</a>
   </h2>
   <p>The MV2 pool class object.</p>
   <h2>
    <a id='section-resources' name='section-resources'>Resources</a>
   </h2>
   <p>mpscmv2.h</p>
   <h2>
    <a id='section-description' name='section-description'>Description</a>
   </h2>
   <p>The function mps_class_mv2 returns the MV2 pool class object, which can be used to create an MV2 pool instance by passing the class object as the mps_class_t (third) argument to mps_pool_create.</p>
   <p>The MV2 pool class manually manages variable-sized, unformatted objects.  The MV2 pool uses an allocation policy termed "temporal fit".  Temporal fit attempts to place consecutive allocations next to each other.  It relies on delaying reuse as long as possible to permit freed blocks to coalesce, thus maximizing the number of consecutive allocations that can be co-located.  Temporal fit permits a very fast allocator and a deallocator competitive in speed with all other known policies.</p>
   <p>
    Temporal fit is intended to take advantage of knowledge of object lifetimes, either 
    <cite>a priori</cite>
     knowledge or knowledge acquired by profiling.  The best performance of the MV2 pool will be achieved by allocating objects with similar expected deathtimes together.
   </p>
   <p>A simple policy can be implemented to take advantage of MV2:  Object size is typically well-correlated with object life-expectancy, and birthtime plus lifetime gives deathtime, so allocating objects of similar size sequentially from the same pool instance should result in objects allocated close to each other dying at about the same time.</p>
   <p>An application that has several classes of objects of widely differing life expectancy will best be served by creating a different MV2 pool instance for each life-expectancy class.  A more sophisticated policy can use either the programmer's knowledge of the expected lifetime of an object or any characteristic of objects that correlates with lifetime to choose an appropriate pool instance to allocate in.</p>
   <p>Allocating objects with unknown or very different deathtimes together will pessimize the space performance of MV2.</p>
   <h2>
    <a id='section-example' name='section-example'>Example</a>
   </h2>
   <p>if(mps_pool_create(&amp;pool, arena, mps_class_mv2(), 8, 32, 256, 70, 20)</p>
   <p>   != MPS_RES_OK) {</p>
   <p>  printf("Error creating pool!"); exit(2);</p>
   <p>}</p>
   <h2>
    <a id='section-error-handling' name='section-error-handling'>Error Handling</a>
   </h2>
   <p>mps_class_mv2 cannot result in an error.</p>
   <h2>
    <a id='section-see-also' name='section-see-also'>See Also</a>
   </h2>
   <p>mps_pool_create</p>
   <h2>
    <a id='section-notes' name='section-notes'>Notes</a>
   </h2>
   <p>
    <strong>Creation</strong>
   </p>
   <p>The MV2 pool class has five creation parameters:</p>
   <p>
    mps_res_t mps_pool_create(mps_pool_t * pool, mps_arena_t arena,
    <br />
                              mps_class_t mv2_class,
                          size_t minimum_size,
    <br />
                              size_t mean_size,
                          size_t maximum_size,
    <br />
                              mps_count_t reserve_depth
                          mps_count_t fragmentation_limit);
   </p>
   <p>Sizes</p>
   <p>minimum_size, mean_size, and maximum_size are the minimum, mean, and maximum (typical) size in bytes of objects expected to be allocated in the pool.  Objects smaller than minimum size may be allocated, but the pool is not guaranteed to manage them space-efficiently.  Objects larger than maximum_size may be allocated, but the pool is not guaranteed to manage them space-efficiently.  Furthermore, partial freeing is not supported for objects larger than maximum size; doing so will result in the storage of the object never being reused.  Mean_size need not be an accurate mean, although the pool will manage mean_size objects more efficiently.</p>
   <p>Reserve Depth</p>
   <p>reserve_depth is the expected hysteresis of the object population.  When pool objects are freed, the pool will retain sufficient storage to allocate reserve_depth objects of mean_size for near term allocations (rather than immediately making that storage available to other pools).</p>
   <p>If a pool has a stable object population, one which only grows over the lifetime of the pool, or one which grows steadily and then shrinks steadily, use a reserve_depth of 0.</p>
   <p>It is always safe to use a reserve depth of 0, but if the object population typically fluctuates in a range (e.g., the client program may repeatedly create and destroy a subset of objects in a loop), it is more efficient for the pool to retain enough storage to satisfy that fluctuation.  For example, if a pool has an object population that typically fluctuates between 8,000 and 10,000, use a reserve_depth of 2,000.</p>
   <p>The reserve will not normally be available to other pools for allocation, even when it is not used by the pool.  If this is undesirable, a reserve depth of 0 may be used for a pool whose object population does vary, at a slight cost in efficiency.  The reserve does not guarantee any particular amount of allocation.</p>
   <p>Fragmentation Limit</p>
   <p>fragmentation_limit is a percentage in (0, 100] that can be used to set an upper limit on the space overhead of MV2 in case object deathtimes and allocations do not correlate well.</p>
   <p>If the free space managed by the pool as a ratio of all the space managed by the pool exceeds the specified percentage, the pool will fall back to a first fit allocation policy, exploiting space more efficiently at a cost in time efficiency.  </p>
   <p>A fragmentation_limit of 0 would cause the pool to operate as a first-fit pool, at a significant cost in time-efficiency, therefore is not permitted.</p>
   <p>A fragmentation_limit of 100 will cause the pool to use temporal fit (unless resources are exhausted).  If the objects allocated in the pool have similar lifetime expectancies, this mode will have the best time- and space-efficiency.  If the objects have widely varying lifetime expectancies, this mode will be time-efficient, but may be space-inefficient.  An intermediate setting can be used to limit the space-inefficiency of temporal fit due to varying object life expectancies.</p>
   <p>
    <strong>Allocation</strong>
   </p>
   <p>The MV2 pool class only supports allocation through allocation points.  See mps_ap_create.</p>
   <p>
    <strong>Deallocation</strong>
   </p>
   <p>
    The MV2 pool class supports explicit freeing.  See mps_pool_free.
    <br />
   </p>
   <h2>
    <a id='section-internal-notes' name='section-internal-notes'>Internal Notes</a>
   </h2>
   <p>Need a life-expectancy parameter!  How else will different instances choose their Loci?</p>
   <p>Need an alignment parameter.  Perhaps this is embedded in a format parameter (when all pools have at least a null format).</p>
   <p>It is conceivable that a client would want to mix manual and automatic pools with the manual pool being able to be a root for the automatic.  To do so, MV2 would need to support formatted objects and scanning.  This may be added someday.</p>
   <p>Eventually the MM product will include profiling tools that will help determine object characteristics that correlate with object lifetime and suggest how to configure the appropriate number of MV2 pool instances and what characteritics to dispatch on when choosing which instance to allocate from.</p>
   <p>
    [From 
    mail.ptw.1998-08-19.02-33(0)
    ]
   </p>
   <p>Remember Wilson's statement that the goal of a memory manager is to exploit the regularities in allocation patterns?  My intent in the interface parameters is to accept measurable regularities in object populations, then the implementation can exploit them.</p>
   <p>Perhaps the pool should accept some description of the mean and deviation of the object sizes, object population, and object lifetimes.  Is that what you are getting at?  [Reserve_depth is in some sense a deviation.]</p>
   <h2>
    <a id='section-A' name='section-A'>A. References</a>
   </h2>
   <h2>
    <a id='section-B' name='section-B'>B. Document History</a>
   </h2>
   <table>
    <tr valign='top'>
     <td>1998-07-09 17:15:30 -04</td>
     <td>ptw</td>
     <td>New document saved</td>
    </tr>
    <tr valign='top'>
     <td>1998-07-09 17:29:23 -04</td>
     <td />
     <td>checkpoint</td>
    </tr>
    <tr valign='top'>
     <td>1998-07-09 17:47:11 -04</td>
     <td>ptw</td>
     <td>checkpoint</td>
    </tr>
    <tr valign='top'>
     <td>1998-07-10 13:49:21 -04</td>
     <td>ptw</td>
     <td>Draft complete</td>
    </tr>
    <tr valign='top'>
     <td>1998-08-06 22:47:43 -04</td>
     <td>ptw</td>
     <td>Expand the description of the pool parameters</td>
    </tr>
    <tr valign='top'>
     <td>1998-08-11 10:48:05 -04</td>
     <td>ptw</td>
     <td>Amend fragmentation_limit range</td>
    </tr>
    <tr valign='top'>
     <td>1998-08-17 17:40:41 -04</td>
     <td>ptw</td>
     <td>Checkpoint</td>
    </tr>
    <tr valign='top'>
     <td>1998-08-17 23:23:00 -04</td>
     <td />
     <td>checkpoint</td>
    </tr>
    <tr valign='top'>
     <td>1998-08-18 08:34:32 -04</td>
     <td>ptw</td>
     <td>Respond to Pekka's comments</td>
    </tr>
    <tr valign='top'>
     <td>1998-08-18 12:45:57 -04</td>
     <td>ptw</td>
     <td>checkpoint</td>
    </tr>
    <tr valign='top'>
     <td>1998-08-19 17:00:57 -04</td>
     <td />
     <td>Checkpoint</td>
    </tr>
    <tr valign='top'>
     <td>1998-08-19 17:38:07 -04</td>
     <td>ptw</td>
     <td>Respond to Pekka's comments</td>
    </tr>
    <tr valign='top'>
     <td>1998-08-28 16:35:26 -04</td>
     <td>ptw</td>
     <td>Fix fencepost error</td>
    </tr>
    <tr valign='top'>
     <td>2001-09-26</td>
     <td>
      <a href='mailto:ndl@ravenbrook.com'>NDL</a>
     </td>
     <td>Converted from xml to html (second pass).</td>
    </tr>
   </table>
   <hr />
   <p>
    <small>Copyright &copy; 2001 Ravenbrook Limited.  This document is provided "as is", without any express or implied warranty.  In no event will the authors be held liable for any damages arising from the use of this document.  You may not duplicate or reproduce this document in any form without the express permission of the copyright holder.</small>
   </p>
   <div align='center'>
    <p>
     <code>$Id$</code>
    </p>
   </div>
  </body>
 </html>
