<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">

 <html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
  <head>
   <title>MPS C Interface: type mps_fmt_scan_t</title>
  </head>
  <body bgcolor='#FFFFFF' text='#000000' link='#000099' vlink='#660066' alink='#FF0000'>
   <div align='center'>
    <h1>MPS C Interface: type mps_fmt_scan_t</h1>
    <p>draft</p>
    <address>pekka, 1998-01-26</address>
   </div>
   <h2>
    <a id='section-name' name='section-name'>Name</a>
   </h2>
   <p>
    mps_fmt_scan_t
    <br />
   </p>
   <h2>
    <a id='section-summary' name='section-summary'>Summary</a>
   </h2>
   <p>
    Type of 
    the scan method of a format
    .
    <br />
   </p>
   <h2>
    <a id='section-associated-protocols' name='section-associated-protocols'>Associated Protocols</a>
   </h2>
   <p>Format, Scanning.</p>
   <h2>
    <a id='section-syntax' name='section-syntax'>Syntax</a>
   </h2>
   <p>
    <pre>typedef mps_res_t (*mps_fmt_scan_t)(mps_ss_t scan_state,
                                    mps_addr_t base, mps_addr_t limit)</pre>
   </p>
   <h2>
    <a id='section-arguments' name='section-arguments'>Arguments</a>
   </h2>
   <p>
    <code>scan_state</code>
      a scan state
   </p>
   <p>
    <code>base</code>
            a client pointer to the first object in the block to be scanned
   </p>
   <p>
    <code>limit</code>
    a client pointer to the object just
     beyond the end of the block
   </p>
   <h2>
    <a id='section-returned-values' name='section-returned-values'>Returned Values</a>
   </h2>
   <p>A result code.</p>
   <h2>
    <a id='section-resources' name='section-resources'>Resources</a>
   </h2>
   <p>mps.h</p>
   <h2>
    <a id='section-description' name='section-description'>Description</a>
   </h2>
   <p>
    This is the type of scanning functions provided by the client in some format variants
     and
    <code>mps_root_create_fmt</code>
    .  When the MPS needs to scan objects in an area of memory that this scanning function has been registered for, it will be called with a scan state and the limits of the block of objects to scan.  It must then 
    indicate references within the objects by using 
    <code>mps_fix</code>
     or one of the alternatives.
   </p>
   <p>
    The 
    <code>base</code>
     and 
    <code>limit</code>
     arguments are client pointers, as usual.  Note that there might not be any object at the location indicated by 
    <code>limit</code>
    .
   </p>
   <h2>
    <a id='section-example' name='section-example'>Example</a>
   </h2>
   <p>
    <pre>/* Scanner for a simple Scheme-like language with just two interesting types */
mps_res_t scan_objs(mps_ss_t ss, mps_addr_t base, mps_addr_t limit)
{
  mps_res_t res;
mps_addr_t obj;
  MPS_SCAN_BEGIN(ss)
for(obj = base; obj &lt; limit;) { /* obj maps over the objects to scan */
      switch(((Object*)obj)-&gt;type) {
        ArrayType: {
          size_t i;
 Array *array = (Array *)obj;
          for(i = 0; i &lt; array-&gt;length; ++i) { /* fix each element */
            res = MPS_FIX12(ss, &amp;array-&gt;contents[i]);
            if(res != MPS_RES_OK) return res;
          }
          obj = AddrAdd(obj, ArraySize(array)); /* move to next object */
          break;
        }
        StackFrameType: {
          StackFrame *frame = (StackFrame *)obj;
          for(i = frame-&gt;size; i &gt; 0; --i) { /* fix each local var */
            res = MPS_FIX12(ss, &amp;frame-&gt;locals[i]);
            if(res != MPS_RES_OK) return res;
          }
          res = MPS_FIX12(ss, &amp;frame-&gt;next);
          if(res != MPS_RES_OK) return res;
          obj = AddrAdd(obj, StackFrameSize(frame));
          break;
        }
        default: /* other types don't contain references */
          obj = AddrAdd(obj, DefaultSize(obj));
          break;
      }
    }
  MPS_SCAN_END(ss);
  return res;
}</pre>
   </p>
   <h2>
    <a id='section-error-handling' name='section-error-handling'>Error Handling</a>
   </h2>
   <p>
    If 
    a fixing operation returns a value other than 
    <code>MPS_RES_OK</code>
    , the scanning function must return that value, and may return without scanning further references.  Generally, it is better if it returns as soon as possible.  If the scanning is completed successfully, the function should return 
    <code>MPS_RES_OK</code>
    .
   </p>
   <h2>
    <a id='section-see-also' name='section-see-also'>See Also</a>
   </h2>
   <p>
    mps_fmt_A_s, 
    mps_fmt_B_s, 
    mps_fmt_auto_header_s, 
    mps_root_create_fmt, mps_fix, MPS_FIX12
    , MPS_FIX1, MPS_FIX2, MPS_FIX_CALL
    , MPS_SCAN_BEGIN, MPS_SCAN_END
   </p>
   <h2>
    <a id='section-A' name='section-A'>A. References</a>
   </h2>
   <h2>
    <a id='section-B' name='section-B'>B. Document History</a>
   </h2>
   <table>
    <tr valign='top'>
     <td>1998-01-26 18:59:32 +00</td>
     <td>pekka</td>
     <td>New document saved</td>
    </tr>
    <tr valign='top'>
     <td>1998-05-20 19:35:26 +01</td>
     <td>pekka</td>
     <td>improve wording</td>
    </tr>
    <tr valign='top'>
     <td>2000-05-22 16:42:23 +01</td>
     <td>pekka</td>
     <td>fix title</td>
    </tr>
    <tr valign='top'>
     <td>2000-06-06 15:46:25 +01</td>
     <td>pekka</td>
     <td>MPS_FIX12</td>
    </tr>
    <tr valign='top'>
     <td>2000-07-19 20:16:00 +01</td>
     <td>pekka</td>
     <td>headers; improve error handling</td>
    </tr>
    <tr valign='top'>
     <td>2000-07-19 20:17:44 +01</td>
     <td>pekka</td>
     <td>more precise</td>
    </tr>
    <tr valign='top'>
     <td>2001-09-26</td>
     <td>
      <a href='mailto:ndl@ravenbrook.com'>NDL</a>
     </td>
     <td>Converted from xml to html (second pass).</td>
    </tr>
   </table>
   <hr />
   <p>
    <small>Copyright &copy; 2001 Ravenbrook Limited.  This document is provided "as is", without any express or implied warranty.  In no event will the authors be held liable for any damages arising from the use of this document.  You may not duplicate or reproduce this document in any form without the express permission of the copyright holder.</small>
   </p>
   <div align='center'>
    <p>
     <code>$Id$</code>
    </p>
   </div>
  </body>
 </html>
