<?xml version="1.0" encoding="UTF-8"?>



<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">



 <html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>

  <head>

   <title>Stack Allocation using the MPS</title>

  </head>

  <body bgcolor='#FFFFFF' text='#000000' link='#000099' vlink='#660066' alink='#FF0000'>

   <div align='center'>

    <h1>Stack Allocation using the MPS</h1>

    <p>incomplete</p>

    <address>drj, 1998-10-23</address>

   </div>

   <h2>

    <a id='section-introduction' name='section-introduction'>Introduction</a>

   </h2>

   <p>

    <strong>.intro</strong>

    : This document describes how to perform stack allocation using the MPS and what the options are.

   </p>

   <p>

    <strong>.readership</strong>

    : Readership: Any MPS user.

   </p>

   <h2>

    <a id='section-overview' name='section-overview'>Overview</a>

   </h2>

   <p>

    <strong>.overview</strong>

    : The MPS provides a means by which clients can declare that objects can be efficiently managed using stack-allocation (the stack protocol on APs, see protocol.mps.alloc-point.stack); the MPS also provides policies (pool classes) which when used with such declarations will manage objects as efficiently (or very nearly so) as stack allocation; the MPS also provides policies which honour the declarations but do not take advantage of them to manage the objects any more efficiently.  The MPS does not preclude the client from using the usual control or thread stacks for stack allocating objects.

   </p>

   <p>

    <strong>.options</strong>

    : So if the client wishes to use stack allocation they have three options:

   </p>

   <p>

    <strong>.option.client</strong>

    : Clients can stack allocate objects themselves, perhaps using the control stack.

   </p>

   <p>

    <strong>.option.mps.fit</strong>

    : Clients can specify that the objects be managed using a pool which is designed to be used for efficient stack allocation.

   </p>

   <p>

    <strong>.option.mps.nofit</strong>

    : Clients can specify that the objects be managed using a pool which is not designed to be used for efficient stack allocation.

   </p>

   <p>

    <strong>.option.mps.notfit.why</strong>

    : The reasons for providing pool classes which are not designed to be used for efficient stack allocation are:

   </p>

   <p>

    <strong>.option.mps.notfit.why.debug</strong>

    : We can provide pool classes which debug the client's use of the protocol to ensure that the client isn't cheating and help them find out how if they are.

   </p>

   <p>

    <strong>.option.mps.notfit.why.interchange</strong>

    : The interchangeability of pool classes is increased.  The client can mix and match pool classes to see which gives the best overall performance or use a substitute pool class to work around problems in another.

   </p>

   <h2>

    <a id='section-stack-allocation' name='section-stack-allocation'>Stack Allocation</a>

   </h2>

   <p>

    <strong>.broad</strong>

    : 

    Clients wanting to use the MPS for stack allocation will need to do the following:

   </p>

   <p>- Select a pool class to use.</p>

   <p>- instantiate a pool, APs, object formats, and so on.</p>

   <p>

    - allocate objects in the pool according to the stack protocol (see p

    rotocol.mps.alloc-point.stack).

   </p>

   <p>

    <strong>.select.issues</strong>

    : 

    The issues involved in selecting the pool are:

   </p>

   <p>- can the allocation point stack protocol be used with the class?</p>

   <p>- are the objects managed efficiently.</p>

   <p>Currently all pool classes which provided allocation via allocation points understand the allocation point stack protocol.  However, only Pool Class SNC will manage objects allocated using the stack protocol in a particuarly efficient way; the other pool classes essentially ignore the stack protocol - it will not affect they way they manage objects.</p>

   <h2>

    <a id='section-example' name='section-example'>Example</a>

   </h2>

   <p>Using Pool Class SNC would be something like this:</p>

   <p>

    <pre>/* Having create an arena, threads, roots, etc. */

/* Instantiate a pool and an AP. */

res = dylan_fmt(&amp;format, arena);

if(res != MPS_RES_OK) abort();

res = mps_pool_create(&amp;pool, arena, mps_class_snc(), format); /* Note mps_class_snc takes one extra argument which is a format */

if(res != MPS_RES_OK) abort();

res = mps_ap_create(&amp;ap, pool, mps_rank_exact());

if(res != MPS_RES_OK) abort();

/* ... */

/* calls f in a stack frame so that all f's allocation (in the supplied ap) can be */

/* freed when it returns */

mps_res_t with_stack_extent(mps_ap_t ap, (void *f)(mps_ap_t, void *), void *c)

{

  mps_frame_t frame;

  res = mps_ap_frame_push(&amp;frame, ap);

  if(res != MPS_RES_OK) return res;

  f(ap, c);

  res = mps_ap_frame_pop(ap, frame);

  if(res != MPS_RES_OK) return res;

  return MPS_RES_OK;

}</pre>

   </p>

   <h2>

    <a id='section-A' name='section-A'>A. References</a>

   </h2>

   <h2>

    <a id='section-B' name='section-B'>B. Document History</a>

   </h2>

   <table>

    <tr valign='top'>

     <td>1998-10-23 11:36:03 +00</td>

     <td>drj</td>

     <td>New document saved</td>

    </tr>

    <tr valign='top'>

     <td>1998-10-23 13:18:25 +00</td>

     <td />

     <td>paranoia</td>

    </tr>

    <tr valign='top'>

     <td>1998-10-23 14:14:23 +00</td>

     <td>drj</td>

     <td>filled</td>

    </tr>

    <tr valign='top'>

     <td>2000-05-22 13:18:19 +01</td>

     <td>pekka</td>

     <td>Change tag from guide.mps.stack-alloc</td>

    </tr>

    <tr valign='top'>

     <td>2001-09-26</td>

     <td>

      <a href='mailto:ndl@ravenbrook.com'>NDL</a>

     </td>

     <td>Converted from xml to html (second pass).</td>

    </tr>

   </table>

   <hr />

   <p>

    <small>Copyright &copy; 2001 Ravenbrook Limited.  This document is provided "as is", without any express or implied warranty.  In no event will the authors be held liable for any damages arising from the use of this document.  You may not duplicate or reproduce this document in any form without the express permission of the copyright holder.</small>

   </p>

   <div align='center'>

    <p>

     <code>$Id$</code>

    </p>

   </div>

  </body>

 </html>

