<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>

<title>Diagnostic feedback</title>

</head>

<body bgcolor="#FFFFFF" text="#000000" link="#000099" vlink="#660066" alink="#FF0000">

<div align="center">

<p>
<a href="/">Ravenbrook</a> /
<a href="/project/">Projects</a> /
<a href="/project/mps/">Memory Pool System</a> /
<a href="/project/mps/version/1.110/">Version 1.110 Product Sources</a> /
<a href="/project/mps/version/1.110/design/">Design Documents</a>
</p>

<p><i><a href="/project/mps/">Memory Pool System Project</a></i></p>

<hr />

<h1>Diagnostic feedback</h1>

</div>

<p>
This document contains a <a href="#guide">guide</a> to MPS 
diagnostic feedback, followed by the historical 
<a href="#initial-design">initial design</a>.  
References, History, Copyright and License are 
<a href="#section-A">at the end</a>.
</p>

<p> Readership: any MPS developer.  Not confidential. </p>

<hr />

<h1> <a id="guide">Guide</a> </h1>


<h2> Introduction </h2>

<p>
Diagnostic feedback is information created by the MPS diagnostic 
system for the purpose of helping <strong>MPS programmers</strong> 
and <strong>client-code programmers</strong>.
</p>

<p>
Such a piece of information is called "a diagnostic".
(See also <a href="#parts-of-diagnostic-system">Parts of the 
MPS diagnostic system</a>, below).
</p>

<p>
A diagnostic is not intended to be end-user readable (or visible), 
or machine-parseable.
A diagnostic is not intended to be stable from one release to the 
next: it may be modified or removed at any time.
</p>

<p>
MPS diagnostic feedback code must do these things:
</p>
<ol>
  <li> calculate, store, and propagate data; </li>
  <li> collate, <strong>synthesise</strong>, and format it into a 
       human-useful diagnostic; </li>
  <li> <strong>control</strong> (eg. filter) output of diagnostics; 
       </li>
  <li> use a <strong>channel</strong> to get the diagnostic out. </li>
</ol>

<p>
Note: the knowledge/code/logic for constructing the 
human-useful message is kept <em>inside normal MPS 
source code</em>.  This means it is always in-sync with changes 
to the MPS.  This also means that any external utilities used 
to display the messages do not need to understand, or keep in 
sync with, the details of what's going inside the MPS.
</p>


<h2> How to see some MPS diagnostic output </h2>

<p>
To run the MPS and get diagnostic output from it:
</p>
<ul>
  <li> Use a variety with diagnostics 
       compiled-in. Currently, that means 
       <strong>variety.di</strong>.  See config.h. </li>
  <li> Check that the diagnostics you require are generated, 
       by looking in MPS source for invocations of the appropriate 
       macro (eg. DIAG_SINGLEF()). </li>
  <li> Check that the diagnostics you require will be output, 
       by looking at the diagnostic filter rules in diag.c. </li>
  <li> Run the MPS and client in an environment that supports the 
       channel used (eg. at a command-line if using WriteF). </li>
</ul>


<h3> What is a diagnostic? </h3>

<p> A diagnostic has three parts:</p>
<ul>
  <li> a trigger condition, that causes this diagnostic to be 
       emitted; </li>
  <li> a text tag (eg "TraceStart") which is the name of this 
       diagnostic; and </li>
  <li> a paragraph of human-useful text.</li>
</ul>

<p> A diagnostic is emitted by the MPS at a certain 
point in time when a certain event happens. </p>

<p> Diagnostics are not nested.  Every diagnostic must have a tag. 
Each diagnostic should have a unique tag (uniqueness is just 
to help the humans; the diagnostic system does not care). </p>

<p> The paragraph of text can be many lines long.  It usually
explains what event caused the diagnostic to be emitted, and 
commonly also includes the output of some &lt;object&gt;Describe() 
methods for various relevant objects.  (For example, the TraceStart 
diagnostic might call, and include the output generated by, the 
TraceDescribe() method). </p>


<h3> How do I control (filter) which diagnostics I see? </h3>

<p> All diagnostics are emitted and then filtered according 
to the "diagnostic filter rules".</p>

<p> The first level of control is filtering by tag.  (For example, 
only show TraceStart diagnostics). </p>

<p> The second level of control is filtering by paragraph content.  
(For example, only show TraceStart diagnostics where the trace is 
started because a nursery generation is full).</p>

<p> The third level of control is filtering by line content.  
(For example, only show lines containing the word "whiteSet").</p>

<p> See diag.c for details.</p>

<p>Note: the entire filtering mechanism can be turned 
off, so that diagnostics go immediately to mps_lib_stdout, 
with no buffering or filtering  See diag.c#.filter-disable.</p>



<h2> How to write a diagnostic </h2>


<h3> Improve stateless Describe methods where possible </h3>

<p> Where possible, don't put clever code into an event-triggered 
diagnostic: put it into a stateless &lt;object&gt;Describe() 
method instead, and then call that method when emitting your diagnostic.</p>

<p> For example: </p>
<blockquote><pre><code>FooDescribe(Foo foo, mps_lib_FILE *stream)
{
  /* show value of new "quux" field */
  WriteF(stream, "Foo: $P { quux: $U }\n", foo, foo->quux);
}

FooWibble(Foo foo)
{
  ...
  DIAG_FIRSTF(( "FooWibble", "Wibbling foo $P", foo, NULL));
  DIAG( FooDescribe(foo, DIAG_STREAM); );
  DIAG_END("FooWibble");
  ...
}  
</code></pre></blockquote>

<p> This is much better, because other people can use your 
human-useful output in their diagnostics, or 'live' in a 
debugger. </p>


<h3> How to use DIAG_*F output macros </h3>

<p> For a simple diagnostic, use DIAG_SINGLEF.  This begins the tag, 
puts text into the paragraph, and ends the tag immediately.</p>

<p> For a more complex diagnostic, the first call must be DIAG_FIRSTF, 
which begins a diag tag. </p>

<p> While a tag is current, you can add text to the diagnostic's 
paragraph using DIAG_MOREF, and WriteF( DIAG_STREAM, ... ).</p>

<p> (Note: DIAG_STREAM is not a real standard C library 
stream.  If you want stream-level access, you may use Stream_fputc() 
and Stream_fputs().) </p>

<p> End the tag by calling DIAG_END.</p>


<h3> Compile away in non-diag varieties; no side effects </h3>

<p> Wrap non-output code with the DIAG() and DIAG_DECL() macros, to 
make sure that non-diag varieties do not execute 
diagnostic-generating code.</p>

<p> For complex diagnostic-generating code, it may be cleaner to move 
it into a separate local function.  Put "_diag" on the end of the 
function name (eg. "TraceStart_diag()").</p>

<p> Obviously, diagnostic-generating code must have no side effects.
</p>


<h3> Choosing tags </h3>

<p> Tags should be valid C identifiers.  Unless you know of a good 
reason why not.  (Not currently checked).</p>

<p> There's no formal scheme for tag naming, but make it helpful and  
&mdash; informally &mdash; hierarchical, eg. TraceBegin, 
TraceStart, TraceEnd, etc. (not BeginTrace, EndTrace, ...).</p>


<h3> Writing good paragraph text </h3>

<p> IMPORTANT: Make your diagnostics easy to understand!  
<strong>Other people</strong> will read your diagnostics!  
Make them clear and helpful.
Do not make them terse and cryptic.  
If you use symbols, print a key in the diagnostic.  (If you don't 
want to see this the screen clutter, then you can always add a 
filter rule to your personal rule set to filter it out).</p>


<h3> Maintaining helpful filter rules </h3>

<p> If you add a 'noisy' diagnostic, add a rule to the default 
ruleset to turn it off.</p>


<h2> How the MPS diagnostic system works </h2>


<h3> Channels </h3>

<p>The recommended channel is WriteF to stdout.</p>

<p>
Other possible of future channels might be:
</p>
<ul>
  <li> printf; </li>
  <li> a new type (yet to be defined) of mps_message; </li>
  <li> squirt them into the telemetry-log-events system; </li>
  <li> telnet. </li>
</ul> 

<p>
Currently, only printf and WriteF are supported.  
See the DIAG_WITH_ macros in mpm.h.
</p>

<p>
You can also use a debugger to call &lt;type&gt;Describe() methods 
directly, from within the debugger.
</p>

<p>
Note: it is unfortunate that choice of channel may (for some 
channels) also dictate the form of the code that synthesises the 
message.  (For example, WriteF-style parameter-expansion is not 
possible when using the printf channel, because there is no way 
to get WriteF to produce its output into a string).  This is just 
a technical hitch; logically, the code that synthesises a 
diagnostic message should not care which channel will be used to 
transmit it out of the MPS.
</p>


<h3 id="parts-of-diagnostic-system"> Parts of the MPS diagnostic 
system </h3>

<p>
The following facilities are considered part of the MPS diagnostic 
system:
</p>
<ul>
  <li> the &lt;type&gt;Describe() methods. </li>
  <li> the DIAG* macros (DIAG, DIAG_DECL, DIAG_*F, etc); 
       </li>
  <li> the STATISTIC macros (see mpm.h); </li>
  <li> the METER macros and meter subsystem; </li>
</ul>


<h3 id="related-systems"> Related Systems </h3>

<p>
The MPS diagnostic system is separate from the following other MPS 
systems:
</p>
<ul>
  <li> The <strong>telemetry-log-events system</strong> 
       (which emits much more data, 
       in a less human-readable form, requires MPS-aware external 
       tools, and is more stable from release to release).  
       In non-diagnostic telemetry varieties, the telemetry-log-events 
       system 
       emits events that log all normal MPS actions.  In diagnostic 
       telemetry varieties, it may emit additional events containing 
       diagnostic information.  
       Additionally, the telemetry-log-events stream 
       might in future be available as a channel for emitting 
       human-readable text diagnostics. 
       See also <a href="../design/telemetry/">design/telemetry</a>.
       </li>
  <li> The <strong>MPS message system</strong>
       (which is present in all varieties, and 
       manages asynchronous communication from the MPS to the client 
       program). However, the MPS message system might in future also 
       be available as a channel for emitting diagnostics. 
       See also <a href="../design/message/">design/message</a>.
       </li>
</ul>


<hr />

<h1> <a id="initial-design">Initial Design</a> </h1>


<p>
See <a href="http://info.ravenbrook.com/mail/2007/04/13/13-07-45/0.txt">http://info.ravenbrook.com/mail/2007/04/13/13-07-45/0.txt</a>:
"diagnostic feedback from the MPS" by RHSK.
</p>

<p>
Diverse types of diagnostic feedback: 
<a href="http://info.ravenbrook.com/mail/2007/04/18/10-58-49/0.txt">http://info.ravenbrook.com/mail/2007/04/18/10-58-49/0.txt</a>.
</p>

<p>
RHSK 2007-06-28
</p>
<p>
It must be possible to add, modify, or remove diagnostics to affect 
diagnostic varieties, without a substantial secondary effect 
on non-diagnostic varieties.  It is not a requirement that there 
be zero effect.
</p>

<p>
This means:
</p>
<ul>
  <li> for actual output, you must use appropriate DIAG macros 
       (which compile away to nothing in non-diagnostic varieties); 
       </li>
  <li> for propagating and synthesising data, use appropriate 
       DIAG macros where it is reasonably clean to do so, such as for 
       local variables and statements used only for diagnostic output; 
       </li>
  <li> where it is clearer, and without substantial secondary effect, 
       to include code (such as additional function parameters) in 
       all varieties, that's okay. </li>
</ul>

<p>Note: the MPS diagnostic feedback system was initially developed in 
mps/branch/2007-04-18/diag, mps/branch/2007-07-19/gcdiag, and 
mps/branch/2007-08-07/diagtag.</p>

<hr />


<h2><a id="section-A" name="section-A">A. References</a></h2>

<!-- Template Entry

<table>

<tr valign="top">

  <td>[<a id="ref-#REF#" name="ref-#REF#" href="#REF_URL#">#REF_NAME#</a>]</td>

  <td>
    "#REF_TITLE#";
    #REF_AUTHOR#;
    &lt;URL: <a href="#REF_URL#">#REF_URL#</a>&gt;;
    #REF_DATE#.
  </td>

</tr>

</table>

-->


<h2><a id="section-B" name="section-B">B. Document History</a></h2>

<table>

<tr valign="top">
  <td>2007-06-28</td>
  <td><a href="mailto:rhsk@ravenbrook.com">RHSK</a></td>
  <td>Create.</td>
</tr>

<tr valign="top">
  <td>2007-06-28</td>
  <td><a href="mailto:rhsk@ravenbrook.com">RHSK</a></td>
  <td>Telemetry-log-events system is a possible channel.</td>
</tr>

<tr valign="top">
  <td>2007-06-29</td>
  <td><a href="mailto:rhsk@ravenbrook.com">RHSK</a></td>
  <td>Feedback (not output), each "a diagnostic".  
      Parts of the system; related systems.  Link to initial design 
      email.
  </td>
</tr>

<tr valign="top">
  <td>2007-08-14</td>
  <td><a href="mailto:rhsk@ravenbrook.com">RHSK</a></td>
  <td>(Diag Filtering).  Expand section: How to see some MPS 
      diagnostic output, with what a diagnostic is, and how to 
      filter it.  New section: How to write a diagnostic.
      Various minor updates and corrections.
  </td>
</tr>

</table>


<h2><a id="section-C" name="section-C">C. Copyright and License</a></h2>

<p> This document is copyright &copy; 2007 <a href="http://www.ravenbrook.com/">Ravenbrook Limited</a>.  All rights reserved.  This is an open source license.  Contact Ravenbrook for commercial licensing options. </p>

<p> Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: </p>

<ol>

<li> Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. </li>

<li> Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. </li>

<li> Redistributions in any form must be accompanied by information on how to obtain complete source code for the this software and any accompanying software that uses this software.  The source code must either be included in the distribution or be available for no more than the cost of distribution plus a nominal fee, and must be freely redistributable under reasonable conditions.  For an executable file, complete source code means the source code for all modules it contains. It does not include source code for modules or files that typically accompany the major components of the operating system on which the executable file runs. </li>

</ol>

<p> <strong> This software is provided by the copyright holders and contributors "as is" and any express or implied warranties, including, but not limited to, the implied warranties of merchantability, fitness for a particular purpose, or non-infringement, are disclaimed.  In no event shall the copyright holders and contributors be liable for any direct, indirect, incidental, special, exemplary, or consequential damages (including, but not limited to, procurement of substitute goods or services; loss of use, data, or profits; or business interruption) however caused and on any theory of liability, whether in contract, strict liability, or tort (including negligence or otherwise) arising in any way out of the use of this software, even if advised of the possibility of such damage. </strong> </p>


<hr />

<div align="center">

<p><code>$Id$</code></p>

<p>
<a href="/">Ravenbrook</a> /
<a href="/project/">Projects</a> /
<a href="/project/mps/">Memory Pool System</a> /
<a href="/project/mps/version/1.110/">Version 1.110 Product Sources</a> /
<a href="/project/mps/version/1.110/design/">Design Documents</a>
</p>

</div>

</body>

</html>
